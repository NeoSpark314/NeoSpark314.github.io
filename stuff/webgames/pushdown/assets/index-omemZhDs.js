(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const o=32,M=16,I=17,C=18,Q=7,tt=-2,G=48,et=24,st=8,D=4,v={UNDEFINED:"UNDEFINED",PLAYING:"PLAYING",MAP_COMPLETED:"MAP_COMPLETED"};class ${constructor(t,e){this.x=t,this.y=e,this.moveX=0,this.moveY=0}isMoving(){return this.moveX!==0||this.moveY!==0}update(t){this.moveX>0?(this.moveX-=t,this.moveX<0&&(this.moveX=0)):this.moveX<0&&(this.moveX+=t,this.moveX>0&&(this.moveX=0)),this.moveY>0?(this.moveY-=t,this.moveY<0&&(this.moveY=0)):this.moveY<0&&(this.moveY+=t,this.moveY>0&&(this.moveY=0))}}class it extends ${constructor(t,e){super(t,e),this.bitmapDirIdx=0,this.eyeBlinkIdx=0,this.eyeBlinkCtr=50,this.updownDelta=0,this.updown=0,this.timer0=0}update(t){super.update(t),this.eyeBlinkCtr--,this.eyeBlinkCtr<=0&&(this.eyeBlinkIdx===0?(this.eyeBlinkIdx=1,this.eyeBlinkCtr=8+Math.random()*8):(this.eyeBlinkIdx=0,this.eyeBlinkCtr=Math.random()*100+60)),this.timer0=(this.timer0+1)%4,this.timer0===0&&(this.updown===0?(this.updownDelta--,this.updownDelta<=-8&&(this.updown=1)):(this.updownDelta++,this.updownDelta>=0&&(this.updown=0)))}}class nt extends ${constructor(t,e){super(0,0),this.id=t,this.tileID=e,this.blocks=[],this.state=0}setOrigin(t,e){this.x=t,this.y=e}addBlock(t,e){this.blocks.push({dx:t-this.x,dy:e-this.y})}}class at{constructor(t,e,s){this.x=t,this.y=e,this.id=s,this.collected=!1,this.anim=s*3%8,this.count=0}update(){this.count++,this.count>2&&(this.count=0,this.anim=(this.anim+1)%8)}}class ot{constructor(){this.sizeX=0,this.sizeY=0,this.layer0=[],this.layer1=[],this.obstacles=[],this.collectables=[],this.player=null,this.stairLocationIndex=-1,this.numTargetSteps=0,this.gIdCounter=8}async load(t){const e=Math.floor(t/7),s=t%7,i=`/maps/${e.toString().padStart(2,"0")}_${s}.map.bmap`;try{const c=await(await fetch(i)).arrayBuffer(),a=new DataView(c);let r=0;this.sizeX=a.getUint8(r++),this.sizeY=a.getUint8(r++);const h=this.sizeX*this.sizeY;this.layer0=new Int32Array(h),this.layer1=new Int32Array(h),this.stairLocationIndex=-1,this.collectables=[],this.obstacles=[],this.gIdCounter=8;let g=0;const d=new Int8Array(h);for(let l=0;l<h;l++)this.layer0[l]=a.getInt8(r++),d[l]=a.getInt8(r++),this.layer0[l]===I&&(this.layer0[l]=C,this.stairLocationIndex=l),d[l]===tt&&(this.player=new it(l%this.sizeX,Math.floor(l/this.sizeX)),d[l]=-1),d[l]>=G&&g++;this.numTargetSteps=a.getInt32(r),r+=4;for(let l=0;l<st;l++){let f=0;const x=l+et;for(let y=0;y<h;y++)d[y]===x&&f++;if(f>0){const y=new nt(-this.gIdCounter++,x);let L=!1;for(let E=0;E<h;E++)if(d[E]===x){const S=E%this.sizeX,m=Math.floor(E/this.sizeX);L||(y.setOrigin(S,m),L=!0),y.addBlock(S,m),d[E]=-1}this.obstacles.push(y)}}for(let l=0;l<h;l++)if(d[l]>=G){const f=new at(l%this.sizeX,Math.floor(l/this.sizeX),-this.gIdCounter++);this.collectables.push(f),d[l]=-1}this.layer1.set(d);for(const l of this.obstacles)for(const f of l.blocks){const x=l.x+f.dx,y=l.y+f.dy;this.layer1[x+y*this.sizeX]=l.id}return this.stairLocationIndex<0?this.stairLocationIndex=this.player.x+this.player.y*this.sizeX:this.collectables.length===0&&(this.layer0[this.stairLocationIndex]=I),!0}catch(n){return console.error("Error loading map:",n),!1}}getTileAt(t,e,s=0){return t<0||t>=this.sizeX||e<0||e>=this.sizeY?-1:s===0?this.layer0[t+e*this.sizeX]:this.layer1[t+e*this.sizeX]}}class rt{constructor(t){this.ctx=t.getContext("2d"),this.canvas=t,this.tileset=new Image,this.tilesetLoaded=!1,this.cameraX=0,this.cameraY=0}async init(){return new Promise(t=>{this.tileset.onload=()=>{this.tilesetLoaded=!0,t()},this.tileset.src="/assets/tileset_32.png"})}resize(t,e){this.canvas.width=t,this.canvas.height=e}updateCamera(t,e,s,i){const n=t.x*o+t.moveX,c=t.y*o+t.moveY;this.cameraX=-n+s/2-o/2,this.cameraY=-c+i/2-o/2;const a=s-e.sizeX*o,r=i-e.sizeY*o;s>=e.sizeX*o?this.cameraX=(s-e.sizeX*o)/2:(this.cameraX>0&&(this.cameraX=0),this.cameraX<a&&(this.cameraX=a)),i>=e.sizeY*o?this.cameraY=(i-e.sizeY*o)/2:(this.cameraY>0&&(this.cameraY=0),this.cameraY<r&&(this.cameraY=r))}drawTile(t,e,s,i=null,n=-o/2,c=1){if(t<0)return;const a=o+o/2,r=t%8*o,h=(i!==null?i:Math.floor(t/8))*a,g=this.ctx.globalAlpha;this.ctx.globalAlpha=c,this.ctx.drawImage(this.tileset,r,h,o,a,e,s+n,o,a),this.ctx.globalAlpha=g}render(t,e){if(!this.tilesetLoaded)return;this.ctx.fillStyle="#124056",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.cameraX,this.cameraY);const s=e.alpha!==void 0?e.alpha:1,i=[];for(const n of t.collectables)n.collected||i.push({type:"key",x:n.x,y:n.y,anim:n.anim});for(const n of t.obstacles)if(n.state!==2)for(const c of n.blocks)i.push({type:"obstacle",x:n.x+c.dx,y:n.y+c.dy,tileID:n.tileID,moveX:n.moveX,moveY:n.moveY});for(let n=0;n<t.sizeY;n++){for(let a=0;a<t.sizeX;a++){const r=t.layer0[a+n*t.sizeX];r>=0&&this.drawTile(r,a*o,n*o,null,0)}for(let a=0;a<t.sizeX;a++){const r=t.getTileAt(a,n,1);r>=0&&this.drawTile(r,a*o,n*o,null,-o/2)}const c=i.filter(a=>Math.round(a.y)===n);for(const a of c)a.type==="key"?this.drawTile(a.anim,a.x*o,a.y*o,6,-o/2):a.type==="obstacle"&&this.drawTile(a.tileID,a.x*o+a.moveX,a.y*o+a.moveY,null,-o/2);if(Math.round(e.y)===n){const a=e.x*o+e.moveX,r=e.y*o+e.moveY+e.updownDelta;this.drawTile(e.bitmapDirIdx,a,r,5,-o/2,s),e.eyeBlinkIdx===0&&this.drawTile(e.bitmapDirIdx+4,a,r,5,-o/2,s)}}this.ctx.restore()}renderMenuBackground(t){if(!this.tilesetLoaded||!t)return;this.ctx.fillStyle="#124056",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const e=this.canvas.width/2,s=this.canvas.height/2,i=Math.min(this.canvas.width*.9,500),n=Math.min(this.canvas.height*.8,550);this.ctx.fillStyle="rgba(0, 0, 0, 0.9)",this.ctx.beginPath(),this.ctx.roundRect(e-i/2,s-n/2,i,n,20),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.save(),this.ctx.imageSmoothingEnabled=!1;const a=8*Math.min(this.canvas.width/800,this.canvas.height/600,1),r=o*a,h=o+o/2,g=h*a,d=e-r/2-40,l=s-g/2,f=t.bitmapDirIdx%8*o,x=5*h;if(this.ctx.drawImage(this.tileset,f,x,o,h,d,l+t.updownDelta*a,r,g),t.eyeBlinkIdx===0){const y=(t.bitmapDirIdx+4)%8*o,L=5*h;this.ctx.drawImage(this.tileset,y,L,o,h,d,l+t.updownDelta*a,r,g)}this.ctx.restore()}}class lt{constructor(t,e,s,i){this.canvas=t,this.map=e,this.renderer=s,this.audio=i,this.gameState=v.UNDEFINED,this.steps=0,this.keysCollected=0,this.totalKeys=0,this.undoStack=[]}start(){this.gameState=v.PLAYING,this.steps=0,this.totalKeys=this.map.collectables.length,this.keysCollected=this.map.collectables.filter(t=>t.collected).length}pushUndo(){const t={player:{x:this.map.player.x,y:this.map.player.y},obstacles:this.map.obstacles.map(e=>({x:e.x,y:e.y,state:e.state})),collectables:this.map.collectables.map(e=>({collected:e.collected})),layer0:[...this.map.layer0],layer1:[...this.map.layer1],steps:this.steps,keysCollected:this.keysCollected};this.undoStack.push(JSON.stringify(t))}undo(){if(this.undoStack.length===0)return;const t=JSON.parse(this.undoStack.pop());this.map.player.x=t.player.x,this.map.player.y=t.player.y,this.map.player.moveX=0,this.map.player.moveY=0,t.obstacles.forEach((e,s)=>{this.map.obstacles[s].x=e.x,this.map.obstacles[s].y=e.y,this.map.obstacles[s].state=e.state,this.map.obstacles[s].moveX=0,this.map.obstacles[s].moveY=0}),t.collectables.forEach((e,s)=>{this.map.collectables[s].collected=e.collected}),this.map.layer0.set(t.layer0),this.map.layer1.set(t.layer1),this.steps=t.steps,this.keysCollected=t.keysCollected}canPlayerMove(t,e){const s=this.map.player.x+t,i=this.map.player.y+e,n=this.map.getTileAt(s,i,0),c=this.map.getTileAt(s,i,1);if(n===-1||n===M||c>=0||n>=8&&n!==I&&n!==C)return!1;if(c<-1){const a=this.map.obstacles.find(r=>r.id===c);if(a&&a.state===0)return this.canObstacleMove(a,t,e)?(this.pushUndo(),this.moveObstacle(a,t,e),!0):!1}return this.pushUndo(),!0}canObstacleMove(t,e,s){for(const i of t.blocks){const n=t.x+i.dx+e,c=t.y+i.dy+s,a=this.map.getTileAt(n,c,1);if(a!==-1&&a!==t.id)return!1;const r=this.map.getTileAt(n,c,0);if(r===-1||r>=8&&r!==I&&r!==C&&r!==M)return!1}return!0}moveObstacle(t,e,s){for(const i of t.blocks)this.map.layer1[t.x+i.dx+(t.y+i.dy)*this.map.sizeX]=-1;t.x+=e,t.y+=s,t.moveX=-e*o,t.moveY=-s*o;for(const i of t.blocks)this.map.layer1[t.x+i.dx+(t.y+i.dy)*this.map.sizeX]=t.id;this.audio&&this.audio.play("push")}handleInput(t){if(this.gameState!==v.PLAYING||this.map.player.isMoving())return;let e=0,s=0;t==="ArrowUp"||t==="w"?(s=-1,this.map.player.bitmapDirIdx=3):t==="ArrowDown"||t==="s"?(s=1,this.map.player.bitmapDirIdx=1):t==="ArrowLeft"||t==="a"?(e=-1,this.map.player.bitmapDirIdx=2):(t==="ArrowRight"||t==="d")&&(e=1,this.map.player.bitmapDirIdx=0),(e!==0||s!==0)&&this.canPlayerMove(e,s)&&(this.map.player.x+=e,this.map.player.y+=s,this.map.player.moveX=-e*o,this.map.player.moveY=-s*o,this.steps++,this.checkWinCondition())}checkWinCondition(){for(const t of this.map.collectables)!t.collected&&t.x===this.map.player.x&&t.y===this.map.player.y&&(t.collected=!0,this.keysCollected++,this.audio&&this.audio.play("key"),this.keysCollected===this.totalKeys&&(this.map.layer0[this.map.stairLocationIndex]=I,this.audio&&this.audio.play("creak")));this.map.getTileAt(this.map.player.x,this.map.player.y,0)===I&&this.gameState===v.PLAYING&&(this.gameState=v.MAP_COMPLETED,this.audio&&this.audio.play("stairs"),console.log("Map Completed Animation Start!"),this.map.player.alpha=1)}update(){if(this.map.player&&(this.map.player.update(D),this.gameState===v.MAP_COMPLETED?(this.map.player.alpha===void 0&&(this.map.player.alpha=1),this.map.player.alpha-=.02,this.map.player.alpha<0&&(this.map.player.alpha=0)):this.map.player.alpha=1),this.gameState!==v.UNDEFINED){for(const t of this.map.obstacles)if(t.state===0){if(t.update(D),!t.isMoving()){let e=!0;for(const s of t.blocks){const i=t.x+s.dx,n=t.y+s.dy;this.map.getTileAt(i,n,0)!==M&&(e=!1)}e&&(t.state=1,t.moveY=0)}}else if(t.state===1){t.moveY+=D;const e=o/2;if(t.moveY>=e){t.moveY=e,t.state=2;for(const s of t.blocks){const i=t.x+s.dx+(t.y+s.dy)*this.map.sizeX;this.map.layer0[i]=Q,this.map.layer1[i]=-1}this.audio&&this.audio.play("drop")}}for(const t of this.map.collectables)t.update();this.renderer.updateCamera(this.map.player,this.map,this.canvas.width,this.canvas.height)}}loop(){this.update(),this.gameState===v.PLAYING||this.gameState===v.MAP_COMPLETED?this.renderer.render(this.map,this.map.player):this.renderer.renderMenuBackground(this.map.player),requestAnimationFrame(()=>this.loop())}}class ct{constructor(){this.STORAGE_KEY="ghost_block_puzzle_progress",this.progress=this.load()}load(){const t=localStorage.getItem(this.STORAGE_KEY);if(t)try{return JSON.parse(t)}catch(e){return console.error("Failed to parse progress:",e),{}}return{}}save(){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.progress))}saveProgress(t,e,s){const i=s>0?s/e:1,n=this.calculateStars(i);(!this.progress[t]||this.progress[t].stars<n||this.progress[t].steps>e)&&(this.progress[t]={completed:!0,steps:e,stars:n},this.save())}calculateStars(t){return t>=1?3:t>=.8?2:t>=.6?1:0}isUnlocked(t){return t===0?!0:!!this.progress[t-1]?.completed}getStars(t){return this.progress[t]?.stars||0}hasAnyProgress(){return Object.keys(this.progress).length>0}getLatestUnlockedLevel(){let t=0;for(let e=0;e<63&&this.isUnlocked(e);e++)t=e;return t}}class ht{constructor(t,e,s){this.container=t,this.progressManager=e,this.onSelect=s,this.TOTAL_LEVELS=63}render(){this.container.innerHTML="";const t=document.createElement("div");t.className="level-grid";for(let e=0;e<this.TOTAL_LEVELS;e++){const s=document.createElement("div"),i=this.progressManager.isUnlocked(e),n=this.progressManager.getStars(e),c=Math.floor(e/7)+1,a=e%7+1;s.className=`level-btn ${i?"":"locked"}`,s.innerHTML=`
                <span class="level-num">${c}-${a}</span>
                <div class="stars">
                    ${this.renderStars(n)}
                </div>
            `,i&&s.addEventListener("click",()=>{this.onSelect(e)}),t.appendChild(s)}this.container.appendChild(t)}renderStars(t){let e="";for(let s=1;s<=3;s++)e+=`<span class="star ${s<=t?"active":""}">â˜…</span>`;return e}show(){this.container.parentElement.parentElement.classList.remove("hidden"),this.render()}hide(){this.container.parentElement.parentElement.classList.add("hidden")}updateDisplay(){this.container.innerHTML="",this.render()}}class dt{constructor(t,e){this.element=t,this.onInput=e,this.startX=0,this.startY=0,this.threshold=30,this.init()}init(){this.element.addEventListener("pointerdown",t=>this.handlePointerDown(t)),this.element.addEventListener("pointerup",t=>this.handlePointerUp(t)),this.element.style?this.element.style.touchAction="none":(this.element===window||this.element===document)&&(document.body.style.touchAction="none")}handlePointerDown(t){t.target.closest("button")||(this.startX=t.clientX,this.startY=t.clientY)}handlePointerUp(t){if(this.startX===0&&this.startY===0)return;const e=t.clientX-this.startX,s=t.clientY-this.startY,i=Math.abs(e),n=Math.abs(s);Math.max(i,n)>this.threshold&&(i>n?e>0?this.onInput("ArrowRight"):this.onInput("ArrowLeft"):s>0?this.onInput("ArrowDown"):this.onInput("ArrowUp")),this.startX=0,this.startY=0}}class mt{constructor(){this.sounds={},this.enabled=!0,this.soundPaths={push:"/assets/sounds/push.ogg",drop:"/assets/sounds/drop.ogg",key:"/assets/sounds/key.ogg",stairs:"/assets/sounds/stairs.ogg",creak:"/assets/sounds/creak.ogg"}}async init(){const t=Object.entries(this.soundPaths).map(([e,s])=>new Promise(i=>{const n=new Audio(s);n.addEventListener("canplaythrough",()=>{this.sounds[e]=n,i()},{once:!0}),n.addEventListener("error",()=>{console.warn(`Failed to load sound: ${s}`),i()},{once:!0})}));await Promise.all(t)}play(t){if(!this.enabled||!this.sounds[t])return;const e=this.sounds[t];e.currentTime=0,e.play().catch(s=>console.warn("Audio play failed:",s))}toggle(t){this.enabled=t}}async function ut(){const p=document.getElementById("game-canvas"),t=new ot,e=new rt(p),s=new mt,i=new lt(p,t,e,s),n=new ct;await e.init(),await s.init(),i.loop();function c(){e.resize(window.innerWidth,window.innerHeight)}window.addEventListener("resize",c),window.addEventListener("orientationchange",()=>{setTimeout(c,100)}),c(),new dt(window,u=>{i.handleInput(u)}),window.addEventListener("keydown",u=>{i.handleInput(u.key),u.key==="r"&&i.undo()});const a=document.getElementById("start-btn"),r=document.getElementById("menu-overlay"),h=document.getElementById("open-level-select-btn"),g=document.getElementById("level-select-overlay"),d=document.getElementById("close-level-select-btn"),l=document.getElementById("level-grid-container"),f=document.getElementById("game-ui"),x=document.getElementById("level-name"),y=document.getElementById("steps-count"),L=document.getElementById("undo-btn"),E=document.getElementById("reset-btn"),S=document.getElementById("exit-btn");let m=0;const O=new ht(l,n,u=>{m=u,b(m),g.classList.add("hidden")}),A=document.getElementById("win-overlay"),K=document.getElementById("win-stats"),H=document.querySelectorAll(".star-large"),X=document.getElementById("next-level-btn"),V=document.getElementById("replay-btn"),J=document.getElementById("win-exit-btn");function Y(){k=!1,w&&(clearTimeout(w),w=null),i.gameState=v.UNDEFINED}async function b(u){Y(),await t.load(u)&&(i.start(),r.classList.add("hidden"),g.classList.add("hidden"),A.classList.add("hidden"),f.classList.remove("hidden"),x.textContent=`Level ${Math.floor(u/7)+1} - ${u%7+1}`)}function q(){f.classList.add("hidden"),A.classList.remove("hidden"),K.textContent=`Steps: ${i.steps}`;const u=n.calculateStars(i.steps,t.numTargetSteps);H.forEach((B,Z)=>{Z<u?B.classList.add("active"):B.classList.remove("active")}),m>=62?X.classList.add("hidden"):X.classList.remove("hidden")}X.addEventListener("click",()=>{m++,b(m)}),V.addEventListener("click",()=>{b(m)}),J.addEventListener("click",()=>{Y(),A.classList.add("hidden"),r.classList.remove("hidden"),P()});function P(){n.hasAnyProgress()?(a.textContent="Continue",m=n.getLatestUnlockedLevel()):(a.textContent="Start Game",m=0),O.updateDisplay()}function z(){P()}a.addEventListener("click",()=>{b(m)}),h.addEventListener("click",()=>{O.show()}),d.addEventListener("click",()=>{g.classList.add("hidden")}),L.addEventListener("click",()=>{i.undo()}),E.addEventListener("click",()=>{b(m)}),S.addEventListener("click",()=>{Y(),f.classList.add("hidden"),r.classList.remove("hidden"),z()});let k=!1,w=null;function _(){y.textContent=`Steps: ${i.steps}`,i.gameState===v.MAP_COMPLETED&&!k&&(k=!0,console.log("Stage Completed, saving progress..."),n.saveProgress(m,i.steps,t.numTargetSteps),w=setTimeout(()=>{q(),k=!1,w=null},1500)),requestAnimationFrame(_)}_(),z(),await t.load(m);const W=document.getElementById("info-btn"),N=document.getElementById("sound-btn"),U=document.getElementById("sound-btn-in-game"),R=document.getElementById("info-overlay"),j=document.getElementById("close-info-btn");let T=!0;function F(){T=!T;const u=T?"ðŸ”Š":"ðŸ”‡";N.textContent=u,U.textContent=u,s.toggle(T)}W.addEventListener("click",()=>{R.classList.remove("hidden")}),j.addEventListener("click",()=>{R.classList.add("hidden")}),N.addEventListener("click",F),U.addEventListener("click",F),r.classList.remove("hidden")}ut();
