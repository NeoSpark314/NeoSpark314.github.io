const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-le3Kxczb.js","./peerjs-D_BJpyng.js","./rapier-CKC5f6tm.js","./three-Cfp_b2uh.js"])))=>i.map(i=>d[i]);
var oi=Object.defineProperty;var ri=(d,e,t)=>e in d?oi(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var gt=(d,e,t)=>ri(d,typeof e!="symbol"?e+"":e,t);import{$ as Ge}from"./peerjs-D_BJpyng.js";import{b as A}from"./rapier-CKC5f6tm.js";import{C as D,V as x,Q as C,B as j,M as G,a as R,S as ai,G as z,P as Ft,A as hi,W as li,R as Ut,E as le,b as me,L as J,c as fe,d as Le,e as Vt,f as B,D as Se,g as Te,h as Z,i as be,j as ci,k as yt,l as ne,m as te,n as oe,o as Je,p as H,q as Gt,r as qe,s as rt,O as at,t as di,F as ui,u as pi,v as ie,w as Kt,x as ht,y as $e,z as fi,H as mi,I as jt,J as gi,K as lt,T as yi,N as Ze,U as Qt,X as wi,Y as De,Z as Wt,_ as se,$ as Yt,a0 as re,a1 as ge,a2 as xi,a3 as Si,a4 as Ti,a5 as bi,a6 as vi,a7 as Ei,a8 as Mi,a9 as Xt,aa as Ri,ab as Pi,ac as Ai,ad as Jt,ae as et,af as Ii,ag as Ci,ah as Ke,ai as _i,aj as Li,ak as Di,al as ki,am as Ni,an as Oi,ao as $t,ap as Hi,aq as wt,ar as xt,as as St,at as Tt,au as bt,av as Bi,aw as zi,ax as qi,ay as Fi,az as Ui,aA as Vi,aB as Gi,aC as Ki}from"./three-Cfp_b2uh.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class ji{isHost=!1;isDedicatedHost=!1;isLocalServer=!1;roomId=null;playerName="Player";avatarConfig={color:"#00ffff"};voiceEnabled=!1;voiceAutoEnable=!0;roomConfig={environment:"cyber-stube",skyColor:"#0b0c10",fogNear:5,fogFar:1e3,seed:Math.floor(Math.random()*2147483647)};localPlayer=null;isMenuOpen=!1;_managers={};get managers(){return this._managers}setManager(e,t){this._managers[e]=t}deltaTime=0}class Qi{constructor(e){this.context=e}isRunning=!1;lastTime=performance.now();updateSystems=[];endFrameCallbacks=[];addSystem(e){this.updateSystems.push(e)}onEndFrame(e){this.endFrameCallbacks.push(e)}async initialize(){console.log("[GameEngine] Initializing...")}start(){if(!this.isRunning)if(this.isRunning=!0,this.lastTime=performance.now(),console.log("[GameEngine] Engine started."),this.context.managers.render)this.context.managers.render.setAnimationLoop((e,t)=>this.loop(e,t));else if(typeof requestAnimationFrame<"u"){const e=t=>{this.loop(t),this.isRunning&&requestAnimationFrame(e)};requestAnimationFrame(e)}else{const t=setInterval(()=>{if(!this.isRunning){clearInterval(t);return}this.loop(performance.now())},16.666666666666668)}}stop(){this.isRunning=!1}loop(e,t){if(!this.isRunning)return;const i=(e-this.lastTime)/1e3;this.lastTime=e,this.context.deltaTime=i,this.update(i,t)}update(e,t){for(const i of this.updateSystems)i.update(e,t);for(const i of this.endFrameCallbacks)i(e)}}class Wi{listeners={};constructor(){}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(i=>i!==t))}emit(e,...t){if(!this.listeners[e])return;const[i]=t;this.listeners[e].forEach(s=>{try{s(i)}catch(n){console.error(`Error in event listener for ${e}:`,n)}})}}const w=new Wi,y={START_XR:"START_XR",JOIN_ROOM:"JOIN_ROOM",CREATE_ROOM:"CREATE_ROOM",HOST_READY:"HOST_READY",SESSION_CONNECTED:"SESSION_CONNECTED",ENTITY_DISCOVERED:"ENTITY_DISCOVERED",PEER_DISCONNECTED:"PEER_DISCONNECTED",ASSET_LOADED:"ASSET_LOADED",ASSET_LOAD_ERROR:"ASSET_LOAD_ERROR",NETWORK_ERROR:"NETWORK_ERROR",HOST_DISCONNECTED:"HOST_DISCONNECTED",LOCAL_NAME_UPDATED:"LOCAL_NAME_UPDATED",REMOTE_NAME_UPDATED:"REMOTE_NAME_UPDATED",PEER_STATE_UPDATED:"PEER_STATE_UPDATED",AVATAR_CONFIG_UPDATED:"AVATAR_CONFIG_UPDATED",VOICE_STREAM_RECEIVED:"VOICE_STREAM_RECEIVED",SCENE_READY:"SCENE_READY",PHYSICS_READY:"PHYSICS_READY",AUDIO_READY:"AUDIO_READY",LOCAL_PLAYER_MOVED:"LOCAL_PLAYER_MOVED",OWNERSHIP_TRANSFERRED:"OWNERSHIP_TRANSFERRED",ENTITY_COLLIDED:"ENTITY_COLLIDED",PHYSICS_COLLISION_STARTED:"PHYSICS_COLLISION_STARTED",REQUEST_OWNERSHIP:"REQUEST_OWNERSHIP",RELEASE_OWNERSHIP:"RELEASE_OWNERSHIP",RECLAIM_OWNERSHIP:"RECLAIM_OWNERSHIP",SYSTEM_NOTIFICATION:"SYSTEM_NOTIFICATION",AUDIO_CHUNK_RECEIVED:"AUDIO_CHUNK_RECEIVED",PEER_JOINED_ROOM:"PEER_JOINED_ROOM",XR_SESSION_STARTED:"XR_SESSION_STARTED",XR_SESSION_ENDED:"XR_SESSION_ENDED",VOICE_STATE_UPDATED:"VOICE_STATE_UPDATED",SOCIAL_HIGH_FIVE:"SOCIAL_HIGH_FIVE",DESKTOP_SCREENS_UPDATED:"DESKTOP_SCREENS_UPDATED",INTENT_MOVE:"INTENT_MOVE",INTENT_LOOK:"INTENT_LOOK",INTENT_INTERACT_START:"INTENT_INTERACT_START",INTENT_INTERACT_END:"INTENT_INTERACT_END",INTENT_GRAB_START:"INTENT_GRAB_START",INTENT_GRAB_END:"INTENT_GRAB_END",INTENT_VR_SNAP_TURN:"INTENT_VR_SNAP_TURN"},M={STATE_UPDATE:0,PLAYER_INPUT:1,PEER_DISCONNECT:2,ROOM_CONFIG_UPDATE:3,OWNERSHIP_REQUEST:4,OWNERSHIP_RELEASE:5,OWNERSHIP_TRANSFER:6,AUDIO_CHUNK:7,PEER_JOINED:8,FEATURE_EVENT:9,FEATURE_SNAPSHOT:10,FEATURE_SNAPSHOT_REQUEST:11,DESKTOP_SOURCES_STATUS_REQUEST:12,DESKTOP_SOURCES_STATUS_RESPONSE:13,DESKTOP_STREAM_SUMMON:14,DESKTOP_STREAM_STOP:15,DESKTOP_STREAM_SUMMONED:16,DESKTOP_STREAM_STOPPED:17,DESKTOP_STREAM_OFFLINE:18,DESKTOP_STREAM_FRAME:19,ROOM_NOTIFICATION:20},ye={GAMEPAD_LOOK_SENSITIVITY:1.5,MOBILE_LOOK_SENSITIVITY:.6,DEADZONE:.15,GESTURE:{PINCH_ON_DISTANCE:.035,PINCH_OFF_DISTANCE:.05,FIST_CURL_THRESHOLD:.095,FIST_ON_CURL_COUNT:3,FIST_OFF_CURL_COUNT:1}},Fe=navigator.userAgent,Zt=/OculusBrowser|PicoBrowser|ViveBrowser|AppleVision/i,ei=/Android|iPhone|iPad|iPod|Mobile/i,ct=ei.test(Fe)&&!Zt.test(Fe),Yi=Zt.test(Fe)||!ei.test(Fe);class Xi{constructor(e){this.context=e,this.overlay=document.getElementById("ui-overlay"),this.nameInput=document.getElementById("player-name"),this.createBtn=document.getElementById("create-btn"),this.joinBtn=document.getElementById("join-btn"),this.roomInput=document.getElementById("room-id"),this.copyRoomBtn=document.getElementById("copy-room-btn"),this.avatarBtn=document.getElementById("avatar-btn"),this.avatarDialog=document.getElementById("avatar-dialog"),this.closeAvatarBtn=document.getElementById("close-avatar-btn"),this.avatarColorInput=document.getElementById("avatar-color"),this.voiceBtn=document.getElementById("voice-btn"),this.statusText=document.getElementById("status-text"),this.errorText=document.getElementById("error-text"),this.versionInfo=document.getElementById("app-version"),this.shaInfo=document.getElementById("git-sha"),this.desktopControls=document.getElementById("desktop-controls"),this.myScreensList=document.getElementById("my-screens-list"),this.addScreenBtn=document.getElementById("add-screen-btn"),this.mobileHud=document.getElementById("mobile-hud"),this.mobileMenuBtn=document.getElementById("mobile-menu-btn"),this.mobileActionBtn=document.getElementById("mobile-action-btn"),this.mobileInteractBtn=document.getElementById("mobile-interact-btn"),this.mobileReticle=document.getElementById("mobile-reticle"),this.isMobile=ct,this.init(),this.showOverlay()}overlay;nameInput;createBtn;joinBtn;roomInput;copyRoomBtn;avatarBtn;avatarDialog;closeAvatarBtn;avatarColorInput;voiceBtn;statusText;errorText;versionInfo;shaInfo;desktopControls;myScreensList;addScreenBtn;mobileHud;mobileMenuBtn;mobileActionBtn;mobileInteractBtn;mobileReticle;isMobile;_joysticksInitialized=!1;_mobileHudEnabled=!1;init(){const t=new URLSearchParams(window.location.search).get("room");t?this.setupGuestMode(t):this.setupDefaultMode();const i=document.getElementById("network-mode");if(i&&(this.context.isLocalServer?(i.textContent="ðŸ–¥ Dedicated Server",i.classList.add("server")):(i.textContent="â˜ PeerJS",i.classList.add("peerjs"))),this.copyRoomBtn&&this.copyRoomBtn.addEventListener("click",()=>this.handleInlineCopy()),this.voiceBtn&&this.voiceBtn.addEventListener("click",async()=>{this.ensureAudioContextResumed(),await this.setVoicePreference(!this.context.voiceAutoEnable),this.saveToStorage()}),this.nameInput.addEventListener("input",()=>{this.context.playerName=this.nameInput.value.trim(),this.saveToStorage()}),this.roomInput.addEventListener("input",()=>{this.saveToStorage()}),this.avatarBtn&&this.avatarBtn.addEventListener("click",()=>{this.avatarDialog.style.display="flex"}),this.closeAvatarBtn&&this.closeAvatarBtn.addEventListener("click",()=>{this.avatarDialog.style.display="none"}),this.avatarColorInput&&this.avatarColorInput.addEventListener("input",()=>{this.context.avatarConfig.color=this.avatarColorInput.value,this.saveToStorage(),w.emit(y.AVATAR_CONFIG_UPDATED,this.context.avatarConfig),this.updateAvatarButtonColor(this.context.avatarConfig.color)}),this.addScreenBtn&&this.addScreenBtn.addEventListener("click",()=>{const s=this.context.managers.remoteDesktop.getConfigs();s.push({name:`Screen ${s.length+1}`,key:""}),this.context.managers.remoteDesktop.setConfigs(s),this.renderMyScreensEditor()}),this.mobileMenuBtn&&this.mobileMenuBtn.addEventListener("click",()=>{this._mobileHudEnabled&&this.context.managers.vrUi?.toggle2DMenu()}),this.mobileActionBtn){const s=o=>{o.preventDefault(),this.context.managers.input?.beginMobilePrimaryAction()},n=o=>{o.preventDefault(),this.context.managers.input?.endMobilePrimaryAction()};this.mobileActionBtn.addEventListener("pointerdown",s),this.mobileActionBtn.addEventListener("pointerup",n),this.mobileActionBtn.addEventListener("pointercancel",n),this.mobileActionBtn.addEventListener("pointerleave",n)}if(this.mobileInteractBtn&&this.mobileInteractBtn.addEventListener("click",s=>{s.preventDefault(),this.context.managers.input?.toggleMobileSecondaryAction()}),w.on(y.HOST_READY,s=>{this.context.isHost&&(this.setStatus("Room Created! Starting..."),this.ensureAudioContextResumed(),setTimeout(()=>this.hideOverlay(),1e3))}),w.on(y.SESSION_CONNECTED,()=>{this.context.isHost||(this.setStatus("Connected!"),setTimeout(()=>this.hideOverlay(),1e3))}),w.on(y.NETWORK_ERROR,s=>{this.showError(s),this.enableAllButtons(),this.setStatus("Ready")}),w.on(y.HOST_DISCONNECTED,()=>{this.showError("Host disconnected. Session ended."),this.handleLeave()}),w.on(y.VOICE_STATE_UPDATED,()=>{this.updateVoiceButton(this.context.voiceAutoEnable)}),w.on(y.DESKTOP_SCREENS_UPDATED,()=>{this.renderMyScreensEditor()}),this.loadFromStorage(),this.renderMyScreensEditor(),!this.context.isLocalServer){const s=document.getElementById("avatar-screens-group");s&&(s.style.display="none")}}update(e){this.overlay.style.display==="none"&&this.isMobile&&!this._joysticksInitialized&&(this.context.managers.input?.initMobileJoysticks(),this._joysticksInitialized=!0),this.isMobile&&this.updateMobileHudState()}generateRandomName(){const e=["Neon","Cyber","Chrome","Laser","Retro","Synth","Pixel","Vector","Static","Glitch","Binary","Digital","Atomic","Cosmic","Plasma","Electric"],t=["Rider","Ghost","Glitch","Runner","Phantom","Wave","Pulse","Spark","Cipher","Nomad","Drifter","Echo","Void","Horizon","Core","Link"],i=e[Math.floor(Math.random()*e.length)],s=t[Math.floor(Math.random()*t.length)],n=Math.floor(Math.random()*900)+100;return`${i}-${s}-${n}`}loadFromStorage(){const e=localStorage.getItem("hangout_playerName");if(e)this.nameInput.value=e;else{const n=this.generateRandomName();this.nameInput.value=n,localStorage.setItem("hangout_playerName",n)}const t=localStorage.getItem("hangout_lastRoomId");if(t)this.roomInput.value=t;else{const n="TestRoom";this.roomInput.value=n,localStorage.setItem("hangout_lastRoomId",n)}const i=localStorage.getItem("hangout_voiceEnabled");i==="false"?this.context.voiceAutoEnable=!1:(this.context.voiceAutoEnable=!0,i===null&&localStorage.setItem("hangout_voiceEnabled","true")),this.context.voiceEnabled=this.context.managers.media?.isMicrophoneEnabled()||!1,this.updateVoiceButton(this.context.voiceAutoEnable);const s=localStorage.getItem("hangout_avatarColor");if(s)this.context.avatarConfig.color=s;else{const n=["#00ffff","#ff00ff","#39ff14","#fffd01","#ff3131","#bc13fe","#ff5e00","#00ff08"],o=n[Math.floor(Math.random()*n.length)];this.context.avatarConfig.color=o,localStorage.setItem("hangout_avatarColor",o)}this.avatarColorInput&&(this.avatarColorInput.value=this.context.avatarConfig.color),this.updateAvatarButtonColor(this.context.avatarConfig.color),this.context.playerName=this.nameInput.value.trim(),this.versionInfo&&(this.versionInfo.textContent="v1.0.0alpha"),this.shaInfo&&(this.shaInfo.textContent="build: 36bb2d0 (01.03.26, 21:29)"),this.context.managers.remoteDesktop.loadConfigsFromStorage()}saveToStorage(){const e=this.nameInput.value.trim(),t=this.roomInput.value.trim();e&&(localStorage.setItem("hangout_playerName",e),this.context.playerName=e,w.emit(y.LOCAL_NAME_UPDATED,e)),this.context.avatarConfig.color&&localStorage.setItem("hangout_avatarColor",this.context.avatarConfig.color),localStorage.setItem("hangout_voiceEnabled",String(this.context.voiceAutoEnable)),t&&localStorage.setItem("hangout_lastRoomId",t)}generateReadableRoomId(){const e=["neon","cyber","retro","pixel","synth","hyper","quantum","turbo","holo","astro"],t=["tiger","rider","runner","punk","wave","grid","nexus","core","blade","nova"],i=e[Math.floor(Math.random()*e.length)],s=t[Math.floor(Math.random()*t.length)];return`${i}-${s}-${Math.floor(Math.random()*100)}`}disableAllButtons(){this.createBtn.disabled=!0,this.joinBtn.disabled=!0}enableAllButtons(){this.createBtn.disabled=!1,this.joinBtn.disabled=!1}setupGuestMode(e){this.context.isHost=!1,this.createBtn&&(this.createBtn.style.display="none"),this.roomInput.value=e,this.joinBtn.addEventListener("click",async()=>{this.ensureAudioContextResumed(),this.context.playerName=this.nameInput.value.trim()||"Guest",this.context.voiceAutoEnable&&await this.context.managers.media.ensureMicrophoneEnabled(),this.setStatus("Connecting to host..."),this.joinBtn.disabled=!0,w.emit(y.JOIN_ROOM,this.roomInput.value.trim()||e)})}setupDefaultMode(){if(this.context.isLocalServer){this.createBtn.style.display="none",this.joinBtn.textContent="Enter Hangout",this.joinBtn.classList.remove("secondary-btn"),this.joinBtn.classList.add("primary-btn"),this.joinBtn.addEventListener("click",async()=>{this.ensureAudioContextResumed(),this.context.playerName=this.nameInput.value.trim()||"Player",this.context.voiceAutoEnable&&await this.context.managers.media.ensureMicrophoneEnabled();const e=this.roomInput.value.trim()||this.generateReadableRoomId();this.roomInput.value=e,this.disableAllButtons(),this.clearError(),this.saveToStorage(),this.context.isHost=!1,this.setStatus("Connecting to headless server..."),w.emit(y.JOIN_ROOM,e)});return}this.createBtn.addEventListener("click",async()=>{this.ensureAudioContextResumed(),this.context.playerName=this.nameInput.value.trim()||"Host",this.context.voiceAutoEnable&&await this.context.managers.media.ensureMicrophoneEnabled();const e=this.roomInput.value.trim()||this.generateReadableRoomId();this.disableAllButtons(),this.clearError(),this.saveToStorage(),this.context.isHost=!0,this.setStatus("Creating room..."),w.emit(y.CREATE_ROOM,e)}),this.joinBtn.addEventListener("click",async()=>{this.ensureAudioContextResumed(),this.context.playerName=this.nameInput.value.trim()||"Player",this.context.voiceAutoEnable&&await this.context.managers.media.ensureMicrophoneEnabled();const e=this.roomInput.value.trim();if(!e){this.setStatus("Please enter a Room Name to join.");return}this.disableAllButtons(),this.clearError(),this.saveToStorage(),this.context.isHost=!1,this.setStatus("Connecting to host..."),w.emit(y.JOIN_ROOM,e)})}renderMyScreensEditor(){if(!this.myScreensList)return;this.myScreensList.innerHTML="";const e=this.context.managers.remoteDesktop.getConfigs();for(let t=0;t<e.length;t++){const i=e[t],s=document.createElement("div");s.className="screen-row";const n=document.createElement("input");n.type="text",n.placeholder="Screen Name",n.value=i.name,n.className="screen-input";const o=document.createElement("input");o.type="text",o.placeholder="Secret Key",o.value=i.key,o.className="screen-input";const r=document.createElement("button");r.className="primary-btn secondary-style screen-btn-compact",r.type="button",r.textContent="Remove";const a=()=>{const h=n.value,l=o.value;if(n.classList.toggle("input-invalid",h.length>0&&h.length<4),o.classList.toggle("input-invalid",l.length>0&&l.length<4),h.length>=4&&l.length>=4){const c=this.context.managers.remoteDesktop.getConfigs();if(!c[t])return;c[t]={name:h,key:l},this.context.managers.remoteDesktop.setConfigs(c,!0)}};n.addEventListener("input",a),o.addEventListener("input",a),r.addEventListener("click",()=>{const h=this.context.managers.remoteDesktop.getConfigs();h.splice(t,1),this.context.managers.remoteDesktop.setConfigs(h),this.renderMyScreensEditor()}),s.appendChild(n),s.appendChild(o),s.appendChild(r),this.myScreensList.appendChild(s)}}handleInlineCopy(){const e=this.roomInput.value.trim()||"TestRoom",t=new URL(window.location.href);t.searchParams.set("room",e);const i=this.copyRoomBtn.textContent;navigator.clipboard.writeText(t.toString()).then(()=>{this.copyRoomBtn.textContent="âœ…",setTimeout(()=>{this.copyRoomBtn.textContent=i},2e3)}).catch(()=>{this.setStatus("Copy failed.")})}setStatus(e){this.statusText&&(this.statusText.textContent=e)}showError(e){this.errorText&&(this.errorText.textContent=e)}clearError(){this.errorText&&(this.errorText.textContent="")}hideOverlay(){console.log("[FlatUIManager] hideOverlay() called"),this.context.isMenuOpen=!1,this.overlay&&(this.overlay.style.opacity="0",setTimeout(()=>{this.overlay.style.display="none",this.desktopControls&&!this.isMobile&&(console.log("[FlatUIManager] Showing desktop controls"),this.desktopControls.style.display="block"),this.isMobile&&(this._mobileHudEnabled=!0,this.mobileHud&&(this.mobileHud.style.display="block"),this.mobileMenuBtn&&(this.mobileMenuBtn.style.display="block"),this.context.managers.input?.initMobileJoysticks(),this._joysticksInitialized=!0,this.updateMobileHudState())},500))}ensureAudioContextResumed(){this.context.managers.render&&this.context.managers.render.audioListener&&this.context.managers.render.audioListener.context.state==="suspended"&&this.context.managers.render.audioListener.context.resume()}getNavigableElements(){if(!this.overlay||this.overlay.style.display==="none")return[];const e=[];return this.nameInput&&this.nameInput.offsetParent&&e.push(this.nameInput),this.roomInput&&this.roomInput.offsetParent&&e.push(this.roomInput),this.copyRoomBtn&&this.copyRoomBtn.offsetParent&&e.push(this.copyRoomBtn),this.createBtn&&this.createBtn.offsetParent&&e.push(this.createBtn),this.joinBtn&&this.joinBtn.offsetParent&&e.push(this.joinBtn),this.voiceBtn&&this.voiceBtn.offsetParent&&e.push(this.voiceBtn),e}async setVoicePreference(e){this.context.voiceAutoEnable=e;const t=await this.context.managers.media.setMicrophoneEnabled(e);e?this.context.voiceEnabled=t:this.context.voiceEnabled=!1}updateVoiceButton(e){this.voiceBtn&&(e?(this.voiceBtn.textContent="Auto Voice: ON",this.voiceBtn.classList.add("ready")):(this.voiceBtn.textContent="Auto Voice: OFF",this.voiceBtn.classList.remove("ready")))}updateAvatarButtonColor(e){this.avatarBtn&&(this.avatarBtn.style.setProperty("--avatar-color",e),this.avatarBtn.style.backgroundColor=`${e}33`,this.avatarBtn.style.borderColor=e,this.avatarBtn.style.boxShadow=`0 0 15px ${e}66`)}showOverlay(){console.log("[FlatUIManager] showOverlay() called"),this.context.isMenuOpen=!0,this.overlay&&(this.overlay.style.display="flex",this.overlay.offsetHeight,this.overlay.style.opacity="1"),this.desktopControls&&(console.log("[FlatUIManager] Hiding desktop controls"),this.desktopControls.style.display="none"),this.mobileHud&&(this.mobileHud.style.display="none"),this.mobileActionBtn&&(this.mobileActionBtn.style.display="none"),this.mobileInteractBtn&&(this.mobileInteractBtn.style.display="none"),this.mobileReticle&&this.mobileReticle.classList.remove("active"),this.mobileMenuBtn&&(this.mobileMenuBtn.style.display=this.isMobile&&this._mobileHudEnabled?"block":"none")}handleLeave(){this.context.managers.network&&this.context.managers.network.disconnect(),this.context.managers.media&&this.context.managers.media.stopMicrophone(),this.context.managers.entity&&Array.from(this.context.managers.entity.entities.values()).forEach(t=>{t.type!=="LOCAL_PLAYER"&&this.context.managers.entity.removeEntity(t.id)}),this.context.isDedicatedHost=!1,this._mobileHudEnabled=!1,this.mobileMenuBtn&&(this.mobileMenuBtn.style.display="none"),this.showOverlay(),this.setStatus("Ready"),this.enableAllButtons()}updateMobileHudState(){if(!this.isMobile||!this._mobileHudEnabled)return;const e=this.context.managers.input,t=this.overlay.style.display==="none"&&!!e?.hasMobilePrimaryAction(),i=this.overlay.style.display==="none"&&!!e?.hasMobileSecondaryAction();this.mobileHud&&(this.mobileHud.style.display=this.overlay.style.display==="none"?"block":"none"),this.mobileActionBtn&&(t?(this.mobileActionBtn.textContent=e.getMobilePrimaryActionLabel()||"Use",this.mobileActionBtn.style.display="block"):this.mobileActionBtn.style.display="none"),this.mobileInteractBtn&&(i?(this.mobileInteractBtn.textContent=e.getMobileSecondaryActionLabel()||"Use",this.mobileInteractBtn.style.display="block"):this.mobileInteractBtn.style.display="none"),this.mobileReticle&&this.mobileReticle.classList.toggle("active",!!e?.isMobileFocusActive()),this.mobileMenuBtn&&(this.mobileMenuBtn.textContent=this.context.isMenuOpen?"Close":"Menu")}}var F=(d=>(d.LOCAL_PLAYER="LOCAL_PLAYER",d.REMOTE_PLAYER="REMOTE_PLAYER",d.PHYSICS_PROP="PHYSICS_PROP",d.PEN="PEN",d))(F||{});function N(d){return!!d&&typeof d=="object"}function Ji(d){if(!Array.isArray(d))return!1;for(const e of d)if(!N(e)||typeof e.id!="string"||!("type"in e)||!("state"in e))return!1;return!0}function $i(d){return N(d)&&typeof d.entityId=="string"&&(d.seq===void 0||typeof d.seq=="number")&&(d.sentAt===void 0||typeof d.sentAt=="number")}function Zi(d){return N(d)&&typeof d.entityId=="string"&&(d.seq===void 0||typeof d.seq=="number")&&(d.sentAt===void 0||typeof d.sentAt=="number")}function es(d){return N(d)&&typeof d.entityId=="string"&&(typeof d.newOwnerId=="string"||d.newOwnerId===null)&&(d.seq===void 0||typeof d.seq=="number")&&(d.sentAt===void 0||typeof d.sentAt=="number")}function ts(d){return!(!N(d)||"assignedSpawnIndex"in d&&typeof d.assignedSpawnIndex!="number")}function is(d){return N(d)&&typeof d.peerId=="string"}function ss(d){return typeof d=="string"||N(d)&&typeof d.peerId=="string"}function ns(d){return N(d)&&typeof d.featureId=="string"&&typeof d.eventType=="string"&&typeof d.eventId=="string"&&typeof d.originPeerId=="string"&&typeof d.sentAt=="number"&&"data"in d}function os(d){if(!N(d)||!Array.isArray(d.features))return!1;for(const e of d.features)if(!N(e)||typeof e.featureId!="string"||!("snapshot"in e))return!1;return!0}function rs(d){return!(!N(d)||"request"in d&&typeof d.request!="boolean")}function as(d){return N(d)&&Array.isArray(d.keys)}function hs(d){return!(!N(d)||!N(d.statuses)||"activeKeys"in d&&!Array.isArray(d.activeKeys))}function ls(d){return!(!N(d)||typeof d.key!="string"||"name"in d&&typeof d.name!="string")}function cs(d){return N(d)&&typeof d.key=="string"}function ds(d){return N(d)&&typeof d.key=="string"&&typeof d.roomId=="string"}function us(d){return N(d)&&typeof d.key=="string"&&typeof d.roomId=="string"}function ps(d){return N(d)&&typeof d.key=="string"&&typeof d.roomId=="string"}function fs(d){return N(d)&&typeof d.key=="string"&&typeof d.roomId=="string"&&typeof d.dataUrl=="string"}function ms(d){return!(!N(d)||typeof d.kind!="string"||"actorPeerId"in d&&typeof d.actorPeerId!="string"||"actorName"in d&&typeof d.actorName!="string"||"subjectName"in d&&typeof d.subjectName!="string"||"message"in d&&typeof d.message!="string"||"sentAt"in d&&typeof d.sentAt!="number"||"level"in d&&d.level!=="info"&&d.level!=="warn"&&d.level!=="error")}function gs(d,e){switch(d){case M.STATE_UPDATE:case M.PLAYER_INPUT:return Ji(e);case M.OWNERSHIP_REQUEST:return $i(e);case M.OWNERSHIP_RELEASE:return Zi(e);case M.OWNERSHIP_TRANSFER:return es(e);case M.ROOM_CONFIG_UPDATE:return ts(e);case M.PEER_JOINED:return is(e);case M.PEER_DISCONNECT:return ss(e);case M.FEATURE_EVENT:return ns(e);case M.FEATURE_SNAPSHOT:return os(e);case M.FEATURE_SNAPSHOT_REQUEST:return rs(e);case M.DESKTOP_SOURCES_STATUS_REQUEST:return as(e);case M.DESKTOP_SOURCES_STATUS_RESPONSE:return hs(e);case M.DESKTOP_STREAM_SUMMON:return ls(e);case M.DESKTOP_STREAM_STOP:return cs(e);case M.DESKTOP_STREAM_SUMMONED:return ds(e);case M.DESKTOP_STREAM_STOPPED:return us(e);case M.DESKTOP_STREAM_OFFLINE:return ps(e);case M.DESKTOP_STREAM_FRAME:return fs(e);case M.ROOM_NOTIFICATION:return ms(e);case M.AUDIO_CHUNK:default:return!0}}function ys(d){if(!d||typeof d!="object")return!1;const e=d;return typeof e.type=="number"&&"payload"in e}class ws{handlers=new Map;registerHandler(e,t){this.handlers.set(e,t)}dispatch(e,t){try{const i=typeof t=="string"?JSON.parse(t):t;if(!ys(i))return;const s=i,n=this.handlers.get(s.type);if(n){if(!gs(s.type,s.payload)){console.warn(`[NetworkDispatcher] Dropping invalid payload for packet type ${s.type}`);return}n.handle(e,s.payload)}}catch(i){console.error("[NetworkDispatcher] Failed to dispatch packet:",i)}}}class xs{constructor(e,t){this.context=t,this.transport=e}transport;syncRate=1/20;heartbeatRate=2;timeSinceLastSync=0;timeSinceLastHeartbeat=0;update(e){this.timeSinceLastSync+=e,this.timeSinceLastHeartbeat+=e;const t=this.timeSinceLastSync>=this.syncRate,i=this.timeSinceLastHeartbeat>=this.heartbeatRate;(t||i)&&(this.syncState(i),this.timeSinceLastSync=0,i&&(this.timeSinceLastHeartbeat=0))}syncState(e=!1){const t=this.context.managers;if(t.entity)if(e||this.context.isHost){const i=t.entity.getWorldSnapshot();i.length>0&&this.transport.broadcast(M.STATE_UPDATE,i)}else{const i=t.entity.getAuthoritativeStates(e);i.length>0&&this.context.roomId&&this.transport.sendData(this.context.roomId,M.PLAYER_INPUT,i)}}syncEntityNow(e,t=!1){const s=this.context.managers.entity?.getEntity(e);if(!s||s.isDestroyed)return;const n=s;if(!n.getNetworkState)return;const o=n.getNetworkState(t);if(!o)return;const r=[{id:s.id,type:s.type,state:o}];if(this.context.isHost){this.transport.broadcast(M.STATE_UPDATE,r);return}this.context.roomId&&this.transport.sendData(this.context.roomId,M.PLAYER_INPUT,r)}}class Ss{constructor(e){this.context=e,this.dispatcher=new ws,this.synchronizer=new xs(this,e),this.registerHandlers(),w.on(y.CREATE_ROOM,t=>this.initHost(t)),w.on(y.JOIN_ROOM,t=>this.initGuest(t)),w.on(y.REQUEST_OWNERSHIP,t=>{!this.context.isHost&&this.context.roomId&&this.sendData(this.context.roomId,M.OWNERSHIP_REQUEST,{...t,sentAt:this.nowMs()})}),w.on(y.RELEASE_OWNERSHIP,t=>{!this.context.isHost&&this.context.roomId&&this.sendData(this.context.roomId,M.OWNERSHIP_RELEASE,{...t,sentAt:this.nowMs()})}),document.addEventListener("visibilitychange",()=>{document.hidden&&console.warn("[NetworkManager] Tab hidden.")})}peer=null;localPeerId=null;relaySocket=null;connections=new Map;dispatcher;synchronizer;ownershipSeqByEntity=new Map;lastAppliedOwnershipSeqByEntity=new Map;registerHandlers(){this.dispatcher.registerHandler(M.STATE_UPDATE,new bs(this.context)),this.dispatcher.registerHandler(M.PLAYER_INPUT,new vs(this,this.context)),this.dispatcher.registerHandler(M.PEER_DISCONNECT,new Es(this.context)),this.dispatcher.registerHandler(M.ROOM_CONFIG_UPDATE,new Ms(this.context)),this.dispatcher.registerHandler(M.OWNERSHIP_REQUEST,new Rs(this,this.context)),this.dispatcher.registerHandler(M.OWNERSHIP_RELEASE,new Ps(this,this.context)),this.dispatcher.registerHandler(M.OWNERSHIP_TRANSFER,new As(this.context)),this.dispatcher.registerHandler(M.PEER_JOINED,new Is(this.context)),this.dispatcher.registerHandler(M.FEATURE_EVENT,new Cs(this.context)),this.dispatcher.registerHandler(M.FEATURE_SNAPSHOT,new _s(this.context)),this.dispatcher.registerHandler(M.FEATURE_SNAPSHOT_REQUEST,new Ls(this.context)),this.dispatcher.registerHandler(M.DESKTOP_SOURCES_STATUS_RESPONSE,new Ds(this.context)),this.dispatcher.registerHandler(M.DESKTOP_STREAM_SUMMONED,new ks(this.context)),this.dispatcher.registerHandler(M.DESKTOP_STREAM_STOPPED,new Ns(this.context)),this.dispatcher.registerHandler(M.DESKTOP_STREAM_OFFLINE,new Os(this.context)),this.dispatcher.registerHandler(M.DESKTOP_STREAM_FRAME,new Hs(this.context)),this.dispatcher.registerHandler(M.ROOM_NOTIFICATION,new Bs(this.context))}getPeerConfig(){return this.context.isLocalServer?{host:window.location.hostname,port:parseInt(window.location.port)||443,path:"/peerjs",secure:window.location.protocol==="https:",debug:2,config:{iceServers:[]}}:{debug:2}}async initHost(e){if(this.context.isLocalServer)return this.context.isHost=!1,this.initWebSocketOnly(e);const t=this.getPeerConfig();this.peer=e?new Ge(e,t):new Ge(t),this.peer.on("error",i=>this.handlePeerError(i)),this.peer.on("open",async i=>{console.log(`[NetworkManager] Host Peer ID: ${i}`),this.context.roomId=i,this.context.managers.media&&this.context.managers.media.bindPeer(this.peer),w.emit(y.HOST_READY,i)}),this.peer.on("connection",i=>{this.setupConnection(i)})}async initGuest(e){if(this.context.isLocalServer)return this.initWebSocketOnly(e);const t=this.getPeerConfig();this.peer=new Ge(t),this.peer.on("error",i=>this.handlePeerError(i)),this.peer.on("open",async i=>{console.log(`[NetworkManager] Guest Peer ID: ${i}`),this.context.roomId=e,this.context.managers.media&&this.context.managers.media.bindPeer(this.peer);const s=this.peer.connect(e,{reliable:!0});this.setupConnection(s)})}async initWebSocketOnly(e){return new Promise((t,i)=>{const s=window.location.protocol==="https:"?"wss:":"ws:",n=window.location.hostname,o=window.location.port,r=o==="443"||o==="80"||o===""?"":`:${o}`,a=`${s}//${n}${r}/relay`;this.relaySocket=new WebSocket(a),this.relaySocket.binaryType="arraybuffer";const h=this.context.localPlayer?.id||"guest-"+Math.random().toString(36).substr(2,9);this.localPeerId=h,this.relaySocket.onopen=()=>{console.log("[NetworkManager] Connected to Headless Server WebSocket"),this.relaySocket.send(JSON.stringify({type:"join",roomId:e,peerId:h})),this.context.roomId=e;const l=new zs(this.relaySocket,h);this.setupConnection(l),this.context.managers.media&&this.context.managers.media.bindWebSocket(this.relaySocket),t()},this.relaySocket.onerror=l=>i(l)})}setupConnection(e){e.on("open",()=>{if(this.connections.set(e.peer,e),this.context.isHost){const t={...this.context.roomConfig,assignedSpawnIndex:this.connections.size};this.sendData(e.peer,M.ROOM_CONFIG_UPDATE,t);const i=this.context.managers.entity.getWorldSnapshot();this.sendData(e.peer,M.STATE_UPDATE,i),this.context.managers.replication.sendSnapshotToPeer(e.peer)}else{if(!this.context.isLocalServer){const t=this.peer?.id;t&&w.emit(y.SESSION_CONNECTED,t)}this.context.managers.replication.requestSnapshotFromHost()}}),e.on("data",t=>{if(t instanceof ArrayBuffer){new DataView(t).getUint8(0)===M.DESKTOP_STREAM_FRAME&&this.context.managers.remoteDesktop.handleBinaryFrame(t);return}if(Ts(t)){const i=t.senderId||e.peer,n=this.context.managers.entity.getEntity(i);n&&typeof n.onAudioChunk=="function"&&n.onAudioChunk(t.payload)}else this.dispatcher.dispatch(e.peer,t)}),e.on("close",()=>{this.connections.delete(e.peer),w.emit(y.PEER_DISCONNECTED,e.peer),this.context.isHost&&(this.reclaimOwnership(e.peer),this.broadcast(M.PEER_DISCONNECT,e.peer)),!this.context.isHost&&e.peer===this.context.roomId&&w.emit(y.HOST_DISCONNECTED)})}update(e){this.synchronizer.update(e)}syncStateManually(){this.synchronizer.syncState()}syncEntityNow(e,t=!1){this.synchronizer.syncEntityNow(e,t)}applyStateUpdate(e){const t=this.context.managers;for(const i of e){let s=t.entity.getEntity(i.id);if(!s){if(this.context.localPlayer&&i.id===this.context.localPlayer.id)continue;const n=i.type===F.LOCAL_PLAYER?F.REMOTE_PLAYER:i.type,o={spawnPos:{x:0,y:0,z:0},spawnYaw:0,isAuthority:!1};s=t.entity.discover(i.id,n,o)||void 0}if(s&&!s.isAuthority){const n=s;n.applyNetworkState&&n.applyNetworkState(i.state)}}}relayToOthers(e,t,i){const s=JSON.stringify({type:t,payload:i});for(const[n,o]of this.connections.entries())o.open&&n!==e&&o.send(s)}reclaimOwnership(e){for(const t of this.context.managers.entity.entities.values()){const i=t;if(i.ownerId===e&&!i.isLocallyControlled){i.ownerId=null,i.heldBy!==void 0&&(i.heldBy=null),t.isAuthority=!0;const s=this.nextOwnershipSeq(t.id);this.broadcast(M.OWNERSHIP_TRANSFER,{entityId:t.id,newOwnerId:null,seq:s,sentAt:this.nowMs()})}}}applyOwnershipTransfer(e){const t=e.seq??0,i=this.lastAppliedOwnershipSeqByEntity.get(e.entityId)??0;if(t!==0&&t<=i)return;const s=this.context.managers.entity.getEntity(e.entityId);if(!s)return;t!==0&&this.lastAppliedOwnershipSeqByEntity.set(e.entityId,t);const n=e.newOwnerId===(this.context.localPlayer?.id||"local");s.ownerId=e.newOwnerId,s.isAuthority=n,s.onNetworkEvent?.("OWNERSHIP_TRANSFER",e)}handleOwnershipRequest(e,t){const i=this.context.managers.entity.getEntity(t.entityId);if(!i)return;const s=i;if(!s.ownerId||s.ownerId===e){s.ownerId=e,i.isAuthority=e===(this.context.localPlayer?.id||"local");const n=this.nextOwnershipSeq(i.id);this.broadcast(M.OWNERSHIP_TRANSFER,{entityId:i.id,newOwnerId:e,seq:n,sentAt:this.nowMs()})}}handleOwnershipRelease(e,t){const i=this.context.managers.entity.getEntity(t.entityId);if(!i)return;const s=i;if(s.ownerId!==e)return;s.ownerId=null,i.isAuthority=!0,s.onNetworkEvent&&s.onNetworkEvent("OWNERSHIP_RELEASE",t);const n=this.nextOwnershipSeq(i.id);this.broadcast(M.OWNERSHIP_TRANSFER,{entityId:i.id,newOwnerId:null,seq:n,sentAt:this.nowMs()})}sendData(e,t,i){const s=this.connections.get(e)||(this.context.isLocalServer?this.connections.get("SERVER"):void 0);s&&s.open&&s.send(JSON.stringify({type:t,payload:i}))}broadcast(e,t){const i=JSON.stringify({type:e,payload:t});for(const s of this.connections.values())s.open&&s.send(i)}disconnect(){this.relaySocket&&(this.relaySocket.close(),this.relaySocket=null),this.peer&&(this.peer.destroy(),this.peer=null),this.connections.clear(),this.context.roomId=null}nextOwnershipSeq(e){const t=(this.ownershipSeqByEntity.get(e)??0)+1;return this.ownershipSeqByEntity.set(e,t),t}nowMs(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}handlePeerError(e){console.error("[NetworkManager] PeerJS Error:",e);let t="Network connection error.";switch(e.type){case"unavailable-id":t="Room name already taken. Please choose another.";break;case"peer-unavailable":t="Room not found. Please check the name.";break;case"network":t="Connection lost. Check your internet.";break;case"server-error":t="Signaling server unavailable.";break;case"browser-incompatible":t="Your browser does not support WebRTC.";break}w.emit(y.NETWORK_ERROR,t),this.peer&&!this.peer.open&&this.disconnect()}}function Ts(d){if(!d||typeof d!="object")return!1;const e=d,t=e.payload;return e.type===M.AUDIO_CHUNK&&!!t&&typeof t.chunk=="string"&&typeof t.isHeader=="boolean"}class bs{constructor(e){this.context=e}handle(e,t){this.context.isHost||this.context.managers.network.applyStateUpdate(t)}}class vs{constructor(e,t){this.network=e,this.context=t}handle(e,t){if(this.network.applyStateUpdate(t),this.context.isHost){const i=t.filter(s=>{if(s.type===F.LOCAL_PLAYER)return!0;const n=this.context.managers.entity.getEntity(s.id);return n&&!n.isAuthority});i.length>0&&this.network.relayToOthers(e,M.PLAYER_INPUT,i)}}}class Es{constructor(e){this.context=e}handle(e,t){this.context.isHost||w.emit(y.PEER_DISCONNECTED,t)}}class Ms{constructor(e){this.context=e}handle(e,t){if(!this.context.isHost&&(this.context.managers.room.updateConfig(t),this.context.isLocalServer)){const i=this.context.managers.network;i.localPeerId&&w.emit(y.SESSION_CONNECTED,i.localPeerId)}}}class Rs{constructor(e,t){this.network=e,this.context=t}handle(e,t){this.context.isHost&&this.network.handleOwnershipRequest(e,t)}}class Ps{constructor(e,t){this.network=e,this.context=t}handle(e,t){this.context.isHost&&this.network.handleOwnershipRelease(e,t)}}class As{constructor(e){this.context=e}handle(e,t){this.context.isHost||this.context.managers.network.applyOwnershipTransfer(t)}}class Is{constructor(e){this.context=e}handle(e,t){!this.context.isHost&&this.context.isLocalServer&&w.emit(y.PEER_JOINED_ROOM,t.peerId)}}class Cs{constructor(e){this.context=e}handle(e,t){this.context.managers.replication.handleIncomingFeatureEvent(e,t)}}class _s{constructor(e){this.context=e}handle(e,t){this.context.managers.replication.applySnapshotPayload(t)}}class Ls{constructor(e){this.context=e}handle(e,t){this.context.isHost&&this.context.managers.replication.sendSnapshotToPeer(e)}}class Ds{constructor(e){this.context=e}handle(e,t){this.context.managers.remoteDesktop.handleSourcesStatus(t)}}class ks{constructor(e){this.context=e}handle(e,t){this.context.managers.remoteDesktop.handleStreamSummoned(t)}}class Ns{constructor(e){this.context=e}handle(e,t){this.context.managers.remoteDesktop.handleStreamStopped(t)}}class Os{constructor(e){this.context=e}handle(e,t){this.context.managers.remoteDesktop.handleStreamOffline(t)}}class Hs{constructor(e){this.context=e}handle(e,t){this.context.managers.remoteDesktop.handleStreamFrame(t)}}class Bs{constructor(e){this.context=e}handle(e,t){const i=this.context.localPlayer?.id;if(t.actorPeerId&&i&&t.actorPeerId===i)return;let s=t.message||"";if(!s){const n=t.actorName||"Someone",o=t.subjectName||"a screen";switch(t.kind){case"desktop_stream_started":s=`${n} started sharing ${o}.`;break;case"desktop_stream_stopped":s=`${o} sharing stopped.`;break;case"desktop_stream_offline":s=`${o} went offline.`;break;case"system":s=t.message||"System Notification";break;default:s=t.message||t.kind}}w.emit(y.SYSTEM_NOTIFICATION,s)}}class zs{constructor(e,t){this.socket=e,this.localId=t,e.readyState===WebSocket.OPEN?setTimeout(()=>{this.open=!0,this.emit("open")},0):e.addEventListener("open",()=>{this.open=!0,this.emit("open")},{once:!0}),e.addEventListener("message",i=>{if(i.data instanceof ArrayBuffer){this.emit("data",i.data);return}try{const s=JSON.parse(i.data);if(s.type==="peer-joined"||s.type==="peer-left")return;this.emit("data",s)}catch{}}),e.addEventListener("close",()=>{this.open=!1,this.emit("close")})}peer="SERVER";open=!1;listeners={};on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(i=>i(t))}send(e){this.open&&this.socket.readyState===WebSocket.OPEN&&this.socket.send(typeof e=="string"?e:JSON.stringify(e))}close(){this.socket.close()}}class dt{constructor(e,t,i,s=!1){this.context=e,this.id=t,this.type=i,this.isAuthority=s}id;type;isAuthority;isDestroyed=!1;ownerId=null;requestOwnership(){const e=this.context.localPlayer?.id||"local";this.ownerId!==e&&(this.ownerId=e,this.isAuthority=!0,this.context.isHost||w.emit(y.REQUEST_OWNERSHIP,{entityId:this.id}))}releaseOwnership(){this.isAuthority&&(this.ownerId=null)}syncNetworkState(e){const t=this.context.localPlayer?.id||"local",i=e.ownerId!==void 0?e.ownerId:e.o;if(i!==void 0&&i!==this.ownerId){if(this.isAuthority&&i===null)return;this.ownerId=i,this.isAuthority=this.ownerId===t||this.ownerId===null&&this.context.isHost}}onNetworkEvent(e,t){}onAuthorityChanged(e){this.isAuthority=e}destroy(){this.isDestroyed=!0}}class qs extends dt{constructor(e,t,i,s,n={}){super(e,t,F.PHYSICS_PROP,i),this.context=e,this.rigidBody=s,this.view=n.view||null,this.isGrabbable=n.grabbable||!1,this.spawnPosition=n.spawnPosition?{...n.spawnPosition}:null,this.grabRadius=Math.max(.03,n.grabRadius??.06);const o=this.rigidBody.translation(),r=this.rigidBody.rotation();this.targetPos={x:o.x,y:o.y,z:o.z},this.targetRot={x:r.x,y:r.y,z:r.z,w:r.w},this.proxyRenderPos={...this.targetPos},this.proxyRenderRot={...this.targetRot},this.presentPos={...this.targetPos},this.presentRot={...this.targetRot},this.syncAuthority(),this.refreshSimMode()}rigidBody;view;isGrabbable;hoverSources=new Set;spawnPosition;heldBy=null;grabRadius;targetPos={x:0,y:0,z:0};targetRot={x:0,y:0,z:0,w:1};lerpFactor=.2;simMode="AuthoritativeDynamic";proxyRenderPos={x:0,y:0,z:0};proxyRenderRot={x:0,y:0,z:0,w:1};proxyInitialized=!1;presentPos={x:0,y:0,z:0};presentRot={x:0,y:0,z:0,w:1};snapshotBuffer=[];interpolationDelayMs=120;maxExtrapolationMs=80;maxSnapshotAgeMs=1500;maxSnapshots=64;lastOwnershipTransferSeq=0;pendingReleaseArmed=!1;pendingReleaseStartedAtMs=0;pendingReleaseMinHoldMs=220;pendingReleaseMaxHoldMs=900;setVec3(e,t,i,s){e.x=t,e.y=i,e.z=s}copyVec3(e,t){e.x=t.x,e.y=t.y,e.z=t.z}setQuat(e,t,i,s,n){e.x=t,e.y=i,e.z=s,e.w=n}copyQuat(e,t){e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w}getSimMode(){return this.simMode}getSnapshotBufferSize(){return this.snapshotBuffer.length}getLastOwnershipTransferSeq(){return this.lastOwnershipTransferSeq}getPendingReleaseMinHoldMs(){return this.pendingReleaseMinHoldMs}getPendingReleaseMaxHoldMs(){return this.pendingReleaseMaxHoldMs}setPendingReleaseHoldWindow(e,t){const i=Math.max(0,Math.floor(e)),s=Math.max(i+50,Math.floor(t));this.pendingReleaseMinHoldMs=i,this.pendingReleaseMaxHoldMs=s}syncAuthority(){const e=this.context.localPlayer?.id||"local",t=this.ownerId===e||this.ownerId===null&&this.context.isHost;this.isAuthority!==t&&this.onAuthorityChanged(t)}releasePhysicsOwnership(e){if(!this.isAuthority)return;this.rigidBody.wakeUp(),this.rigidBody.setBodyType(A.RigidBodyType.Dynamic,!0),e&&(Math.abs(e.x)>.1||Math.abs(e.y)>.1||Math.abs(e.z)>.1)&&this.rigidBody.setLinvel({x:e.x,y:e.y,z:e.z},!0);const t=this.context.localPlayer?.id||"local";this.context.isHost?(this.ownerId=null,this.syncAuthority(),this.refreshSimMode(),this.emitOwnershipReleaseNow()):(this.ownerId=t,this.isAuthority=!0,this.setSimMode("PendingReleaseDynamic"),this.pendingReleaseArmed=!0,this.pendingReleaseStartedAtMs=this.nowMs())}onHoverEnter(e){this.hoverSources.add(e),this.view&&this.view.setHighlight(!0)}onHoverExit(e){this.hoverSources.delete(e),this.view&&this.view.setHighlight(this.hoverSources.size>0)}onInteraction(e){}onGrab(e,t){this.rigidBody&&(this.requestOwnership(),this.pendingReleaseArmed=!1,this.heldBy=e,this.refreshSimMode(),this.context.managers.network?.syncEntityNow(this.id))}onRelease(e){this.rigidBody&&(this.heldBy=null,this.releasePhysicsOwnership(e))}getGrabRadius(){return this.grabRadius}updateGrabbedPose(e){this.copyVec3(this.targetPos,e.position),this.copyQuat(this.targetRot,e.quaternion),this.copyVec3(this.proxyRenderPos,e.position),this.copyQuat(this.proxyRenderRot,e.quaternion),this.copyVec3(this.presentPos,e.position),this.copyQuat(this.presentRot,e.quaternion),this.proxyInitialized=!0,this.rigidBody.setNextKinematicTranslation(e.position),this.rigidBody.setNextKinematicRotation(e.quaternion)}onNetworkEvent(e,t){if(e==="OWNERSHIP_RELEASE"){this.heldBy=null,this.rigidBody.setBodyType(A.RigidBodyType.Dynamic,!0),t.position&&this.rigidBody.setTranslation({x:t.position[0],y:t.position[1],z:t.position[2]},!1),t.quaternion&&this.rigidBody.setRotation({x:t.quaternion[0],y:t.quaternion[1],z:t.quaternion[2],w:t.quaternion[3]},!1),t.velocity&&this.rigidBody.setLinvel({x:t.velocity[0],y:t.velocity[1],z:t.velocity[2]},!0),this.rigidBody.wakeUp(),this.refreshSimMode();return}if(e==="OWNERSHIP_TRANSFER"){const i=t?.newOwnerId??null,s=this.context.localPlayer?.id||"local",n=typeof t?.seq=="number"?t.seq:0;if(n>0&&n<=this.lastOwnershipTransferSeq)return;n>0&&(this.lastOwnershipTransferSeq=n),this.simMode==="PendingReleaseDynamic"&&i!==s&&(this.pendingReleaseArmed=!1,this.refreshSimMode())}}update(e,t){switch(this.syncAuthority(),this.refreshSimMode(),this.simMode){case"HeldKinematic":{this.rigidBody.setNextKinematicTranslation(this.targetPos),this.rigidBody.setNextKinematicRotation(this.targetRot);const i=this.rigidBody.translation(),s=this.rigidBody.rotation();this.setVec3(this.presentPos,i.x,i.y,i.z),this.setQuat(this.presentRot,s.x,s.y,s.z,s.w);break}case"AuthoritativeDynamic":case"PendingReleaseDynamic":{const i=this.rigidBody.translation(),s=this.rigidBody.rotation();if(this.setVec3(this.presentPos,i.x,i.y,i.z),this.setQuat(this.presentRot,s.x,s.y,s.z,s.w),this.simMode==="PendingReleaseDynamic"&&this.pendingReleaseArmed){const o=this.nowMs()-this.pendingReleaseStartedAtMs,r=o>=this.pendingReleaseMinHoldMs,a=o>=this.pendingReleaseMaxHoldMs;r&&(this.rigidBody.isSleeping()||a)&&(this.pendingReleaseArmed=!1,this.emitOwnershipReleaseNow())}this.simMode==="AuthoritativeDynamic"&&this.ownerId!==null&&!this.context.isHost&&this.rigidBody.isSleeping()&&this.releasePhysicsOwnership(),this.isGrabbable&&!this.heldBy&&this.spawnPosition&&i.y<-10&&(this.rigidBody.setTranslation({x:this.spawnPosition.x,y:this.spawnPosition.y,z:this.spawnPosition.z},!0),this.rigidBody.setLinvel({x:0,y:0,z:0},!0),this.rigidBody.setAngvel({x:0,y:0,z:0},!0),this.rigidBody.wakeUp());break}case"ProxyKinematic":{this.updateProxyTargetFromBuffer(),this.rigidBody.setNextKinematicTranslation({x:this.targetPos.x,y:this.targetPos.y,z:this.targetPos.z}),this.rigidBody.setNextKinematicRotation({x:this.targetRot.x,y:this.targetRot.y,z:this.targetRot.z,w:this.targetRot.w}),this.proxyInitialized?(this.proxyRenderPos.x+=(this.targetPos.x-this.proxyRenderPos.x)*this.lerpFactor,this.proxyRenderPos.y+=(this.targetPos.y-this.proxyRenderPos.y)*this.lerpFactor,this.proxyRenderPos.z+=(this.targetPos.z-this.proxyRenderPos.z)*this.lerpFactor,this.nlerpQuaternion(this.proxyRenderRot,this.targetRot,this.lerpFactor)):(this.proxyRenderPos={...this.targetPos},this.proxyRenderRot={...this.targetRot},this.proxyInitialized=!0),this.presentPos=this.proxyRenderPos,this.presentRot=this.proxyRenderRot;break}}}present(e){this.view&&this.view.applyState({position:this.presentPos,quaternion:this.presentRot,lerpFactor:1},e)}getNetworkState(e=!1){const t=this.rigidBody.translation(),i=this.rigidBody.rotation(),s=this.rigidBody.linvel();return{id:this.id,type:F.PHYSICS_PROP,p:[t.x,t.y,t.z],q:[i.x,i.y,i.z,i.w],v:[s.x,s.y,s.z],b:this.heldBy,ownerId:this.ownerId}}applyNetworkState(e){if(this.syncNetworkState(e),this.isAuthority)return;const t={receivedAtMs:this.nowMs(),position:e.p?{x:e.p[0],y:e.p[1],z:e.p[2]}:{...this.targetPos},quaternion:e.q?{x:e.q[0],y:e.q[1],z:e.q[2],w:e.q[3]}:{...this.targetRot},velocity:e.v?{x:e.v[0],y:e.v[1],z:e.v[2]}:{x:0,y:0,z:0},heldBy:e.b||null};this.snapshotBuffer.push(t),this.snapshotBuffer.length>this.maxSnapshots&&this.snapshotBuffer.splice(0,this.snapshotBuffer.length-this.maxSnapshots);const i=t.receivedAtMs-this.maxSnapshotAgeMs;for(;this.snapshotBuffer.length>1&&this.snapshotBuffer[0].receivedAtMs<i;)this.snapshotBuffer.shift();this.heldBy=t.heldBy,this.copyVec3(this.targetPos,t.position),this.copyQuat(this.targetRot,t.quaternion),this.proxyInitialized||(this.copyVec3(this.proxyRenderPos,this.targetPos),this.copyQuat(this.proxyRenderRot,this.targetRot),this.copyVec3(this.presentPos,this.proxyRenderPos),this.copyQuat(this.presentRot,this.proxyRenderRot),this.proxyInitialized=!0)}refreshSimMode(){if(!this.isAuthority){this.setSimMode("ProxyKinematic");return}if(this.heldBy){this.setSimMode("HeldKinematic");return}if(!this.context.isHost&&this.simMode==="PendingReleaseDynamic"){this.setSimMode("PendingReleaseDynamic");return}this.setSimMode("AuthoritativeDynamic")}setSimMode(e){if(this.simMode===e)return;const t=this.simMode;switch(this.simMode=e,e){case"HeldKinematic":case"ProxyKinematic":this.rigidBody.wakeUp(),this.rigidBody.setBodyType(A.RigidBodyType.KinematicPositionBased,!0),this.rigidBody.setLinvel({x:0,y:0,z:0},!0),this.rigidBody.setAngvel({x:0,y:0,z:0},!0),e==="ProxyKinematic"&&t!=="ProxyKinematic"&&(this.clearSnapshotBuffer(),this.seedSnapshotFromCurrentPose(),this.copyVec3(this.proxyRenderPos,this.targetPos),this.copyQuat(this.proxyRenderRot,this.targetRot),this.copyVec3(this.presentPos,this.proxyRenderPos),this.copyQuat(this.presentRot,this.proxyRenderRot),this.proxyInitialized=!0);break;case"AuthoritativeDynamic":case"PendingReleaseDynamic":this.rigidBody.setBodyType(A.RigidBodyType.Dynamic,!0),this.rigidBody.wakeUp(),t==="ProxyKinematic"&&this.clearSnapshotBuffer();break}}updateProxyTargetFromBuffer(){if(this.snapshotBuffer.length===0)return;const t=this.nowMs()-this.interpolationDelayMs,i=this.sampleSnapshotAt(t);i&&(this.copyVec3(this.targetPos,i.position),this.copyQuat(this.targetRot,i.quaternion),this.heldBy=i.heldBy)}sampleSnapshotAt(e){const t=this.snapshotBuffer;if(t.length===0)return null;if(t.length===1)return t[0];for(let o=0;o<t.length-1;o++){const r=t[o],a=t[o+1];if(e>=r.receivedAtMs&&e<=a.receivedAtMs){const h=Math.max(1,a.receivedAtMs-r.receivedAtMs),l=(e-r.receivedAtMs)/h;return{receivedAtMs:e,position:{x:r.position.x+(a.position.x-r.position.x)*l,y:r.position.y+(a.position.y-r.position.y)*l,z:r.position.z+(a.position.z-r.position.z)*l},quaternion:this.nlerpQuaternionNew(r.quaternion,a.quaternion,l),velocity:{x:r.velocity.x+(a.velocity.x-r.velocity.x)*l,y:r.velocity.y+(a.velocity.y-r.velocity.y)*l,z:r.velocity.z+(a.velocity.z-r.velocity.z)*l},heldBy:a.heldBy}}}const i=t[t.length-1],n=Math.min(this.maxExtrapolationMs,Math.max(0,e-i.receivedAtMs))/1e3;return{receivedAtMs:e,position:{x:i.position.x+i.velocity.x*n,y:i.position.y+i.velocity.y*n,z:i.position.z+i.velocity.z*n},quaternion:{...i.quaternion},velocity:{...i.velocity},heldBy:i.heldBy}}nlerpQuaternion(e,t,i){let s=t.x,n=t.y,o=t.z,r=t.w;e.x*s+e.y*n+e.z*o+e.w*r<0&&(s=-s,n=-n,o=-o,r=-r);const h=1-i;e.x=h*e.x+i*s,e.y=h*e.y+i*n,e.z=h*e.z+i*o,e.w=h*e.w+i*r;const l=Math.hypot(e.x,e.y,e.z,e.w)||1;e.x/=l,e.y/=l,e.z/=l,e.w/=l}nlerpQuaternionNew(e,t,i){const s={x:e.x,y:e.y,z:e.z,w:e.w};return this.nlerpQuaternion(s,t,i),s}nowMs(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}emitOwnershipReleaseNow(){const e=this.getNetworkState();w.emit(y.RELEASE_OWNERSHIP,{entityId:this.id,velocity:e.v,position:e.p,quaternion:e.q})}clearSnapshotBuffer(){this.snapshotBuffer.length=0}seedSnapshotFromCurrentPose(){const e=this.rigidBody.translation(),t=this.rigidBody.rotation(),i=this.rigidBody.linvel(),s={receivedAtMs:this.nowMs(),position:{x:e.x,y:e.y,z:e.z},quaternion:{x:t.x,y:t.y,z:t.z,w:t.w},velocity:{x:i.x,y:i.y,z:i.z},heldBy:this.heldBy};this.snapshotBuffer.push(s),this.copyVec3(this.targetPos,s.position),this.copyQuat(this.targetRot,s.quaternion)}destroy(){super.destroy();const e=this.context.managers.render;e&&this.view&&(this.view.removeFromScene(e.scene),this.view.destroy())}}class ut{mesh;interactionGroup=null;constructor(e){this.mesh=e}setHighlight(e){}setColor(e){}setName(e){}attachVoiceStream(e){}attachAudioChunk(e){}getAudioLevel(){return 0}addToScene(e){this.mesh&&e.add(this.mesh)}addToInteractionGroup(e){this.interactionGroup=e,this.mesh&&e.add(this.mesh)}removeFromScene(e){this.mesh&&e.remove(this.mesh)}_cleanupMesh(){this.mesh&&(this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.interactionGroup&&this.interactionGroup.remove(this.mesh))}}class tt extends ut{_originalEmissive=new D(0);constructor(e,t){super(e),this.mesh.userData.entityId=t,this.mesh.traverse(i=>{i.userData.entityId=t}),e.material&&e.material.emissive&&this._originalEmissive.copy(e.material.emissive)}setHighlight(e){this.mesh.traverse(t=>{const i=t;if(i.isMesh&&i.material&&i.material.emissive){const s=i.material;e?(s.emissive.set(16777215),s.emissiveIntensity=.5):(s.emissive.copy(this._originalEmissive),s.emissiveIntensity=this._originalEmissive.r+this._originalEmissive.g+this._originalEmissive.b>0?1:.3,s.emissiveIntensity===.3&&!e&&(s.emissiveIntensity=.3))}})}applyState(e,t){if(e.lerpFactor>=1)this.mesh.position.set(e.position.x,e.position.y,e.position.z),this.mesh.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w);else{const i=new x(e.position.x,e.position.y,e.position.z),s=new C(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w);this.mesh.position.lerp(i,e.lerpFactor),this.mesh.quaternion.slerp(s,e.lerpFactor)}}destroy(){this._cleanupMesh(),this.mesh.traverse(e=>{const t=e;t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose()))})}}class Fs{constructor(e){this.context=e}world=null;nextPhysicsId=0;accumulator=0;fixedTimeStep=1/60;debugBodies=new Map;eventQueue=null;colliderToEntity=new Map;entityToPrimaryCollider=new Map;activePropContacts=new Map;lastTouchClaimAtMsByEntity=new Map;touchLeaseClaimIntervalMs=250;touchLeaseProximityDistance=.55;pendingReleaseMinHoldMs=220;pendingReleaseMaxHoldMs=900;touchQueryShape=new A.Ball(.55);grabQueryShape=new A.Ball(.05);identityRotation={x:0,y:0,z:0,w:1};touchQueryHitsThisFrame=0;touchQueryHitsAccum=0;touchQueryFramesAccum=0;touchQueryAvgAccumulatorSec=0;touchQueryAvgHitsPerFrame=0;touchQueryHitsByEntityAccum=new Map;touchQueryHitsByEntityWindow=new Map;collisionSoundCooldownMs=100;lastCollisionSoundAtByPair=new Map;async init(){await A.init();const e={x:0,y:-9.81,z:0};this.world=new A.World(e),this.eventQueue=new A.EventQueue(!0),console.log("[PhysicsManager] Rapier3D initialized"),w.emit(y.PHYSICS_READY)}createGround(e=50){if(!this.world)return;const t=.5,i=A.RigidBodyDesc.fixed().setTranslation(0,-.05-t,0),s=this.world.createRigidBody(i),n=A.ColliderDesc.cuboid(e,t,e);n.setActiveEvents(A.ActiveEvents.COLLISION_EVENTS);const o=this.world.createCollider(n,s);this.registerDebugBody("ground",s,o)}createCuboid(e,t,i,s,n,o=!1){if(!this.world)return;const r=o?A.RigidBodyDesc.fixed().setTranslation(s.x,s.y,s.z):A.RigidBodyDesc.dynamic().setTranslation(s.x,s.y,s.z),a=this.world.createRigidBody(r),h=A.ColliderDesc.cuboid(e,t,i).setFriction(1).setRestitution(0).setActiveEvents(A.ActiveEvents.COLLISION_EVENTS),l=this.world.createCollider(h,a);return this.registerDebugBody(`cuboid-${this.nextPhysicsId++}`,a,l),a}createHexagon(e,t,i,s,n=!1){if(!this.world)return;const o=n?A.RigidBodyDesc.fixed():A.RigidBodyDesc.dynamic();o.setTranslation(i.x,i.y,i.z);const r=this.world.createRigidBody(o),a=t/2,h=A.ColliderDesc.cylinder(a,e).setFriction(1).setRestitution(0).setActiveEvents(A.ActiveEvents.COLLISION_EVENTS),l=this.world.createCollider(h,r);return this.registerDebugBody(`hexagon-${this.nextPhysicsId++}`,r,l),r}createGrabbable(e,t,i,s,n,o){if(!this.world)return null;const r=e||`grabbable-${this.nextPhysicsId++}`;let a=n;if(!a){const E=o?.x??t/2,b=o?.y??t/2,v=o?.z??t/2,P=new j(E*2,b*2,v*2),_=new G({color:8947848}),L=new R(P,_);L.position.set(i.x,i.y,i.z),a=new tt(L,r),this.context.managers.render&&a.addToScene(this.context.managers.render.scene)}const h=o?.x??t/2,l=o?.y??t/2,c=o?.z??t/2,u=A.RigidBodyDesc.dynamic().setTranslation(i.x,i.y,i.z).setLinearDamping(.5).setAngularDamping(.5).setCanSleep(!0).setSleeping(!0),p=this.world.createRigidBody(u),f=A.ColliderDesc.cuboid(h,l,c).setRestitution(.2).setFriction(.7).setActiveEvents(A.ActiveEvents.COLLISION_EVENTS),g=this.world.createCollider(f,p),m=new qs(this.context,r,this.context.isHost,p,{grabbable:!0,spawnPosition:i,view:a,grabRadius:Math.max(h,l,c)});m.setPendingReleaseHoldWindow(this.pendingReleaseMinHoldMs,this.pendingReleaseMaxHoldMs),this.registerDebugBody(r,p,g,m);const S=this.context.managers.entity;return S&&S.addEntity(m),m}step(e){if(this.world){for(this.touchQueryHitsThisFrame=0,this.accumulator+=e;this.accumulator>=this.fixedTimeStep;)this.world.step(this.eventQueue||void 0),this.drainCollisionEvents(),this.accumulator-=this.fixedTimeStep;this.processTouchOwnershipLeases(),this.processProximityTouchLeases(),this.updateTouchQueryMetrics(e)}}getDebugBodies(){const e=[];for(const t of this.debugBodies.values())e.push({id:t.id,rigidBody:t.rigidBody,colliders:t.colliders,ownerId:t.getOwnerId?t.getOwnerId():null,isAuthority:t.getIsAuthority?t.getIsAuthority():!1,hasNetworkState:!!t.getOwnerId,simMode:t.getSimMode?t.getSimMode():null,snapshotBufferSize:t.getSnapshotBufferSize?t.getSnapshotBufferSize():0,lastTransferSeq:t.getLastTransferSeq?t.getLastTransferSeq():0,touchQueryHits:this.touchQueryHitsByEntityWindow.get(t.id)??0});return e}getTouchLeaseClaimIntervalMs(){return this.touchLeaseClaimIntervalMs}setTouchLeaseClaimIntervalMs(e){this.touchLeaseClaimIntervalMs=Math.max(50,Math.floor(e))}getTouchLeaseProximityDistance(){return this.touchLeaseProximityDistance}setTouchLeaseProximityDistance(e){this.touchLeaseProximityDistance=Math.max(.1,Math.min(2,e)),this.touchQueryShape=new A.Ball(this.touchLeaseProximityDistance)}getPendingReleaseMinHoldMs(){return this.pendingReleaseMinHoldMs}getPendingReleaseMaxHoldMs(){return this.pendingReleaseMaxHoldMs}setPendingReleaseHoldWindow(e,t){const i=Math.max(0,Math.floor(e)),s=Math.max(i+50,Math.floor(t));this.pendingReleaseMinHoldMs=i,this.pendingReleaseMaxHoldMs=s;const n=new Set;for(const o of this.colliderToEntity.values())n.add(o);for(const o of n)o.setPendingReleaseHoldWindow(i,s)}getTouchQueryAverageHitsPerFrame(){return this.touchQueryAvgHitsPerFrame}queryNearestPhysicsGrabbable(e,t){if(!this.world)return null;this.grabQueryShape.radius=Math.max(.01,t);let i=null,s=Number.POSITIVE_INFINITY;return this.world.intersectionsWithShape({x:e.x,y:e.y,z:e.z},this.identityRotation,this.grabQueryShape,n=>{const o=this.colliderToEntity.get(n.handle);if(!o||o.isDestroyed||!o.isGrabbable||o.heldBy)return!0;const r=n.projectPoint({x:e.x,y:e.y,z:e.z},!0);if(!r)return!0;const a=r.point.x-e.x,h=r.point.y-e.y,l=r.point.z-e.z,c=Math.sqrt(a*a+h*h+l*l);return c<s&&(s=c,i=o),!0}),!i||s>t?null:{entity:i,distance:s}}createStaticCuboidCollider(e,t,i,s){if(!this.world)return null;const n=this.world.createRigidBody(A.RigidBodyDesc.fixed().setTranslation(s.x,s.y,s.z)),o=this.world.createCollider(A.ColliderDesc.cuboid(e,t,i).setActiveEvents(A.ActiveEvents.COLLISION_EVENTS),n);return this.registerDebugBody(`static-cuboid-${this.nextPhysicsId++}`,n,o),o}registerDebugBody(e,t,i,s){const n=t.handle,o=this.debugBodies.get(n);if(o){o.colliders.push(i),s&&this.colliderToEntity.set(i.handle,s);return}const r={id:e,rigidBody:t,colliders:[i]};s&&(r.getOwnerId=()=>s.ownerId,r.getIsAuthority=()=>s.isAuthority,r.getSimMode=()=>s.getSimMode?.()??null,r.getSnapshotBufferSize=()=>s.getSnapshotBufferSize?.()??0,r.getLastTransferSeq=()=>s.getLastOwnershipTransferSeq?.()??0,this.colliderToEntity.set(i.handle,s),this.entityToPrimaryCollider.has(s.id)||this.entityToPrimaryCollider.set(s.id,i)),this.debugBodies.set(n,r)}drainCollisionEvents(){this.eventQueue&&this.eventQueue.drainCollisionEvents((e,t,i)=>{const s=this.colliderToEntity.get(e),n=this.colliderToEntity.get(t);if(s&&n){const P=this.contactKey(e,t);i?this.activePropContacts.set(P,{a:e,b:t}):this.activePropContacts.delete(P)}if(!i||(w.emit(y.PHYSICS_COLLISION_STARTED,{handleA:e,handleB:t,entityAId:s?.id||null,entityBId:n?.id||null}),!(s?.type===F.PHYSICS_PROP||n?.type===F.PHYSICS_PROP)||!this.world))return;const r=this.nowMs(),a=this.contactKey(e,t),h=this.lastCollisionSoundAtByPair.get(a)??0;if(r-h<this.collisionSoundCooldownMs)return;this.lastCollisionSoundAtByPair.set(a,r);const l=this.world.getCollider(e),c=this.world.getCollider(t);if(!l&&!c)return;const u=l?.parent(),p=c?.parent(),f=u?.linvel(),g=p?.linvel(),m=f?Math.hypot(f.x,f.y,f.z):0,S=g?Math.hypot(g.x,g.y,g.z):0,E=Math.abs(m-S),b=Math.max(E,m,S),v=Math.min(.35,Math.max(.05,b*.09));v<=.05||w.emit(y.ENTITY_COLLIDED,{intensity:v})})}processTouchOwnershipLeases(){if(this.context.isHost)return;const e=this.context.localPlayer?.id;if(!e)return;const t=this.nowMs();for(const[i,s]of this.activePropContacts.entries()){const n=this.colliderToEntity.get(s.a),o=this.colliderToEntity.get(s.b);if(!n||!o||n.isDestroyed||o.isDestroyed){this.activePropContacts.delete(i);continue}n.heldBy===e&&n.isAuthority&&this.tryClaimTouchLease(o,t,e),o.heldBy===e&&o.isAuthority&&this.tryClaimTouchLease(n,t,e)}}processProximityTouchLeases(){if(this.context.isHost||!this.world)return;const e=this.context.localPlayer?.id;if(!e)return;const t=[],i=new Set;for(const n of this.context.managers.entity.entities.values()){if(n.type!==F.PHYSICS_PROP)continue;const o=n;o.heldBy===e&&o.isAuthority&&!i.has(o.id)&&(i.add(o.id),t.push(o))}if(t.length===0)return;const s=this.nowMs();for(const n of t){const o=n.rigidBody.translation(),r=this.entityToPrimaryCollider.get(n.id);this.world.intersectionsWithShape({x:o.x,y:o.y,z:o.z},this.identityRotation,this.touchQueryShape,a=>{const h=this.colliderToEntity.get(a.handle);return!h||h===n||(this.touchQueryHitsThisFrame++,this.touchQueryHitsByEntityAccum.set(h.id,(this.touchQueryHitsByEntityAccum.get(h.id)??0)+1),this.tryClaimTouchLease(h,s,e)),!0},void 0,void 0,r)}}tryClaimTouchLease(e,t,i){if(e.isDestroyed||e.heldBy&&e.heldBy!==i||e.ownerId===i||e.isAuthority)return;const s=this.lastTouchClaimAtMsByEntity.get(e.id)??0;t-s<this.touchLeaseClaimIntervalMs||(this.lastTouchClaimAtMsByEntity.set(e.id,t),e.requestOwnership())}contactKey(e,t){return e<t?`${e}:${t}`:`${t}:${e}`}nowMs(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}updateTouchQueryMetrics(e){this.touchQueryHitsAccum+=this.touchQueryHitsThisFrame,this.touchQueryFramesAccum+=1,this.touchQueryAvgAccumulatorSec+=e,!(this.touchQueryAvgAccumulatorSec<1)&&(this.touchQueryAvgHitsPerFrame=this.touchQueryFramesAccum>0?this.touchQueryHitsAccum/this.touchQueryFramesAccum:0,this.touchQueryHitsByEntityWindow=new Map(this.touchQueryHitsByEntityAccum),this.touchQueryHitsAccum=0,this.touchQueryFramesAccum=0,this.touchQueryAvgAccumulatorSec=0,this.touchQueryHitsByEntityAccum.clear())}}class ve{static createButton(e,t={}){const i=document.createElement("button");function s(){let h=null;async function l(p){p.addEventListener("end",c),await e.xr.setSession(p),i.textContent="EXIT VR",h=p}function c(){h.removeEventListener("end",c),i.textContent="ENTER VR",h=null}i.style.display="",i.style.cursor="pointer",i.style.left="calc(50% - 50px)",i.style.width="100px",i.textContent="ENTER VR";const u={...t,optionalFeatures:["local-floor","bounded-floor","layers",...t.optionalFeatures||[]]};i.onmouseenter=function(){i.style.opacity="1.0"},i.onmouseleave=function(){i.style.opacity="0.5"},i.onclick=function(){h===null?navigator.xr.requestSession("immersive-vr",u).then(l):(h.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",u).then(l).catch(p=>{console.warn(p)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession("immersive-vr",u).then(l).catch(p=>{console.warn(p)})}function n(){i.style.display="",i.style.cursor="auto",i.style.left="calc(50% - 75px)",i.style.width="150px",i.onmouseenter=null,i.onmouseleave=null,i.onclick=null}function o(){n(),i.textContent="VR NOT SUPPORTED"}function r(h){n(),console.warn("Exception when trying to call xr.isSessionSupported",h),i.textContent="VR NOT ALLOWED"}function a(h){h.style.position="absolute",h.style.bottom="20px",h.style.padding="12px 6px",h.style.border="1px solid #fff",h.style.borderRadius="4px",h.style.background="rgba(0,0,0,0.1)",h.style.color="#fff",h.style.font="normal 13px sans-serif",h.style.textAlign="center",h.style.opacity="0.5",h.style.outline="none",h.style.zIndex="999"}if("xr"in navigator)return i.id="VRButton",i.style.display="none",a(i),navigator.xr.isSessionSupported("immersive-vr").then(function(h){h?s():o(),h&&ve.xrSessionIsGranted&&i.click()}).catch(r),i;{const h=document.createElement("a");return window.isSecureContext===!1?(h.href=document.location.href.replace(/^http:/,"https:"),h.innerHTML="WEBXR NEEDS HTTPS"):(h.href="https://immersiveweb.dev/",h.innerHTML="WEBXR NOT AVAILABLE"),h.style.left="calc(50% - 90px)",h.style.width="180px",h.style.textDecoration="none",a(h),h}}static registerSessionGrantedListener(){if(typeof navigator<"u"&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",()=>{ve.xrSessionIsGranted=!0})}}}ve.xrSessionIsGranted=!1;ve.registerSessionGrantedListener();class Us{constructor(e){if(this.context=e,this.container=document.getElementById("app"),this.scene=new ai,this.scene.background=new D(656412),this.interactionGroup=new z,this.scene.add(this.interactionGroup),this.camera=new Ft(75,window.innerWidth/window.innerHeight,.1,1e3),this.cameraGroup=new z,this.cameraGroup.add(this.camera),this.scene.add(this.cameraGroup),this.camera.layers.disable(1),this.cameraGroup.position.set(0,0,0),this.audioListener=new hi,this.camera.add(this.audioListener),this.renderer=new li({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!1,this.renderer.xr.enabled=!0,this.renderer.xr.addEventListener("sessionstart",()=>{console.log("[RenderManager] XR Session Started"),w.emit(y.XR_SESSION_STARTED)}),this.renderer.xr.addEventListener("sessionend",()=>{console.log("[RenderManager] XR Session Ended"),w.emit(y.XR_SESSION_ENDED)}),this.renderer.domElement.style.display="block",this.container.appendChild(this.renderer.domElement),this.camera.position.set(0,0,0),this.camera.rotation.set(0,0,0),this.cameraGroup.position.set(0,0,0),this.setupControllers(),Yi){const t=ve.createButton(this.renderer,{requiredFeatures:["local-floor"],optionalFeatures:["hand-tracking"]});this.container.appendChild(t)}window.addEventListener("resize",this.onWindowResize.bind(this),!1),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.onWindowResize(),100)},!1),this.onWindowResize()}container;scene;camera;cameraGroup;interactionGroup;audioListener;renderer;isMenuMode=!0;menuRotation=0;controllers=[];controllerGrips=[];hands=[];raycaster=new Ut;switchToPlayerView(){this.isMenuMode=!1}update(e,t){if(this.isMenuMode){this.menuRotation+=e*.1;const i=18;this.cameraGroup.position.set(Math.cos(this.menuRotation)*i,12,Math.sin(this.menuRotation)*i),this.camera.lookAt(0,0,0);return}if(t&&t.type==="LOCAL_PLAYER"){const i=t;if(this.cameraGroup.position.set(i.xrOrigin.position.x,i.xrOrigin.position.y,i.xrOrigin.position.z),this.cameraGroup.quaternion.set(i.xrOrigin.quaternion.x,i.xrOrigin.quaternion.y,i.xrOrigin.quaternion.z,i.xrOrigin.quaternion.w),!this.isXRPresenting()){const s=new x(i.headState.position.x,i.headState.position.y,i.headState.position.z),n=new C(i.headState.quaternion.x,i.headState.quaternion.y,i.headState.quaternion.z,i.headState.quaternion.w);this.camera.position.copy(this.cameraGroup.worldToLocal(s));const o=new C;this.cameraGroup.getWorldQuaternion(o),this.camera.quaternion.copy(o.invert().multiply(n))}}}setupControllers(){this.controllers=[],this.controllerGrips=[],this.hands=[];for(let e=0;e<4;e++){const t=this.renderer.xr.getController(e);this.cameraGroup.add(t),this.controllers.push(t);const i=this.renderer.xr.getControllerGrip(e);this.cameraGroup.add(i),this.controllerGrips.push(i);const s=this.renderer.xr.getHand(e);this.cameraGroup.add(s),this.hands.push(s),t.addEventListener("selectstart",()=>{console.log(`Controller ${e} triggered selectstart`)})}}add(e){this.scene.add(e)}remove(e){this.scene.remove(e)}isXRPresenting(){return this.renderer.xr.isPresenting}getXRSession(){return this.renderer.xr.getSession()}getXRFrame(){return this.renderer.xr.getFrame()}getXRReferenceSpace(){return this.renderer.xr.getReferenceSpace()}getXRController(e){return this.controllers[e]}getXRControllerGrip(e){return this.controllerGrips[e]}getXRHand(e){return this.hands[e]}onWindowResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}render(){this.renderer.render(this.scene,this.camera)}setAnimationLoop(e){this.renderer.setAnimationLoop(e)}raycast(e,t,i){return this.raycaster.set(e,t),this.raycaster.far=i,this.raycaster.camera=this.camera,this.raycaster.intersectObjects(this.interactionGroup.children,!0)}}class Ee extends dt{constructor(e,t,i,s){super(e,t,i,s),this.context=e,this.headState={position:{x:0,y:Ee.DEFAULT_HEAD_HEIGHT,z:0},quaternion:{x:0,y:0,z:0,w:1}}}static DEFAULT_HEAD_HEIGHT=1.7;name="";headHeight=Ee.DEFAULT_HEAD_HEIGHT;headState;micEnabled=!0;audioLevel=0;isMuted=!1}class pt{id;name;isAlwaysActive;isActive=!1;constructor(e,t,{isAlwaysActive:i=!1}={}){this.id=e,this.name=t,this.isAlwaysActive=i}activate(e){this.isActive=!0}deactivate(e){this.isActive=!1}getNetworkState(){return null}setNetworkState(e){}destroy(){}}class Vs extends pt{speed=5;turnSpeed=.002;pitch=0;yaw=0;_inputListenersAttached=!1;_wasSnapTurnPressed=!1;_currentMove={x:0,y:0};_handlers=[];constructor(){super("movement","Movement",{isAlwaysActive:!0})}setYaw(e){this.yaw=e}activate(e){super.activate(e);const t=n=>{this._currentMove=n.direction},i=n=>{this.yaw-=n.delta.x*this.turnSpeed*15},s=n=>{this.applyVRTurn(e,n.angle,e.context.managers)};w.on(y.INTENT_MOVE,t),w.on(y.INTENT_LOOK,i),w.on(y.INTENT_VR_SNAP_TURN,s),this._handlers.push({event:y.INTENT_MOVE,handler:t}),this._handlers.push({event:y.INTENT_LOOK,handler:i}),this._handlers.push({event:y.INTENT_VR_SNAP_TURN,handler:s})}deactivate(e){super.deactivate(e);for(const{event:t,handler:i}of this._handlers)w.off(t,i);this._handlers=[],this._currentMove={x:0,y:0}}_attachInputListeners(e,t){const i=document.getElementById("app");i&&i.addEventListener("click",()=>{const s=t.render;s&&!s.isXRPresenting()&&i.requestPointerLock()})}update(e,t,i){const s=i.render;this._inputListenersAttached||(this._attachInputListeners(t,i),this._inputListenersAttached=!0),s.isXRPresenting()||(t.xrOrigin.quaternion={x:0,y:Math.sin(this.yaw/2),z:0,w:Math.cos(this.yaw/2)});const o=new x(this._currentMove.x,0,this._currentMove.y);if(o.lengthSq()>0){const r=Math.min(1,o.length());r>0&&o.divideScalar(r);const a=new C;s.camera.getWorldQuaternion(a);const h=new le().setFromQuaternion(a,"YXZ");o.applyEuler(new le(0,h.y,0,"YXZ")),o.multiplyScalar(r),t.xrOrigin.position.x+=o.x*this.speed*e,t.xrOrigin.position.y+=o.y*this.speed*e,t.xrOrigin.position.z+=o.z*this.speed*e}t._lastMoveVector={x:o.x,y:o.y,z:o.z}}applyVRTurn(e,t,i){const s=i.render,n=new x;s.camera.getWorldPosition(n);const o=new x(n.x,0,n.z),r=new x(e.xrOrigin.position.x,e.xrOrigin.position.y,e.xrOrigin.position.z);r.sub(o),r.applyAxisAngle(new x(0,1,0),t),r.add(o),e.xrOrigin.position={x:r.x,y:r.y,z:r.z},this.yaw+=t,e.xrOrigin.quaternion={x:0,y:Math.sin(this.yaw/2),z:0,w:Math.cos(this.yaw/2)}}}function it(d){return d&&typeof d.isGrabbable=="boolean"&&d.isGrabbable===!0&&typeof d.onGrab=="function"&&typeof d.onRelease=="function"}function ke(d){return d&&typeof d.onHoverEnter=="function"&&typeof d.onHoverExit=="function"&&typeof d.onInteraction=="function"}class ft extends pt{grabRadius=.05;heldObjects=new Map;history=new Map;highlightedEntities={left:null,right:null};_handlers=[];constructor(){super("grab","Grab",{isAlwaysActive:!0})}activate(e){super.activate(e);const t=o=>{if(this.heldObjects.has(o.hand))return;const r=e.context.managers.tracking.getState().hands[o.hand];let a=this.highlightedEntities[o.hand];if(r.active){const h=r.pointerPose.position||r.pose.position,l=new x(h.x,h.y,h.z);a=e.context.managers.interaction.findNearestInteractable(l,this.grabRadius)?.interactable||null}if(it(a)){const h=r.pointerPose.position||r.pose.position,l=r.pointerPose.quaternion||r.pose.quaternion,c=new x(h.x,h.y,h.z),u=new C(l.x,l.y,l.z,l.w),p=new me().compose(c,u,new x(1,1,1));let f=a.view?.mesh;!f&&a.mesh&&(f=a.mesh);const g=new x,m=new C;if(f){f.updateMatrixWorld(!0);const S=new x,E=new C;f.getWorldPosition(S),f.getWorldQuaternion(E);const b=new me().compose(S,E,new x(1,1,1));p.clone().invert().multiply(b).decompose(g,m,new x)}a.onGrab(e.id,o.hand),this.heldObjects.set(o.hand,{entity:a,offsetPos:g,offsetQuat:m}),this.history.set(o.hand,[])}},i=o=>{const r=this.heldObjects.get(o.hand);if(r){const a=this._computeThrowVelocity(o.hand);r.entity.onRelease(a),this.heldObjects.delete(o.hand),this.history.delete(o.hand)}},s=o=>{const r=this.heldObjects.get(o.hand);r&&ke(r.entity)&&r.entity.onInteraction({type:"trigger",phase:"start",value:o.value||1,playerId:e.id,hand:o.hand})},n=o=>{const r=this.heldObjects.get(o.hand);r&&ke(r.entity)&&r.entity.onInteraction({type:"trigger",phase:"end",value:0,playerId:e.id,hand:o.hand})};w.on(y.INTENT_GRAB_START,t),w.on(y.INTENT_GRAB_END,i),w.on(y.INTENT_INTERACT_START,s),w.on(y.INTENT_INTERACT_END,n),this._handlers.push({event:y.INTENT_GRAB_START,handler:t}),this._handlers.push({event:y.INTENT_GRAB_END,handler:i}),this._handlers.push({event:y.INTENT_INTERACT_START,handler:s}),this._handlers.push({event:y.INTENT_INTERACT_END,handler:n})}deactivate(e){super.deactivate(e);for(const{event:t,handler:i}of this._handlers)w.off(t,i);this._handlers=[],this.heldObjects.clear(),this.history.clear(),this._updateHighlight(e.id,"left",null),this._updateHighlight(e.id,"right",null)}update(e,t,i){const s=i.tracking.getState().hands;for(const n of["left","right"]){const o=s[n],r=this.heldObjects.get(n);if(r){const a=o.pointerPose.position||o.pose.position,h=o.pointerPose.quaternion||o.pose.quaternion,l=new x(a.x,a.y,a.z),c=new C(h.x,h.y,h.z,h.w),u=new x().copy(r.offsetPos).applyQuaternion(c).add(l),p=new C().copy(c).multiply(r.offsetQuat);r.entity.updateGrabbedPose({position:{x:u.x,y:u.y,z:u.z},quaternion:{x:p.x,y:p.y,z:p.z,w:p.w}}),this._recordPosition(n,l),this._updateHighlight(t.id,n,null)}else{let a=null;if(new x(o.pose.position.x,o.pose.position.y,o.pose.position.z),o.active){const h=o.pointerPose.position||o.pose.position,l=new x(h.x,h.y,h.z);a=i.interaction.findNearestInteractable(l,this.grabRadius)}this._updateHighlight(t.id,n,a?.interactable||null)}}}isHoldingHand(e){return this.heldObjects.has(e)}_updateHighlight(e,t,i){const s=this.highlightedEntities[t],n=`${e}:${t}`;s!==i&&(s&&s.onHoverExit(n),i&&i.onHoverEnter(n),this.highlightedEntities[t]=i)}_recordPosition(e,t){this.history.has(e)||this.history.set(e,[]);const i=this.history.get(e);i.push({pos:t.clone(),time:performance.now()}),i.length>5&&i.shift()}_computeThrowVelocity(e){const t=this.history.get(e);if(!t||t.length<2)return new x(0,0,0);const i=t[0],s=t[t.length-1],n=(s.time-i.time)/1e3;if(n<.001)return new x(0,0,0);const o=new x().subVectors(s.pos,i.pos).divideScalar(n),r=15;return o.length()>r&&o.normalize().multiplyScalar(r),o}}class Gs extends pt{raycaster;pointerLines;pointerDots;mouseLine;mouseDot;_handlers=[];constructor(){super("ui-pointer","UI Pointer",{isAlwaysActive:!0}),this.raycaster=new Ut;const e=new J({color:65535,transparent:!0,opacity:.5}),t=new fe().setFromPoints([new x(0,0,0),new x(0,0,-1)]),i=new fe().setFromPoints([new x(0,0,0),new x(0,0,-1)]);this.pointerLines={left:new Le(t,e),right:new Le(i,e)};const s=new Vt(.005,16),n=new B({color:65535,side:Se,depthTest:!1,depthWrite:!1});this.pointerDots={left:new R(s,n),right:new R(s,n)},this.pointerLines.left.visible=!1,this.pointerLines.right.visible=!1,this.pointerDots.left.visible=!1,this.pointerDots.right.visible=!1,this.pointerDots.left.renderOrder=999,this.pointerDots.right.renderOrder=999;const o=new fe().setFromPoints([new x(0,0,0),new x(0,0,-1)]);this.mouseLine=new Le(o,e),this.mouseDot=new R(s,n),this.mouseLine.visible=!1,this.mouseDot.visible=!1,this.mouseDot.renderOrder=999}activate(e){super.activate(e);const t=e.context.managers.render;t&&(t.scene.add(this.pointerLines.left),t.scene.add(this.pointerLines.right),t.scene.add(this.pointerDots.left),t.scene.add(this.pointerDots.right),t.scene.add(this.mouseLine),t.scene.add(this.mouseDot));const i=s=>{this.handlePointerClick(e,s.hand)};w.on(y.INTENT_INTERACT_START,i),this._handlers.push({event:y.INTENT_INTERACT_START,handler:i})}deactivate(e){super.deactivate(e);for(const{event:i,handler:s}of this._handlers)w.off(i,s);this._handlers=[];const t=e.context.managers.render;t&&(t.scene.remove(this.pointerLines.left),t.scene.remove(this.pointerLines.right),t.scene.remove(this.pointerDots.left),t.scene.remove(this.pointerDots.right),t.scene.remove(this.mouseLine),t.scene.remove(this.mouseDot))}update(e,t,i){const s=i.render,n=i.vrUi;if(!s||!n||!n.tablet)return;const o=s.isXRPresenting(),r=n.tablet.mesh;if(o){this.mouseLine.visible=!1,this.mouseDot.visible=!1;const h=i.tracking.getState().hands;for(const l of["left","right"]){const c=h[l],u=this.pointerLines[l],p=this.pointerDots[l];if(c.active){const f=c.pointerPose.position||c.pose.position,g=c.pointerPose.quaternion||c.pose.quaternion,m=new x(f.x,f.y,f.z),S=new C(g.x,g.y,g.z,g.w),E=new x(0,0,-1).applyQuaternion(S);this.raycaster.set(m,E);const b=this.raycaster.intersectObject(r);if(b.length>0){const v=b[0];u.visible=!0,p.visible=!0;const P=v.distance;u.position.copy(m),u.quaternion.copy(S),u.scale.set(1,1,P),p.position.copy(v.point),p.quaternion.copy(r.quaternion),v.uv&&n.tablet.ui.onPointerMove(v.uv)}else u.visible=!1,p.visible=!1,n.tablet.ui.onPointerOut()}else u.visible=!1,p.visible=!1}}else{this.pointerLines.left.visible=!1,this.pointerLines.right.visible=!1,this.pointerDots.left.visible=!1,this.pointerDots.right.visible=!1;const h=new x,l=new x(0,0,-1);s.camera.getWorldPosition(h),s.camera.getWorldDirection(l),this.raycaster.set(h,l);const c=new C;s.camera.getWorldQuaternion(c),this.mouseDot.visible=!1;return}const a=this.raycaster.intersectObject(r);if(a.length>0){const h=a[0];this.mouseDot.visible=!0,this.mouseDot.position.copy(h.point),this.mouseDot.quaternion.copy(r.quaternion),h.uv&&n.tablet.ui.onPointerMove(h.uv)}else this.mouseDot.visible=!1,n.tablet.ui.onPointerOut()}handlePointerClick(e,t){const i=e.context.managers.render,s=e.context.managers.vrUi;if(!i||!s||!s.tablet)return;const n=i.isXRPresenting(),o=s.tablet.mesh;if(n){const a=e.context.managers.tracking.getState().hands[t];if(!a.active)return;const h=a.pointerPose.position||a.pose.position,l=a.pointerPose.quaternion||a.pose.quaternion,c=new x(h.x,h.y,h.z),u=new C(l.x,l.y,l.z,l.w),p=new x(0,0,-1).applyQuaternion(u);this.raycaster.set(c,p)}else{const a=new x,h=new x(0,0,-1);i.camera.getWorldPosition(a),i.camera.getWorldDirection(h),this.raycaster.set(a,h)}const r=this.raycaster.intersectObject(o);if(r.length>0){const a=r[0];a.uv&&s.tablet.ui.onPointerClick(a.uv)}}}class Ue{joints={};dirtyJoints=new Set;knownJoints=new Set;posTolerance=.001;quatTolerance=.005;constructor(){}setJointPose(e,t,i){let s=this.joints[e],n=!1;if(!s){this.joints[e]={position:{...t},quaternion:{...i}},this.knownJoints.add(e),this.dirtyJoints.add(e);return}this.knownJoints.add(e),(Math.abs(s.position.x-t.x)>this.posTolerance||Math.abs(s.position.y-t.y)>this.posTolerance||Math.abs(s.position.z-t.z)>this.posTolerance)&&(s.position.x=t.x,s.position.y=t.y,s.position.z=t.z,n=!0),(Math.abs(s.quaternion.x-i.x)>this.quatTolerance||Math.abs(s.quaternion.y-i.y)>this.quatTolerance||Math.abs(s.quaternion.z-i.z)>this.quatTolerance||Math.abs(s.quaternion.w-i.w)>this.quatTolerance)&&(s.quaternion.x=i.x,s.quaternion.y=i.y,s.quaternion.z=i.z,s.quaternion.w=i.w,n=!0),n&&this.dirtyJoints.add(e)}clearJoint(e){this.joints[e]&&(delete this.joints[e],this.dirtyJoints.add(e))}clearAll(){for(const e in this.joints){const t=e;this.dirtyJoints.add(t)}this.joints={}}consumeNetworkDelta(e=!1){if(!e&&this.dirtyJoints.size===0)return null;const t={},i=Array.from(e?new Set([...Object.keys(this.joints),...Array.from(this.knownJoints)]):this.dirtyJoints);let s=!1;for(const n of i){const o=n,r=this.joints[o];r?t[o]={p:[r.position.x,r.position.y,r.position.z],q:[r.quaternion.x,r.quaternion.y,r.quaternion.z,r.quaternion.w]}:e||(t[o]=null),s=!0}return this.dirtyJoints.clear(),s?t:null}applyNetworkDelta(e){if(e)for(const t in e){const i=e[t],s=t;if(i===null){delete this.joints[s],this.dirtyJoints.add(s);continue}this.joints[s]||(this.joints[s]={position:{x:0,y:0,z:0},quaternion:{x:0,y:0,z:0,w:1}}),this.knownJoints.add(s);const n=this.joints[s];i.p&&(n.position.x=i.p[0],n.position.y=i.p[1],n.position.z=i.p[2]),i.q&&(n.quaternion.x=i.q[0],n.quaternion.y=i.q[1],n.quaternion.z=i.q[2],n.quaternion.w=i.q[3]),this.dirtyJoints.add(s)}}}class Ks extends Ee{constructor(e,t,i,s,n){super(e,t||"local-player-id-temp",F.LOCAL_PLAYER,!0),this.context=e,this.isAuthority=!0,this.view=n,this.view.mesh.userData.entityId=this.id,this.view.mesh.traverse(o=>{o.userData.entityId=this.id}),this.xrOrigin={position:{...i},quaternion:{x:0,y:Math.sin(s/2),z:0,w:Math.cos(s/2)}},w.on(y.AVATAR_CONFIG_UPDATED,o=>{this.view&&this.view.setColor(o.color)}),this.initSkills(s)}view;skills=[];activeSkill=null;humanoid=new Ue;xrOrigin;_lastMoveVector={x:0,y:0,z:0};_leftControllerIndex=0;_rightControllerIndex=1;_lastProviderId=null;initSkills(e){const t=new Vs;t.setYaw(e),this.addSkill(t);const i=new ft;this.addSkill(i),this.setActiveSkill("grab");const s=new Gs;this.addSkill(s)}addSkill(e){this.skills.push(e),e.isAlwaysActive&&e.activate(this)}setActiveSkill(e){this.activeSkill&&!this.activeSkill.isAlwaysActive&&this.activeSkill.deactivate(this);const t=this.skills.find(i=>i.id===e);t&&!t.isAlwaysActive&&(t.activate(this),this.activeSkill=t)}getSkill(e){return this.skills.find(t=>t.id===e)}update(e,t){const i=this.context.managers,s=i.render,n=this.getSkill("movement");n&&(n.isAlwaysActive||n===this.activeSkill)&&n.update(e,this,i),s.cameraGroup&&(s.cameraGroup.position.set(this.xrOrigin.position.x,this.xrOrigin.position.y,this.xrOrigin.position.z),s.cameraGroup.quaternion.set(this.xrOrigin.quaternion.x,this.xrOrigin.quaternion.y,this.xrOrigin.quaternion.z,this.xrOrigin.quaternion.w),s.cameraGroup.updateMatrixWorld(!0));const o=i.tracking.getActiveProviderId();this._lastProviderId!==o&&(this._lastProviderId=o,this.humanoid.clearAll()),i.tracking.update(e,t);const r=i.tracking.getState(),a=r.head.pose.position,h=r.head.pose.quaternion,l=r.head.yaw;r.humanoidDelta&&this.humanoid.applyNetworkDelta(r.humanoidDelta),this.headState.position={...a},this.headState.quaternion={...h},this.headHeight=r.head.pose.position.y,i.animation&&i.animation.update(e);for(const c of this.skills)c.id!=="movement"&&(c.isAlwaysActive||c===this.activeSkill)&&c.update(e,this,i);this.audioLevel=i.media?i.media.getLocalVolume():0,this.micEnabled=this.context.voiceEnabled,this.view.applyState({position:{x:this.headState.position.x,y:0,z:this.headState.position.z},yaw:l,headHeight:this.headState.position.y,headQuaternion:this.headState.quaternion,humanoid:this.humanoid,name:this.name||"You",color:this.context.avatarConfig.color,isLocal:!0,audioLevel:this.audioLevel,lerpFactor:1},e)}getNetworkState(e=!1){const i=this.context.managers.tracking.getState(),s=i.head.yaw;return{id:this.id,type:F.LOCAL_PLAYER,n:this.name,p:[this.headState.position.x,0,this.headState.position.z],y:s,h:this.headState.position.y,hq:[this.headState.quaternion.x,this.headState.quaternion.y,this.headState.quaternion.z,this.headState.quaternion.w],hmd:this.humanoid.consumeNetworkDelta(e)||void 0,hm:[i.hands.left.hasJoints?1:0,i.hands.right.hasJoints?1:0],conf:{color:this.context.avatarConfig.color},mic:this.context.voiceEnabled,ownerId:this.ownerId}}applyNetworkState(e){}moveOriginTo(e,t){this.xrOrigin.position.x=e.x,this.xrOrigin.position.y=e.y,this.xrOrigin.position.z=e.z,this.xrOrigin.quaternion={x:0,y:Math.sin(t/2),z:0,w:Math.cos(t/2)}}teleportTo(e,t,i={}){const s=this.context.managers,n=i.targetSpace||"player",o=new x().copy(s.render.camera.position),a=new le().setFromQuaternion(s.render.camera.quaternion,"YXZ").y,h=t-a,l=new C().setFromAxisAngle(new x(0,1,0),h),c=o.applyQuaternion(l);this.xrOrigin.position.x=e.x-c.x,this.xrOrigin.position.z=e.z-c.z,n==="head"&&(this.xrOrigin.position.y=e.y-c.y),this.xrOrigin.quaternion={x:0,y:Math.sin(h/2),z:0,w:Math.cos(h/2)};const u=this.getSkill("movement");u&&u.setYaw(h)}destroy(){super.destroy();for(const t of this.skills)t.destroy();this.skills=[],this.activeSkill=null;const e=this.context.managers.render;e&&this.view&&(this.view.removeFromScene(e.scene),this.view.destroy())}}const Be={host:"[Host]",micOff:"[MicOff]",mutedByYou:"[Muted]",talking:"[Talk]"};function ti(d,e={}){const t=d.name||"Player",i=e.includeHost??!0,s=e.includeMuted??!0,n=e.includeTalking??!0,o=e.talkingThreshold??.01,r=[];i&&d.isHost&&r.push(Be.host);const a=d.micEnabled===!1;return s&&(a?r.push(Be.micOff):d.isMuted&&r.push(Be.mutedByYou)),n&&!a&&!d.isMuted&&typeof d.audioLevel=="number"&&d.audioLevel>o&&r.push(Be.talking),r.length===0?t:`${t} ${r.join(" ")}`}class mt extends Ee{constructor(e,t,i){super(e,t,F.REMOTE_PLAYER,!1),this.context=e,this.peerId=t,this.view=i,this.name="Player",this._onVoiceStream=o=>{const r=this.view;o&&o.peerId===this.peerId&&o.stream&&r.attachVoiceStream&&(console.log(`[RemotePlayer] Attaching voice stream for ${this.peerId}`),r.attachVoiceStream(o.stream))},w.on(y.VOICE_STREAM_RECEIVED,this._onVoiceStream);const s=this.context.managers.media?.getRemoteStream(this.peerId),n=this.view;s&&n.attachVoiceStream&&(console.log(`[RemotePlayer] Attaching cached voice stream for ${this.peerId}`),n.attachVoiceStream(s))}static HAND_FINGER_JOINTS={left:["leftThumbMetacarpal","leftThumbProximal","leftThumbDistal","leftThumbTip","leftIndexMetacarpal","leftIndexProximal","leftIndexIntermediate","leftIndexDistal","leftIndexTip","leftMiddleMetacarpal","leftMiddleProximal","leftMiddleIntermediate","leftMiddleDistal","leftMiddleTip","leftRingMetacarpal","leftRingProximal","leftRingIntermediate","leftRingDistal","leftRingTip","leftLittleMetacarpal","leftLittleProximal","leftLittleIntermediate","leftLittleDistal","leftLittleTip"],right:["rightThumbMetacarpal","rightThumbProximal","rightThumbDistal","rightThumbTip","rightIndexMetacarpal","rightIndexProximal","rightIndexIntermediate","rightIndexDistal","rightIndexTip","rightMiddleMetacarpal","rightMiddleProximal","rightMiddleIntermediate","rightMiddleDistal","rightMiddleTip","rightRingMetacarpal","rightRingProximal","rightRingIntermediate","rightRingDistal","rightRingTip","rightLittleMetacarpal","rightLittleProximal","rightLittleIntermediate","rightLittleDistal","rightLittleTip"]};peerId;view;targetPosition={x:0,y:5,z:0};targetYaw=0;avatarColor;humanoid=new Ue;lastNetworkUpdateTime=performance.now();_onVoiceStream;onAudioChunk(e){const{chunk:t,isHeader:i}=e;i&&console.log(`[RemotePlayer] Receiving audio header chunk from ${this.peerId} (${t?.length} chars)`),this.lastNetworkUpdateTime=performance.now(),this.view.attachAudioChunk({chunk:t,isHeader:i})}getNetworkState(){return null}applyNetworkState(e){let t=!1;e.n!==void 0&&e.n!==this.name&&(this.name=e.n,w.emit(y.REMOTE_NAME_UPDATED,{peerId:this.peerId,name:this.name}),t=!0),e.conf&&e.conf.color!==this.avatarColor&&(this.avatarColor=e.conf.color,t=!0),e.mic!==void 0&&this.micEnabled!==!!e.mic&&(this.micEnabled=!!e.mic,t=!0),t&&w.emit(y.PEER_STATE_UPDATED,this.peerId),e.p&&(this.targetPosition={x:e.p[0],y:e.p[1],z:e.p[2]}),e.y!==void 0&&(this.targetYaw=e.y),e.h!==void 0&&(this.headHeight=e.h),this.lastNetworkUpdateTime=performance.now(),e.hq&&(this.headState.quaternion={x:e.hq[0],y:e.hq[1],z:e.hq[2],w:e.hq[3]}),e.hm&&(e.hm[0]===0&&this.clearFingerJoints("left"),e.hm[1]===0&&this.clearFingerJoints("right")),e.hmd!==void 0&&this.humanoid.applyNetworkDelta(e.hmd)}clearFingerJoints(e){const t=mt.HAND_FINGER_JOINTS[e];for(let i=0;i<t.length;i++)this.humanoid.clearJoint(t[i])}update(e,t){if(performance.now()-this.lastNetworkUpdateTime>1e4){console.warn(`[RemotePlayer] Player ${this.peerId} timed out. Destroying.`),w.emit(y.PEER_DISCONNECTED,this.peerId),this.destroy();return}const i=15*e;this.audioLevel=this.view.getAudioLevel(),this.view.applyState({position:this.targetPosition,yaw:this.targetYaw,headHeight:this.headHeight,headQuaternion:this.headState.quaternion,humanoid:this.humanoid,name:ti({name:this.name||"Player",micEnabled:this.micEnabled,isMuted:this.isMuted},{includeHost:!1,includeTalking:!1}),color:this.avatarColor,audioLevel:this.audioLevel,lerpFactor:i},e)}destroy(){super.destroy(),w.off(y.VOICE_STREAM_RECEIVED,this._onVoiceStream);const e=this.context.managers.render;e&&this.view&&(this.view.removeFromScene(e.scene),this.view.destroy())}}class js{constructor(e,t,i){this.parent=e,this.getAnchorY=t,this.color=i}nameTag=null;currentName="";color;worldUp=new x(0,1,0);tmpCameraPos=new x;tmpTagPos=new x;setColor(e){this.color=e,this.nameTag&&this.currentName&&this.setName(this.currentName)}setName(e){if(e===this.currentName&&this.nameTag)return;if(this.currentName=e||"",!e){this.nameTag&&(this.parent.remove(this.nameTag),this.nameTag.material.map&&this.nameTag.material.map.dispose(),this.nameTag.material.dispose(),this.nameTag=null);return}const t=e.trim(),i=56,s=384,n=1024,o=128,r=n-i*2,a=30;let h=64;const l=document.createElement("canvas"),c=l.getContext("2d");for(c.textAlign="center",c.textBaseline="middle",c.font='600 64px "Inter", "Segoe UI", Arial, sans-serif';h>a&&(c.font=`600 ${h}px "Inter", "Segoe UI", Arial, sans-serif`,!(c.measureText(t).width<=r));)h-=2;const u=Math.ceil(c.measureText(t).width);l.width=Math.min(n,Math.max(s,u+i*2)),l.height=o,c.clearRect(0,0,l.width,l.height),c.fillStyle="rgba(0, 0, 0, 0.6)";const p=28;c.beginPath(),c.moveTo(p,0),c.lineTo(l.width-p,0),c.quadraticCurveTo(l.width,0,l.width,p),c.lineTo(l.width,l.height-p),c.quadraticCurveTo(l.width,l.height,l.width-p,l.height),c.lineTo(p,l.height),c.quadraticCurveTo(0,l.height,0,l.height-p),c.lineTo(0,p),c.quadraticCurveTo(0,0,p,0),c.closePath(),c.fill(),c.font=`600 ${h}px "Inter", "Segoe UI", Arial, sans-serif`,c.textAlign="center",c.textBaseline="middle";const f=typeof this.color=="string"&&this.color.startsWith("#")?this.color:"#"+this.color.toString(16).padStart(6,"0");c.fillStyle=f,c.shadowColor="rgba(0, 0, 0, 0.9)",c.shadowBlur=6,c.fillText(t,l.width/2,l.height/2);const g=new Te(l);g.generateMipmaps=!1,g.minFilter=Z,g.magFilter=Z;const m=new B({map:g,transparent:!0,depthWrite:!1}),S=.25,E=S*(l.width/l.height);if(this.nameTag){const b=this.nameTag.material.map;this.nameTag.material.dispose(),this.nameTag.material=m,this.nameTag.scale.set(E,S,1),b&&b.dispose()}else{const b=new be(1,1);this.nameTag=new R(b,m),this.nameTag.up.copy(this.worldUp),this.nameTag.scale.set(E,S,1),this.parent.add(this.nameTag)}this.updatePosition()}updatePosition(){this.nameTag&&(this.nameTag.position.y=this.getAnchorY()+.45)}faceCamera(e){!this.nameTag||!e||(e.getWorldPosition(this.tmpCameraPos),this.nameTag.getWorldPosition(this.tmpTagPos),this.tmpCameraPos.y=this.tmpTagPos.y,this.nameTag.up.copy(this.worldUp),this.nameTag.lookAt(this.tmpCameraPos))}destroy(){this.nameTag&&(this.nameTag.material.map&&this.nameTag.material.map.dispose(),this.nameTag.geometry.dispose(),this.nameTag.material.dispose(),this.parent.remove(this.nameTag),this.nameTag=null)}}class Qs{constructor(e,t,i){this.parent=e,this.isLocal=i,t&&(this.positionalAudio=new ci(t),this.positionalAudio.setRefDistance(3),this.positionalAudio.setRolloffFactor(1),this.positionalAudio.setDistanceModel("exponential"),this.parent.add(this.positionalAudio))}positionalAudio=null;audioAnalyser=null;audioElement=null;mediaSource=null;sourceBuffer=null;bufferQueue=[];manuallyMuted=!1;attachVoiceStream(e){if(this.positionalAudio)try{this.audioElement||(this.audioElement=new Audio),this.applyMutedState(),this.audioElement.srcObject=e,this.audioElement.play().catch(t=>console.warn("[VoiceAudioComponent] Auto-play blocked for hidden audio:",t)),this.positionalAudio.setMediaStreamSource(e),this.audioAnalyser=new yt(this.positionalAudio,32)}catch(t){console.error("[VoiceAudioComponent] Failed to set media stream source:",t)}}attachAudioChunk(e){if(!this.positionalAudio)return;let t,i=!1;if(typeof e=="string"?t=e:(t=e.chunk,i=e.isHeader),i&&this.mediaSource&&(console.log("[VoiceAudioComponent] New audio header received, resetting MediaSource."),this.cleanupAudioSource()),!this.mediaSource){this.mediaSource=new MediaSource,this.audioElement||(this.audioElement=new Audio,this.audioElement.autoplay=!0),this.applyMutedState();const s=URL.createObjectURL(this.mediaSource);this.audioElement.src=s,this.audioAnalyser||(console.log(`[VoiceAudioComponent] Connecting AudioElement to PositionalAudio for ${this.isLocal?"local":"remote"} player`),this.positionalAudio.setMediaElementSource(this.audioElement),this.audioAnalyser=new yt(this.positionalAudio,32)),this.mediaSource.addEventListener("sourceopen",()=>{const n=["audio/webm;codecs=opus","audio/webm","audio/mpeg"];let o="";for(const r of n)if(MediaSource.isTypeSupported(r)){o=r;break}o?(console.log(`[VoiceAudioComponent] MediaSource opened. Adding SourceBuffer for: ${o}`),this.sourceBuffer=this.mediaSource.addSourceBuffer(o),this.sourceBuffer.mode="sequence",this.sourceBuffer.addEventListener("updateend",()=>this.processAudioQueue()),this.processAudioQueue()):console.error("[VoiceAudioComponent] No supported MIME type found for MediaSource")})}try{const s=atob(t),n=new Uint8Array(s.length);for(let o=0;o<s.length;o++)n[o]=s.charCodeAt(o);this.bufferQueue.push(n),this.sourceBuffer&&!this.sourceBuffer.updating&&this.processAudioQueue()}catch{}}setMuted(e){this.manuallyMuted=e,this.applyMutedState()}getAudioLevel(){return this.audioAnalyser?this.audioAnalyser.getAverageFrequency()/128:0}destroy(){if(this.cleanupAudioSource(),this.audioElement=null,this.positionalAudio){try{this.positionalAudio.hasPlaybackControl&&this.positionalAudio.stop(),this.positionalAudio.source&&this.positionalAudio.disconnect()}catch{}this.parent.remove(this.positionalAudio),this.positionalAudio=null}}cleanupAudioSource(){if(this.mediaSource){if(this.mediaSource.readyState==="open"&&this.sourceBuffer)try{this.sourceBuffer.updating&&this.sourceBuffer.abort(),this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){console.warn("[VoiceAudioComponent] Error removing SourceBuffer:",e)}this.mediaSource=null,this.sourceBuffer=null,this.bufferQueue=[]}if(this.audioElement){this.audioElement.pause();const e=this.audioElement.src;this.audioElement.src="",this.audioElement.removeAttribute("src"),this.audioElement.load(),e&&e.startsWith("blob:")&&URL.revokeObjectURL(e)}}applyMutedState(){this.audioElement&&(this.audioElement.muted=this.manuallyMuted),this.positionalAudio&&this.positionalAudio.setVolume(this.manuallyMuted?0:1)}processAudioQueue(){if(!(this.mediaSource&&this.mediaSource.readyState==="open"&&this.sourceBuffer&&!this.sourceBuffer.updating&&this.bufferQueue.length>0))return;let t=!1;try{for(let s=0;s<this.mediaSource.sourceBuffers.length;s++)if(this.mediaSource.sourceBuffers[s]===this.sourceBuffer){t=!0;break}}catch{t=!1}if(!t){this.sourceBuffer=null;return}const i=this.bufferQueue.shift();try{this.sourceBuffer.appendBuffer(i)}catch(s){console.error("[VoiceAudioComponent] Error appending buffer:",s),this.bufferQueue=[]}if(this.audioElement){const s=this.audioElement.buffered;if(s.length>0){const n=s.end(s.length-1);n-this.audioElement.currentTime>.5&&(this.audioElement.currentTime=n-.1),this.audioElement.paused&&this.audioElement.play().catch(o=>{console.warn("[VoiceAudioComponent] Auto-play failed:",o)})}}}}class Ws{constructor(e,t,i,s){this.root=e,this.bones=t,this.visuals=i,this.onPostureUpdated=s}baseArmDir=new x(0,-1,0);leftPole=new x(-1,0,.35).normalize();rightPole=new x(1,0,.35).normalize();tmpTargetInParent=new x;tmpParentInverse=new me;tmpShoulderPos=new x;tmpToTarget=new x;tmpDir=new x;tmpPlaneNormal=new x;tmpBendDir=new x;tmpElbow=new x;tmpUpperDir=new x;tmpLowerDir=new x;tmpInvUpperQuat=new C;tmpLowerLocalDir=new x;leftIk={upperQuat:new C,lowerQuat:new C,elbowDist:.32,wristDist:.32};rightIk={upperQuat:new C,lowerQuat:new C,elbowDist:.32,wristDist:.32};updatePosture(e){const t=Math.max(.4,e-.2);this.visuals.headMesh.position.y=t;const i=t*.6;this.bones.hips.position.set(0,i,0);const s=t-i;this.bones.spine.position.set(0,0,0);const n=.62;this.bones.chest.position.set(0,s*n,0),this.bones.neck.position.set(0,s*(1-n),0),this.setupLocalCylinder(this.visuals.torso,s),this.visuals.torso.position.set(0,s*.5,0);const o=.5;this.bones.leftShoulder.position.set(-o/2,0,0),this.bones.rightShoulder.position.set(o/2,0,0),this.setupLocalCylinder(this.visuals.shoulders,o),this.visuals.shoulders.rotation.z=Math.PI/2;const r=i,a=r*.5,h=r*.5,l=.3;this.setupLocalCylinder(this.visuals.pelvis,l),this.visuals.pelvis.rotation.z=Math.PI/2,this.bones.leftUpperLeg.position.set(-l/2,0,0),this.bones.leftLowerLeg.position.set(0,-a,0),this.setupLocalCylinder(this.visuals.leftLeg,a),this.visuals.leftLeg.position.set(0,-a*.5,0),this.setupLocalCylinder(this.visuals.leftLowerLegMesh,h),this.visuals.leftLowerLegMesh.position.set(0,-h*.5,0),this.bones.leftFoot.position.set(0,-h,0),this.bones.rightUpperLeg.position.set(.15,0,0),this.bones.rightLowerLeg.position.set(0,-a,0),this.setupLocalCylinder(this.visuals.rightLeg,a),this.visuals.rightLeg.position.set(0,-a*.5,0),this.setupLocalCylinder(this.visuals.rightLowerLegMesh,h),this.visuals.rightLowerLegMesh.position.set(0,-h*.5,0),this.bones.rightFoot.position.set(0,-h,0),this.onPostureUpdated&&this.onPostureUpdated()}updateArms(e,t){this.root.updateMatrixWorld(!0),this.solveArmIK(this.bones.leftShoulder,e,!0,this.leftIk),this.bones.leftUpperArm.quaternion.copy(this.leftIk.upperQuat),this.bones.leftLowerArm.position.set(0,-this.leftIk.elbowDist,0),this.bones.leftLowerArm.quaternion.copy(this.leftIk.lowerQuat),this.setupLocalCylinder(this.visuals.leftUpperArm,this.leftIk.elbowDist),this.visuals.leftUpperArm.position.set(0,-this.leftIk.elbowDist*.5,0),this.setupLocalCylinder(this.visuals.leftForearm,this.leftIk.wristDist),this.visuals.leftForearm.position.set(0,-this.leftIk.wristDist*.5,0),this.solveArmIK(this.bones.rightShoulder,t,!1,this.rightIk),this.bones.rightUpperArm.quaternion.copy(this.rightIk.upperQuat),this.bones.rightLowerArm.position.set(0,-this.rightIk.elbowDist,0),this.bones.rightLowerArm.quaternion.copy(this.rightIk.lowerQuat),this.setupLocalCylinder(this.visuals.rightUpperArm,this.rightIk.elbowDist),this.visuals.rightUpperArm.position.set(0,-this.rightIk.elbowDist*.5,0),this.setupLocalCylinder(this.visuals.rightForearm,this.rightIk.wristDist),this.visuals.rightForearm.position.set(0,-this.rightIk.wristDist*.5,0)}solveArmIK(e,t,i,s){const n=e.parent;this.tmpTargetInParent.copy(t),n&&(this.tmpTargetInParent.applyMatrix4(this.root.matrixWorld),this.tmpParentInverse.copy(n.matrixWorld).invert(),this.tmpTargetInParent.applyMatrix4(this.tmpParentInverse));let o=.32,r=.32;this.tmpShoulderPos.copy(e.position),this.tmpToTarget.subVectors(this.tmpTargetInParent,this.tmpShoulderPos);const a=Math.max(1e-4,this.tmpToTarget.length()),h=o+r;if(a>h){const g=a/h;o*=g,r*=g}const l=o+r-1e-4,c=Math.min(a,l);this.tmpDir.copy(this.tmpToTarget).multiplyScalar(1/a),this.tmpPlaneNormal.crossVectors(this.tmpDir,i?this.leftPole:this.rightPole),this.tmpPlaneNormal.lengthSq()<1e-6&&this.tmpPlaneNormal.set(0,0,1),this.tmpPlaneNormal.normalize(),this.tmpBendDir.crossVectors(this.tmpPlaneNormal,this.tmpDir).normalize();const u=(o*o-r*r+c*c)/(2*c),p=Math.max(0,o*o-u*u),f=Math.sqrt(p);this.tmpElbow.copy(this.tmpShoulderPos).addScaledVector(this.tmpDir,u).addScaledVector(this.tmpBendDir,f),this.tmpUpperDir.subVectors(this.tmpElbow,this.tmpShoulderPos).normalize(),this.tmpLowerDir.subVectors(this.tmpTargetInParent,this.tmpElbow).normalize(),s.upperQuat.setFromUnitVectors(this.baseArmDir,this.tmpUpperDir),this.tmpInvUpperQuat.copy(s.upperQuat).invert(),this.tmpLowerLocalDir.copy(this.tmpLowerDir).applyQuaternion(this.tmpInvUpperQuat),s.lowerQuat.setFromUnitVectors(this.baseArmDir,this.tmpLowerLocalDir),s.elbowDist=o,s.wristDist=r}setupLocalCylinder(e,t){t<.001?e.scale.set(0,0,0):e.scale.set(1,t,1)}}class we{constructor(e,t,i,s){this.root=e,this.wristMeshes=t,this.handMeshes=i,this.handCylinders=s}static HAND_INDICES=[0,1,1,2,2,3,3,4,0,5,5,6,6,7,7,8,8,9,0,10,10,11,11,12,12,13,13,14,0,15,15,16,16,17,17,18,18,19,0,20,20,21,21,22,22,23,23,24];static HUM_JOINTS={left:["leftHand","leftThumbMetacarpal","leftThumbProximal","leftThumbDistal","leftThumbTip","leftIndexMetacarpal","leftIndexProximal","leftIndexIntermediate","leftIndexDistal","leftIndexTip","leftMiddleMetacarpal","leftMiddleProximal","leftMiddleIntermediate","leftMiddleDistal","leftMiddleTip","leftRingMetacarpal","leftRingProximal","leftRingIntermediate","leftRingDistal","leftRingTip","leftLittleMetacarpal","leftLittleProximal","leftLittleIntermediate","leftLittleDistal","leftLittleTip"],right:["rightHand","rightThumbMetacarpal","rightThumbProximal","rightThumbDistal","rightThumbTip","rightIndexMetacarpal","rightIndexProximal","rightIndexIntermediate","rightIndexDistal","rightIndexTip","rightMiddleMetacarpal","rightMiddleProximal","rightMiddleIntermediate","rightMiddleDistal","rightMiddleTip","rightRingMetacarpal","rightRingProximal","rightRingIntermediate","rightRingDistal","rightRingTip","rightLittleMetacarpal","rightLittleProximal","rightLittleIntermediate","rightLittleDistal","rightLittleTip"]};updateHumanoidHand(e,t,i){const s=new C;this.root.getWorldQuaternion(s).invert();const n=we.HUM_JOINTS[e];let o=!1;if(t&&t.joints){const r=n[9];o=!!t.joints[r];const a=t.joints[n[0]];if(!a||o)this.wristMeshes[e].visible=!1;else{this.wristMeshes[e].visible=!0;const h=new x(a.position.x,a.position.y,a.position.z),l=new C(a.quaternion.x,a.quaternion.y,a.quaternion.z,a.quaternion.w),c=this.root.worldToLocal(h),u=s.clone().multiply(l);this.wristMeshes[e].position.lerp(c,i),this.wristMeshes[e].quaternion.slerp(u,i)}for(let h=0;h<25;h++){const l=t.joints[n[h]];if(o&&l){this.handMeshes[e][h].visible=!0;const c=new x(l.position.x,l.position.y,l.position.z),u=new C(l.quaternion.x,l.quaternion.y,l.quaternion.z,l.quaternion.w),p=this.root.worldToLocal(c),f=s.clone().multiply(u);this.handMeshes[e][h].position.lerp(p,i),this.handMeshes[e][h].quaternion.slerp(f,i)}else this.handMeshes[e][h].visible=!1}}else{this.wristMeshes[e].visible=!1;for(let r=0;r<25;r++)this.handMeshes[e][r].visible=!1}this.updateHandSkeleton(e,o)}getWristMarkerPosition(e){return this.handMeshes[e][0].visible?this.handMeshes[e][0].position:this.wristMeshes[e].position}updateHandSkeleton(e,t){const i=this.handCylinders[e];if(!t){i.forEach(s=>s.visible=!1);return}for(let s=0;s<i.length;s++){const n=we.HAND_INDICES[s*2],o=we.HAND_INDICES[s*2+1],r=this.handMeshes[e][n],a=this.handMeshes[e][o];i[s].visible=!0,this.alignCylinder(i[s],r.position,a.position)}}alignCylinder(e,t,i){const s=new x().subVectors(i,t),n=s.length();if(n<.001){e.scale.set(0,0,0);return}e.scale.set(1,n,1),e.position.copy(t).addScaledVector(s,.5),e.quaternion.setFromUnitVectors(new x(0,1,0),s.normalize())}}class vt extends ut{constructor(e,{color:t=65535,isLocal:i=!1}={}){super(new z),this.context=e,this.color=t,this.isLocal=i;const s=new j(.01,.01,.01),n=new B;this.wristMeshes={left:new R(s,n),right:new R(s,n)},this._buildGeometry(),this.nameTagComponent=new js(this.mesh,()=>this.headMesh.position.y,this.color),this.voiceAudio=new Qs(this.headMesh,this.context.managers.render?.audioListener,this.isLocal),this.rig=new Ws(this.mesh,this.bones,{headMesh:this.headMesh,torso:this.torso,shoulders:this.shoulders,pelvis:this.pelvis,leftLeg:this.leftLeg,leftLowerLegMesh:this.leftLowerLegMesh,rightLeg:this.rightLeg,rightLowerLegMesh:this.rightLowerLegMesh,leftUpperArm:this.leftUpperArm,leftForearm:this.leftForearm,rightUpperArm:this.rightUpperArm,rightForearm:this.rightForearm},()=>this._updateNameTagPosition()),this.hands=new we(this.mesh,this.wristMeshes,this.handMeshes,this.handCylinders)}color;isLocal;headMesh;currentHeadHeight=1.7;accentMaterial;cyberMaterial;darkMaterial;featureMaterial;headOutline;leftEye;rightEye;mouth;torso;neckJoint;waistJoint;leftKnee;rightKnee;leftShoulderJoint;rightShoulderJoint;leftElbowJoint;rightElbowJoint;leftLeg;rightLeg;leftLowerLegMesh;rightLowerLegMesh;shoulders;pelvis;leftUpperArm;leftForearm;rightUpperArm;rightForearm;skeleton;bones={};handMeshes={left:[],right:[]};handCylinders={left:[],right:[]};wristMeshes;nameTagComponent;voiceAudio;rig;hands;tmpTargetPos=new x;tmpYawEuler=new le(0,0,0,"YXZ");tmpYawQuat=new C;tmpWorldHeadQuat=new C;tmpParentWorldQuat=new C;tmpLeftHandLocal=new x;tmpRightHandLocal=new x;defaultLeftTrackedTarget=new x(-.35,.95,.1);defaultRightTrackedTarget=new x(.35,.95,.1);defaultLeftRestTarget=new x(-.3,.9,0);defaultRightRestTarget=new x(.3,.9,0);attachVoiceStream(e){this.voiceAudio.attachVoiceStream(e)}attachAudioChunk(e){this.voiceAudio.attachAudioChunk(e)}setMuted(e){this.voiceAudio.setMuted(e)}getAudioLevel(){return this.voiceAudio.getAudioLevel()}_buildGeometry(){this.accentMaterial=new B({color:this.color}),this.cyberMaterial=new B({color:1710618}),this.darkMaterial=new B({color:328976}),this.featureMaterial=new B({color:0});const e=.3,t=.12,i=new j(e,e,t);i.translate(0,e/2,0);const s=this.accentMaterial,n=[this.darkMaterial,this.darkMaterial,this.darkMaterial,this.darkMaterial,this.darkMaterial,s];this.headMesh=new R(i,n);const o=new ne(i);this.headOutline=new te(o,new J({color:this.color})),this.headMesh.add(this.headOutline),this.headMesh.position.y=1.5,this.isLocal&&(this.headMesh.visible=!1),this.mesh.add(this.headMesh);const r=new oe(.02,.02,.04,8);r.rotateX(Math.PI/2),this.leftEye=new R(r,this.featureMaterial),this.leftEye.position.set(-.07,e*.7,-.06999999999999999),this.headMesh.add(this.leftEye),this.rightEye=new R(r,this.featureMaterial),this.rightEye.position.set(.07,e*.7,-.06999999999999999),this.headMesh.add(this.rightEye);const a=new oe(.015,.015,.12,8);a.rotateZ(Math.PI/2),a.rotateX(Math.PI/2),this.mouth=new R(a,this.featureMaterial),this.mouth.position.set(0,e*.3,-.06999999999999999),this.headMesh.add(this.mouth);const h=.025,l=new oe(h,h,1,6),c=new Je(.04,8,4),u=new H;u.name="hips";const p=new H;p.name="spine";const f=new H;f.name="chest";const g=new H;g.name="neck";const m=new H;m.name="head";const S=new H;S.name="leftShoulder";const E=new H;E.name="leftUpperArm";const b=new H;b.name="leftLowerArm";const v=new H;v.name="leftHand";const P=new H;P.name="rightShoulder";const _=new H;_.name="rightUpperArm";const L=new H;L.name="rightLowerArm";const K=new H;K.name="rightHand";const U=new H;U.name="leftUpperLeg";const q=new H;q.name="leftLowerLeg";const V=new H;V.name="leftFoot";const Q=new H;Q.name="rightUpperLeg";const Y=new H;Y.name="rightLowerLeg";const ce=new H;ce.name="rightFoot",u.add(p),u.add(U),u.add(Q),p.add(f),f.add(g),g.add(m),f.add(S),S.add(E),E.add(b),b.add(v),f.add(P),P.add(_),_.add(L),L.add(K),U.add(q),q.add(V),Q.add(Y),Y.add(ce),this.mesh.add(u),this.bones={hips:u,spine:p,chest:f,neck:g,head:m,leftShoulder:S,leftUpperArm:E,leftLowerArm:b,leftHand:v,rightShoulder:P,rightUpperArm:_,rightLowerArm:L,rightHand:K,leftUpperLeg:U,leftLowerLeg:q,leftFoot:V,rightUpperLeg:Q,rightLowerLeg:Y,rightFoot:ce};const Ve=Object.values(this.bones);this.skeleton=new Gt(Ve),this.torso=new R(l,this.cyberMaterial),p.add(this.torso),this.neckJoint=new R(c,this.accentMaterial),g.add(this.neckJoint),this.waistJoint=new R(c,this.accentMaterial),u.add(this.waistJoint),this.leftKnee=new R(c,this.accentMaterial),q.add(this.leftKnee),this.rightKnee=new R(c,this.accentMaterial),Y.add(this.rightKnee),this.leftShoulderJoint=new R(c,this.accentMaterial),E.add(this.leftShoulderJoint),this.rightShoulderJoint=new R(c,this.accentMaterial),_.add(this.rightShoulderJoint),this.leftElbowJoint=new R(c,this.accentMaterial),b.add(this.leftElbowJoint),this.rightElbowJoint=new R(c,this.accentMaterial),L.add(this.rightElbowJoint),this.leftLeg=new R(l,this.cyberMaterial),U.add(this.leftLeg),this.leftLowerLegMesh=new R(l,this.cyberMaterial),q.add(this.leftLowerLegMesh),this.rightLeg=new R(l,this.cyberMaterial),Q.add(this.rightLeg),this.rightLowerLegMesh=new R(l,this.cyberMaterial),Y.add(this.rightLowerLegMesh),this.shoulders=new R(l,this.cyberMaterial),f.add(this.shoulders),this.pelvis=new R(l,this.cyberMaterial),u.add(this.pelvis),this.leftUpperArm=new R(l,this.cyberMaterial),E.add(this.leftUpperArm),this.leftForearm=new R(l,this.cyberMaterial),b.add(this.leftForearm),this.rightUpperArm=new R(l,this.cyberMaterial),_.add(this.rightUpperArm),this.rightForearm=new R(l,this.cyberMaterial),L.add(this.rightForearm);const Re=new Je(.006,6,4),Ne=.003,Oe=new oe(Ne,Ne,1,4),He=new j(.03,.03,.03);this.wristMeshes={left:new R(He,this.accentMaterial),right:new R(He,this.accentMaterial)},this.mesh.add(this.wristMeshes.left),this.mesh.add(this.wristMeshes.right),this.wristMeshes.left.visible=!1,this.wristMeshes.right.visible=!1;for(let Pe=0;Pe<25;Pe++){const de=new R(Re,this.accentMaterial);de.visible=!1,this.mesh.add(de),this.handMeshes.left.push(de);const ue=new R(Re,this.accentMaterial);ue.visible=!1,this.mesh.add(ue),this.handMeshes.right.push(ue)}for(let Pe=0;Pe<we.HAND_INDICES.length/2;Pe++){const de=new R(Oe,this.cyberMaterial);de.visible=!1,this.mesh.add(de),this.handCylinders.left.push(de);const ue=new R(Oe,this.cyberMaterial);ue.visible=!1,this.mesh.add(ue),this.handCylinders.right.push(ue)}}applyState(e,t){const i=e.lerpFactor??1;if(e.position&&(this.tmpTargetPos.set(e.position.x,e.position.y,e.position.z),i<1?this.mesh.position.lerp(this.tmpTargetPos,i):this.mesh.position.copy(this.tmpTargetPos)),e.yaw!==void 0&&(i<1?(this.tmpYawEuler.set(0,e.yaw,0,"YXZ"),this.tmpYawQuat.setFromEuler(this.tmpYawEuler),this.mesh.quaternion.slerp(this.tmpYawQuat,i)):this.mesh.rotation.y=e.yaw),e.headHeight!==void 0){const s=i<1?qe.lerp(this.currentHeadHeight,e.headHeight,i):e.headHeight;this.currentHeadHeight=s,this.rig.updatePosture(s)}if(e.headQuaternion&&(this.tmpWorldHeadQuat.set(e.headQuaternion.x,e.headQuaternion.y,e.headQuaternion.z,e.headQuaternion.w),this.mesh.getWorldQuaternion(this.tmpParentWorldQuat),this.tmpParentWorldQuat.invert().multiply(this.tmpWorldHeadQuat),i<1?this.headMesh.quaternion.slerp(this.tmpParentWorldQuat,i):this.headMesh.quaternion.copy(this.tmpParentWorldQuat)),e.humanoid&&e.humanoid.joints){const s=e.humanoid.joints.leftHand,n=e.humanoid.joints.rightHand;s?(this.tmpLeftHandLocal.set(s.position.x,s.position.y,s.position.z),this.mesh.worldToLocal(this.tmpLeftHandLocal)):this.tmpLeftHandLocal.copy(this.defaultLeftTrackedTarget),n?(this.tmpRightHandLocal.set(n.position.x,n.position.y,n.position.z),this.mesh.worldToLocal(this.tmpRightHandLocal)):this.tmpRightHandLocal.copy(this.defaultRightTrackedTarget),this.rig.updateArms(this.tmpLeftHandLocal,this.tmpRightHandLocal),this.hands.updateHumanoidHand("left",e.humanoid,i),this.hands.updateHumanoidHand("right",e.humanoid,i)}else this.rig.updateArms(this.defaultLeftRestTarget,this.defaultRightRestTarget),this.hands.updateHumanoidHand("left",void 0,i),this.hands.updateHumanoidHand("right",void 0,i);if(e.audioLevel!==void 0){const s=1+e.audioLevel*10,n=.5;this.mouth.scale.y=qe.lerp(this.mouth.scale.y,s,n),e.audioLevel<.05&&(this.mouth.scale.y=1)}this._billboardNameTag(),e.name!==void 0&&this.setName(e.name),e.color!==void 0&&e.color!==this.color&&this.setColor(e.color)}_billboardNameTag(){this.nameTagComponent.faceCamera(this.context.managers.render?.camera)}setColor(e){this.color=e;const t=new D(e);this.accentMaterial.color.copy(t),this.headOutline&&this.headOutline.material.color.copy(t),this.nameTagComponent.setColor(e)}setName(e){this.nameTagComponent.setName(e)}_updateNameTagPosition(){this.nameTagComponent.updatePosition()}getLeftWristMarkerPosition(){return this.hands.getWristMarkerPosition("left")}getRightWristMarkerPosition(){return this.hands.getWristMarkerPosition("right")}destroy(){this._cleanupMesh(),this.voiceAudio.destroy(),this.mesh.traverse(e=>{const t=e;(t.isMesh||e.isLine||e.isLineSegments)&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose()))}),this.nameTagComponent.destroy()}}class Ys extends dt{constructor(e,t,i,s){super(e,t,F.PEN,i),this.context=e,this.view=s}isGrabbable=!0;hoverSources=new Set;heldBy=null;view=null;position={x:0,y:0,z:0};quaternion={x:0,y:0,z:0,w:1};isDrawing=!1;color=16777215;lastDrawPosition=null;onGrab(e,t){this.heldBy=e,this.requestOwnership(),this.context.localPlayer&&e===this.context.localPlayer.id&&(this.color=this.context.avatarConfig?.color||65535)}onRelease(e){this.heldBy=null,this.isDrawing=!1,this.lastDrawPosition=null}updateGrabbedPose(e){this.position={x:e.position.x,y:e.position.y,z:e.position.z},this.quaternion={x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w}}onHoverEnter(e){this.hoverSources.add(e),this.view&&this.view.setHighlight(!0)}onHoverExit(e){this.hoverSources.delete(e),this.view&&this.view.setHighlight(this.hoverSources.size>0)}onInteraction(e){e.type==="trigger"&&(e.phase==="start"&&!this.isDrawing?(this.isDrawing=!0,this.lastDrawPosition=null):e.phase==="end"&&(this.isDrawing=!1,this.lastDrawPosition=null))}update(e){if(this.view&&this.view.applyState({position:this.position,quaternion:this.quaternion,isDrawing:this.isDrawing,color:this.color},e),this.isDrawing&&this.isAuthority){const t=new x(0,0,-.12),i=new C(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w),s=new x(this.position.x,this.position.y,this.position.z).add(t.applyQuaternion(i));if(this.lastDrawPosition){if(s.distanceToSquared(new x(this.lastDrawPosition.x,this.lastDrawPosition.y,this.lastDrawPosition.z))>1e-4){const o={startPos:[this.lastDrawPosition.x,this.lastDrawPosition.y,this.lastDrawPosition.z],endPos:[s.x,s.y,s.z],color:this.color};this.context.managers.drawing.addSegment(o),this.lastDrawPosition={x:s.x,y:s.y,z:s.z}}}else this.lastDrawPosition={x:s.x,y:s.y,z:s.z}}}getNetworkState(e=!1){return{id:this.id,type:F.PEN,p:[this.position.x,this.position.y,this.position.z],q:[this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w],b:this.heldBy,ownerId:this.ownerId,isDrawing:this.isDrawing,c:this.color}}applyNetworkState(e){this.syncNetworkState(e),!this.isAuthority&&(e.p&&(this.position={x:e.p[0],y:e.p[1],z:e.p[2]}),e.q&&(this.quaternion={x:e.q[0],y:e.q[1],z:e.q[2],w:e.q[3]}),this.heldBy=e.b||null,this.isDrawing=!!e.isDrawing,this.color=e.c||16777215)}}class Et extends ut{material;constructor(e){const t=new z;t.userData.entityId=e;const i=new oe(.015,.01,.2,8);i.rotateX(Math.PI/2);const s=new G({color:3355443}),n=new R(i,s);n.userData.entityId=e,t.add(n);const o=new rt(.01,.04,8);o.rotateX(-Math.PI/2);const r=new R(o,new G({color:16777215}));r.userData.entityId=e,r.position.z=-.12,t.add(r),super(t),this.material=s}applyState(e,t){this.mesh.position.set(e.position.x,e.position.y,e.position.z),this.mesh.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w);const i=this.mesh.children[1];e.isDrawing?(i.material.emissive.set(e.color),i.material.emissiveIntensity=1):i.material.emissive.set(0)}setHighlight(e){this.material.emissive.set(e?4473924:0)}destroy(){this._cleanupMesh(),this.mesh.traverse(e=>{e instanceof R&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())})}}class je{constructor(e){this.entityId=e,this.mesh=new at,this.mesh.userData.entityId=this.entityId}mesh;applyState(e,t){}setHighlight(e){}setColor(e){}setName(e){}attachVoiceStream(e){}attachAudioChunk(e){}getAudioLevel(){return 0}addToScene(e){}addToInteractionGroup(e){}removeFromScene(e){}destroy(){}}const $=class ${static register(e,t){this.registry.set(e,t)}static spawn(e,t,i,s){const n=this.registry.get(t);return n?n(e,i,s):(console.warn(`[EntityFactory] No creator registered for type: ${t}`),null)}static createPlayer(e,t,{isLocal:i,spawnPos:s,spawnYaw:n,color:o}){const r=e.managers.render,a=r?new vt(e,{color:o||(i?e.avatarConfig.color:16711935),isLocal:i}):new je(t),h=i?new Ks(e,t,s,n,a):new mt(e,t,a);return r&&a instanceof vt&&(a.addToScene(r.scene),a.addToInteractionGroup(r.interactionGroup)),h}static createGrabbable(e,t,i,s,n,o){const r=e.managers,a=r.render,h=a&&n?new tt(n,t):new je(t);return r.physics?(a&&h instanceof tt&&(h.addToScene(a.scene),h.addToInteractionGroup(a.interactionGroup)),r.physics.createGrabbable(t,i,s,n,h,o)):(console.error("[EntityFactory] Physics manager not found"),null)}static createPen(e,t,i){const s=e.managers.render,n=s?new Et(t):new je(t),o=new Ys(e,t,!!i.isAuthority,n);return i.position&&o.updateGrabbedPose({position:i.position,quaternion:i.quaternion||{x:0,y:0,z:0,w:1}}),s&&n instanceof Et&&(n.addToScene(s.scene),n.addToInteractionGroup(s.interactionGroup)),o}};gt($,"registry",new Map),$.register("LOCAL_PLAYER",(e,t,i)=>$.createPlayer(e,t,{...i,isLocal:!0})),$.register("REMOTE_PLAYER",(e,t,i)=>$.createPlayer(e,t,{...i,isLocal:!1})),$.register("PHYSICS_PROP",(e,t,i)=>$.createGrabbable(e,t,i.size||.12,i.position||{x:0,y:0,z:0},i.mesh,i.halfExtents)),$.register("PEN",(e,t,i)=>$.createPen(e,t,i));let he=$;class Xs{constructor(e){this.context=e,w.on(y.PEER_DISCONNECTED,t=>this.onPeerDisconnected(t))}isInitialized=!1;init(e){const t=this.context.managers;console.log("[PlayerManager] Initializing Local Player with ID:",e);let i=0;this.context.isHost||(t.room&&t.room.assignedSpawnIndex!==void 0?i=t.room.assignedSpawnIndex:t.network&&(i=t.network.connections.size));const s=t.room.getSpawnPoint?t.room.getSpawnPoint(i):{position:{x:0,y:0,z:0},yaw:0};this.context.localPlayer=he.createPlayer(this.context,e,{isLocal:!0,spawnPos:s.position||{x:0,y:0,z:0},spawnYaw:s.yaw||0,color:this.context.avatarConfig.color||65535}),this.context.localPlayer&&(this.context.localPlayer.name=this.context.playerName||"Player"),t.animation.setLocalPlayer(this.context.localPlayer,t),t.entity.addEntity(this.context.localPlayer),this.isInitialized=!0}onPeerDisconnected(e){const t=this.context.managers,i=t.entity.getEntity(e);if(!i){console.warn(`[PlayerManager] Received disconnect for unknown peer: ${e}`);return}console.log(`[PlayerManager] Removing entity for disconnected peer: ${e} (type: ${i.type})`);const s=i.name,n=i.type==="REMOTE_PLAYER"||i.type==="LOCAL_PLAYER";t.entity.removeEntity(e),n&&t.hud&&t.hud.showNotification(`${s||"A player"} left the hangout.`)}}class Js{constructor(e){this.context=e,this.entities=new Map}entities;defaultType="unknown";discover(e,t,i={}){if(this.entities.has(e))return this.entities.get(e);console.log(`[EntityManager] Discovering new ${t} with ID: ${e}`);const s=he.spawn(this.context,t,e,i);return s?(this.addEntity(s),w.emit(y.ENTITY_DISCOVERED,e),s):null}addEntity(e){if(!e||!e.id){console.error("[EntityManager] Attempted to add invalid entity:",e);return}if(this.entities.has(e.id)){const t=this.entities.get(e.id);if(t===e)return;console.warn(`[EntityManager] Entity with ID ${e.id} already exists. Overwriting.`),t?.destroy()}this.entities.set(e.id,e)}removeEntity(e){const t=this.entities.get(e);t&&(t.destroy(),this.entities.delete(e))}updateEntityId(e,t){if(e===t)return;const i=this.entities.get(e);i&&(this.entities.delete(e),i.id=t,this.entities.set(t,i))}getEntity(e){return this.entities.get(e)}update(e,t){for(const[i,s]of this.entities.entries())if(s.isDestroyed)this.entities.delete(i);else try{s.update(e,t)}catch(n){console.error(`[EntityManager] Error updating entity ${i}:`,n)}}getAuthoritativeStates(e=!1){const t=[];for(const i of this.entities.values()){const s=i;if(i.isAuthority&&!i.isDestroyed&&s.getNetworkState){const n=s.getNetworkState(e);n&&t.push({id:i.id,type:i.type,state:n})}}return t}getWorldSnapshot(){const e=[];for(const t of this.entities.values()){const i=t;if(!t.isDestroyed&&i.getNetworkState){const s=i.getNetworkState(!0);s&&e.push({id:t.id,type:t.type,state:s})}}return e}}class $s{constructor(e){this.context=e,w.on(y.ENTITY_DISCOVERED,t=>{const i=this.context.managers.network,s=i?.peer?.id||i?.localPeerId,n=!!i?.connections?.has(t);this.localStream&&i&&i.peer&&n&&t!==s&&!this.calls.has(t)&&this.callPeer(t)}),w.on(y.PEER_DISCONNECTED,t=>{const i=this.calls.get(t);i&&(i.close(),this.calls.delete(t)),this.remoteStreams.delete(t)}),w.on(y.PEER_JOINED_ROOM,t=>{this.context.isLocalServer&&this.localStream&&this.websocket&&(console.log(`[MediaManager] Peer ${t} joined. Restarting MediaRecorder to send fresh header.`),this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),this.startRecording())})}localStream=null;calls=new Map;remoteStreams=new Map;audioContext=null;localSource=null;localAnalyser=null;freqData=null;websocket=null;mediaRecorder=null;async ensureMicrophoneEnabled(){return this.localStream?(this.syncVoiceState(),!0):this.enableMicrophone()}async setMicrophoneEnabled(e){return e?this.ensureMicrophoneEnabled():(this.stopMicrophone(),!1)}isMicrophoneEnabled(){return!!this.localStream}getRemoteStream(e){return this.remoteStreams.get(e)||null}async enableMicrophone(){try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),console.log("[MediaManager] Microphone access granted.");const e=this.context.managers.render;e&&e.audioListener&&(this.audioContext=e.audioListener.context),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)),this.audioContext.state==="suspended"&&await this.audioContext.resume(),this.localSource=this.audioContext.createMediaStreamSource(this.localStream),this.localAnalyser=this.audioContext.createAnalyser(),this.localAnalyser.fftSize=32,this.localSource.connect(this.localAnalyser),this.freqData=new Uint8Array(this.localAnalyser.frequencyBinCount);for(const t of this.calls.values())t.close();if(this.calls.clear(),this.context.isLocalServer)this.startRecording();else{const t=this.context.managers.network;if(t&&t.peer)for(const i of t.connections.keys())this.calls.has(i)||this.callPeer(i)}return this.syncVoiceState(),!0}catch(e){return console.error("[MediaManager] Failed to get microphone:",e),this.syncVoiceState(),!1}}stopMicrophone(){if(this.localStream){this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null,this.localSource&&(this.localSource.disconnect(),this.localSource=null),this.localAnalyser=null,this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),console.log("[MediaManager] Microphone stopped.");for(const e of this.calls.values())e.close();this.calls.clear()}this.syncVoiceState()}bindPeer(e){e.on("call",t=>{console.log(`[MediaManager] Incoming voice call from ${t.peer}`),this.localStream?t.answer(this.localStream):t.answer(),this.setupCall(t)})}bindWebSocket(e){this.websocket=e,this.localStream&&(this.mediaRecorder&&(console.log("[MediaManager] WebSocket rebound, restarting MediaRecorder for fresh header."),this.mediaRecorder.stop(),this.mediaRecorder=null),this.startRecording())}startRecording(){if(!this.localStream||!this.websocket||this.mediaRecorder)return;let e="audio/webm;codecs=opus";typeof MediaRecorder<"u"&&!MediaRecorder.isTypeSupported(e)&&(e="audio/webm");try{let t=!0;this.mediaRecorder=new MediaRecorder(this.localStream,{mimeType:e,bitsPerSecond:16e3}),this.mediaRecorder.ondataavailable=async i=>{if(i.data.size>0&&this.websocket&&this.websocket.readyState===WebSocket.OPEN){const s=await i.data.arrayBuffer(),n=new Uint8Array(s);let o="";for(let h=0;h<n.byteLength;h++)o+=String.fromCharCode(n[h]);const r=btoa(o),a=t;t=!1,a&&console.log(`[MediaManager] Sending audio header chunk (${r.length} chars)`),this.websocket.send(JSON.stringify({type:M.AUDIO_CHUNK,payload:{chunk:r,isHeader:a}}))}},this.mediaRecorder.start(100),console.log("[MediaManager] Started MediaRecorder via WebSocket chunking at 100ms")}catch(t){console.error("[MediaManager] MediaRecorder error:",t)}}callPeer(e){const t=this.context.managers.network,i=t?t.peer:null,s=i?.id||t?.localPeerId;if(!i||!this.localStream||!t?.connections.has(e)||e===s||this.calls.has(e))return;console.log(`[MediaManager] Calling ${e} for voice chat...`);const n=i.call(e,this.localStream);this.setupCall(n)}setupCall(e){const t=this.calls.get(e.peer);t&&t!==e&&t.close(),this.calls.set(e.peer,e),e.on("stream",i=>{console.log(`[MediaManager] Received voice stream from ${e.peer}`),this.remoteStreams.set(e.peer,i);const s={peerId:e.peer,stream:i};w.emit(y.VOICE_STREAM_RECEIVED,s)}),e.on("close",()=>{this.calls.get(e.peer)===e&&this.calls.delete(e.peer)}),e.on("error",i=>{console.error(`[MediaManager] Call error with ${e.peer}:`,i),this.calls.get(e.peer)===e&&this.calls.delete(e.peer)})}getLocalVolume(){if(!this.localAnalyser||!this.freqData)return 0;this.localAnalyser.getByteFrequencyData(this.freqData);let e=0;for(let i=0;i<this.freqData.length;i++)e+=this.freqData[i];const t=e/this.freqData.length;return Math.min(1,t/128)}syncVoiceState(){const e=!!this.localStream;this.context.voiceEnabled!==e&&(this.context.voiceEnabled=e),w.emit(y.VOICE_STATE_UPDATED)}}const T={colors:{primary:"#00ffff",secondary:"#ff00ff",accent:"#ffaa00",danger:"#ef4444",dangerHover:"#dc2626",background:"#0a041c",panelBg:"rgba(10, 4, 28, 0.85)",panelBgHover:"rgba(20, 10, 50, 0.95)",text:"#f8fafc",textMuted:"#64748b"},typography:{fontFamily:"'Inter', system-ui, -apple-system, sans-serif",sizes:{title:54,body:28,small:20}},styling:{borderWidth:2,cornerRadius:12}};function k(d,e="normal"){return`${e} ${d}px ${T.typography.fontFamily}`}class Zs{constructor(e){this.context=e,this.group=new z,this.group.raycast=()=>{},this.noteCanvas=document.createElement("canvas"),this.noteContext=this.noteCanvas.getContext("2d"),this.noteCanvas.width=1024,this.noteCanvas.height=256,this.init(),w.on(y.REMOTE_NAME_UPDATED,t=>{this.showNotification(`${t.name} joined the hangout!`)}),w.on(y.SYSTEM_NOTIFICATION,t=>{console.log("[HUDManager] System Notification received:",t),this.showNotification(`SYSTEM: ${t}`,8e3)})}group;noteCanvas;noteContext;noteTexture=null;noteMesh=null;crosshair=null;opacity=.8;notifications=[];maxNotifications=1;init(){const e=new be(1,.25);this.noteTexture=new Te(this.noteCanvas);const t=new B({map:this.noteTexture,transparent:!0,opacity:this.opacity,depthTest:!1,depthWrite:!1});this.noteMesh=new R(e,t),this.noteMesh.renderOrder=1e3,this.noteMesh.position.set(0,-.35,-1),this.group.add(this.noteMesh);const i=new di(.002,.004,32),s=new B({color:65535,transparent:!0,opacity:.5,depthTest:!1,depthWrite:!1});this.crosshair=new R(i,s),this.crosshair.position.set(0,0,-1),this.group.add(this.crosshair),this.draw()}showNotification(e,t=4e3){this.notifications.push({text:e,startTime:performance.now(),duration:t}),this.notifications.length>this.maxNotifications&&this.notifications.shift(),this.draw()}update(e){const t=performance.now();if(this.crosshair){const s=this.context.managers.render?.isXRPresenting();this.crosshair.visible=!s}const i=this.notifications.length;this.notifications=this.notifications.filter(s=>t-s.startTime<s.duration),(this.notifications.length!==i||this.notifications.length>0)&&this.draw()}draw(){const e=this.noteContext;if(e.clearRect(0,0,this.noteCanvas.width,this.noteCanvas.height),this.notifications.length>0){const t=this.notifications[0],i=performance.now()-t.startTime,s=Math.min(1,1-i/t.duration*1.5);s>0&&(e.save(),e.globalAlpha=s,e.textAlign="center",e.fillStyle=T.colors.panelBg,this.drawRoundedRect(e,this.noteCanvas.width/2-300,this.noteCanvas.height/2-30,600,60,T.styling.cornerRadius*2),e.fill(),e.strokeStyle=T.colors.secondary,e.lineWidth=T.styling.borderWidth,e.stroke(),e.font=`bold 28px ${T.typography.fontFamily}`,e.fillStyle=T.colors.text,e.fillText(t.text,this.noteCanvas.width/2,this.noteCanvas.height/2+8),e.restore())}this.noteTexture&&(this.noteTexture.needsUpdate=!0)}drawRoundedRect(e,t,i,s,n,o){e.beginPath(),e.moveTo(t+o,i),e.lineTo(t+s-o,i),e.quadraticCurveTo(t+s,i,t+s,i+o),e.lineTo(t+s,i+n-o),e.quadraticCurveTo(t+s,i+n,t+s-o,i+n),e.lineTo(t+o,i+n),e.quadraticCurveTo(t,i+n,t,i+n-o),e.lineTo(t,i+o),e.quadraticCurveTo(t,i,t+o,i),e.closePath()}}class en{keyboard={};justPressed=new Set;constructor(){this.init()}init(){window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();this.keyboard[t]||this.justPressed.add(t),this.keyboard[t]=!0}),window.addEventListener("keyup",e=>{this.keyboard[e.key.toLowerCase()]=!1}),window.addEventListener("mousedown",e=>{e.button===0?(this.keyboard.primary_action=!0,this.justPressed.add("primary_action")):e.button===2&&(this.keyboard.secondary_action=!0,this.justPressed.add("secondary_action"))}),window.addEventListener("mouseup",e=>{e.button===0?this.keyboard.primary_action=!1:e.button===2&&(this.keyboard.secondary_action=!1)}),window.addEventListener("contextmenu",e=>{e.preventDefault()})}isKeyPressed(e){return this.justPressed.has(e)}isKeyDown(e){return!!this.keyboard[e]}clearJustPressed(){this.justPressed.clear()}}class tn{constructor(e){this.context=e}move={x:0,y:0};look={x:0,y:0};buttons={};lastButtons={};navIndex=-1;navCooldown=0;deadzone=ye.DEADZONE;poll(e){const i=(navigator.getGamepads?navigator.getGamepads():[])[0];if(!i){this.move={x:0,y:0},this.look={x:0,y:0};return}const s=n=>Math.abs(n)<this.deadzone?0:n;this.move.x=s(i.axes[0]||0),this.move.y=s(i.axes[1]||0),this.look.x=s(i.axes[2]||0),this.look.y=s(i.axes[3]||0),this.lastButtons={...this.buttons},i.buttons.forEach((n,o)=>{this.buttons[o]=n.pressed}),this.handleUINavigation(e,i)}handleUINavigation(e,t){const i=this.context.managers.ui;if(!i||!i.overlay||i.overlay.style.display==="none"){this.navIndex=-1;return}const s=i.getNavigableElements();if(s.length===0)return;if(this.navIndex===-1&&Math.abs(this.move.y)>.5&&(this.navIndex=0,this.updateUIFocus(s)),this.navCooldown>0){this.navCooldown-=e;return}let n=!1;if(this.move.y<-.6?(this.navIndex--,n=!0):this.move.y>.6&&(this.navIndex++,n=!0),n&&(this.navIndex<0&&(this.navIndex=s.length-1),this.navIndex>=s.length&&(this.navIndex=0),this.updateUIFocus(s),this.navCooldown=.25),this.buttons[0]&&!this.lastButtons[0]){const o=s[this.navIndex];o&&o.click()}}updateUIFocus(e){e.forEach((t,i)=>{i===this.navIndex?(t.classList.add("gamepad-focus"),t.focus()):t.classList.remove("gamepad-focus")})}}class Mt{container;options;isActive=!1;basePos={x:0,y:0};currentPos={x:0,y:0};vector={x:0,y:0};base;stick;constructor(e,t={}){this.container=document.getElementById(e),this.options={radius:60,innerRadius:30,...t},this.container&&(this.initDOM(),this.initEvents())}initDOM(){this.base=document.createElement("div"),this.base.style.position="absolute",this.base.style.width=`${this.options.radius*2}px`,this.base.style.height=`${this.options.radius*2}px`,this.base.style.borderRadius="50%",this.base.style.border="2px solid rgba(0, 255, 255, 0.3)",this.base.style.background="rgba(0, 255, 255, 0.05)",this.base.style.pointerEvents="none",this.base.style.display="block",this.base.style.opacity="0.2",this.base.style.transition="opacity 0.2s",this.container.appendChild(this.base),this.base.style.left="50%",this.base.style.top="50%",this.base.style.transform="translate(-50%, -50%)",this.stick=document.createElement("div"),this.stick.style.position="absolute",this.stick.style.width=`${this.options.innerRadius*2}px`,this.stick.style.height=`${this.options.innerRadius*2}px`,this.stick.style.borderRadius="50%",this.stick.style.background="cyan",this.stick.style.boxShadow="0 0 10px cyan",this.stick.style.pointerEvents="none",this.stick.style.opacity="0.7",this.base.appendChild(this.stick),this.stick.style.left="50%",this.stick.style.top="50%",this.stick.style.transform="translate(-50%, -50%)"}initEvents(){this.container&&(this.container.addEventListener("touchstart",e=>this.handleStart(e),{passive:!1}),this.container.addEventListener("touchmove",e=>this.handleMove(e),{passive:!1}),this.container.addEventListener("touchend",e=>this.handleEnd(e),{passive:!1}),this.container.addEventListener("touchcancel",e=>this.handleEnd(e),{passive:!1}))}handleStart(e){e.preventDefault();const t=e.targetTouches[0],i=this.container.getBoundingClientRect();this.isActive=!0,this.basePos={x:t.clientX-i.left,y:t.clientY-i.top},this.currentPos={x:this.basePos.x,y:this.basePos.y},this.base.style.opacity="1",this.base.style.left=`${this.basePos.x-this.options.radius}px`,this.base.style.top=`${this.basePos.y-this.options.radius}px`,this.base.style.transform="none",this.updateVector()}handleMove(e){if(!this.isActive)return;e.preventDefault();const t=e.targetTouches[0],i=this.container.getBoundingClientRect();this.currentPos={x:t.clientX-i.left,y:t.clientY-i.top};const s=this.currentPos.x-this.basePos.x,n=this.currentPos.y-this.basePos.y;if(Math.sqrt(s*s+n*n)>this.options.radius){const h=Math.atan2(n,s);this.currentPos.x=this.basePos.x+Math.cos(h)*this.options.radius,this.currentPos.y=this.basePos.y+Math.sin(h)*this.options.radius}const r=this.currentPos.x-this.basePos.x,a=this.currentPos.y-this.basePos.y;this.stick.style.transform=`translate(calc(-50% + ${r}px), calc(-50% + ${a}px))`,this.updateVector()}handleEnd(e){this.isActive=!1,this.base.style.opacity="0.2",this.base.style.left="50%",this.base.style.top="50%",this.base.style.transform="translate(-50%, -50%)",this.stick.style.transform="translate(-50%, -50%)",this.vector={x:0,y:0}}updateVector(){const e=this.currentPos.x-this.basePos.x,t=this.currentPos.y-this.basePos.y;this.vector.x=e/this.options.radius,this.vector.y=t/this.options.radius}getVector(){return this.vector}}class sn{move=null;look=null;init(){const e=document.getElementById("joystick-left"),t=document.getElementById("joystick-right");e&&(e.innerHTML=""),t&&(t.innerHTML=""),this.move=new Mt("joystick-left"),this.look=new Mt("joystick-right")}getMoveVector(){return this.move?this.move.getVector():{x:0,y:0}}getLookVector(){return this.look?this.look.getVector():{x:0,y:0}}}class nn{constructor(e){this.context=e}isMobileMode=ct;mobilePressing=!1;mobileLatched=!1;phase={left:"idle",right:"idle"};reach={left:0,right:0};maxReach=1.45;extendSpeed=5.4;retractSpeed=6.5;update(e,t,i,s,n){const o=this.context.managers.render;if(!o||o.isXRPresenting()||this.context.isMenuOpen||t){this.cancelAll(),this.applyReachAll();return}this.updateHand(e,"left",s),this.updateHand(e,"right",this.mobilePressing||this.mobileLatched||i||n),this.applyReachAll()}beginMobileAction(){if(this.isMobileMode){if(this.mobileLatched||this.phase.right==="holding"){this.mobileLatched=!1,this.mobilePressing=!1,this.isHolding("right")&&w.emit(y.INTENT_GRAB_END,{hand:"right"}),this.phase.right="retracting";return}this.mobilePressing=!0,(this.phase.right==="idle"||this.phase.right==="retracting")&&(this.phase.right="extending")}}endMobileAction(){this.isMobileMode&&(this.mobileLatched||(this.mobilePressing=!1,this.phase.right==="extending"&&!this.isHolding("right")&&(this.phase.right="retracting")))}hasMobilePrimaryAction(){return this.isMobileMode&&!this.context.managers.render.isXRPresenting()&&!this.context.isMenuOpen}getMobilePrimaryActionLabel(){return this.hasMobilePrimaryAction()?this.mobileLatched||this.phase.right==="holding"?"Drop":"Grab":null}isActive(){return this.phase.left==="extending"||this.phase.left==="holding"||this.phase.right==="extending"||this.phase.right==="holding"}cancelAll(){this.cancelHand("left"),this.cancelHand("right"),this.mobilePressing=!1,this.mobileLatched=!1}cancelHand(e){this.phase[e]==="holding"&&this.isHolding(e)&&w.emit(y.INTENT_GRAB_END,{hand:e}),this.phase[e]="idle",this.reach[e]=0}updateHand(e,t,i){const s=this.isHolding(t);i?(this.phase[t]==="idle"||this.phase[t]==="retracting")&&(this.phase[t]=s?"holding":"extending"):(this.phase[t]==="extending"||this.phase[t]==="holding")&&(s&&w.emit(y.INTENT_GRAB_END,{hand:t}),this.phase[t]="retracting",t==="right"&&this.mobilePressing&&(this.mobilePressing=!1)),this.phase[t]==="extending"?s?(t==="right"&&this.mobilePressing&&(this.mobileLatched=!0,this.mobilePressing=!1),this.phase[t]="holding"):(w.emit(y.INTENT_GRAB_START,{hand:t}),this.reach[t]=Math.min(this.maxReach,this.reach[t]+this.extendSpeed*e)):this.phase[t]==="holding"?this.isHolding(t)||(this.phase[t]=i?"extending":"retracting"):this.phase[t]==="retracting"&&(this.reach[t]=Math.max(0,this.reach[t]-this.retractSpeed*e),this.reach[t]<=.001&&(this.reach[t]=0,this.phase[t]="idle"))}applyReachAll(){this.context.managers.tracking.setAssistedReach("left",this.reach.left>0?this.reach.left:null),this.context.managers.tracking.setAssistedReach("right",this.reach.right>0?this.reach.right:null)}isHolding(e){const t=this.context.localPlayer?.getSkill("grab");return t instanceof ft?t.isHoldingHand(e):!1}}class on{constructor(e){this.context=e}isMobileMode=ct;mobileLatched=!1;directHeld=!1;update(e){this.directHeld=e,this.mobileLatched&&!this.hasMobileSecondaryAction()&&(this.mobileLatched=!1,w.emit(y.INTENT_INTERACT_END,{hand:"right"}))}isInteractionHeld(){return this.directHeld||this.mobileLatched}hasMobileSecondaryAction(){return!this.context.isMenuOpen&&!!this.context.managers.render&&!this.context.managers.render.isXRPresenting()&&this.isHoldingHand("right")}getMobileSecondaryActionLabel(){return this.hasMobileSecondaryAction()?this.mobileLatched?"Stop":"Use":null}toggleMobileSecondaryAction(){if(this.mobileLatched){this.mobileLatched=!1,w.emit(y.INTENT_INTERACT_END,{hand:"right"});return}this.hasMobileSecondaryAction()&&(this.mobileLatched=!0,w.emit(y.INTENT_INTERACT_START,{hand:"right",value:1}))}isHoldingHand(e){const t=this.context.localPlayer?.getSkill("grab");return t instanceof ft?t.isHoldingHand(e):!1}}class rn{constructor(e){this.context=e}move={x:0,y:0};turn=0;poll(e){this.move={x:0,y:0},this.turn=0;const t=this.context.managers.render;if(!t||!t.isXRPresenting())return;const i=t.getXRSession();if(i){for(const s of i.inputSources)if(s.gamepad){const n=s.gamepad.axes;if(s.handedness==="left"){const o=n.length>=4?n[2]:n[0],r=n.length>=4?n[3]:n[1];Math.abs(o)>.1&&(this.move.x+=o),Math.abs(r)>.1&&(this.move.y+=r)}else if(s.handedness==="right"){const o=n.length>=4?n[2]:n[0];Math.abs(o)>.1&&(this.turn=o)}}}}}class Rt{static WRIST=0;static THUMB_TIP=4;static INDEX_TIP=9;static FINGER_TIPS=[9,14,19,24];static getPinchDistance(e){if(!e.active||!e.hasJoints||e.joints.length<10)return null;const t=e.joints[this.THUMB_TIP].pose.position,i=e.joints[this.INDEX_TIP].pose.position;if(t.x===0&&t.y===0&&t.z===0&&i.x===0&&i.y===0&&i.z===0)return null;const s=t.x-i.x,n=t.y-i.y,o=t.z-i.z;return Math.sqrt(s*s+n*n+o*o)}static getFistCurlCount(e,t=.095){if(!e.active||!e.hasJoints||e.joints.length<25)return 0;const i=e.joints[this.WRIST].pose.position;if(i.x===0&&i.y===0&&i.z===0)return 0;let s=0;const n=t*t;for(const o of this.FINGER_TIPS){const r=e.joints[o].pose.position,a=r.x-i.x,h=r.y-i.y,l=r.z-i.z;a*a+h*h+l*l<n&&s++}return s}}class an{constructor(e){this.context=e,this.keyboard=new en,this.gamepad=new tn(e),this.mobileJoystick=new sn,this.nonVRReachAssist=new nn(e),this.nonVRInteraction=new on(e),this.xrInput=new rn(e),this._initMouseLook(),this._initWheel()}keyboard;gamepad;mobileJoystick;nonVRReachAssist;nonVRInteraction;xrInput;_wheelDelta=0;_initWheel(){window.addEventListener("wheel",e=>{const t=this.context.managers.render;t&&!t.isXRPresenting()&&(this._wheelDelta+=-e.deltaY*.001)},{passive:!0})}_initMouseLook(){document.addEventListener("mousemove",e=>{const t=this.context.managers.render,i=document.getElementById("app");document.pointerLockElement===i&&t&&!t.isXRPresenting()&&w.emit(y.INTENT_LOOK,{delta:{x:e.movementX/15,y:e.movementY/15}})})}initMobileJoysticks(){this.mobileJoystick.init()}getMobilePrimaryActionLabel(){return this.nonVRReachAssist.getMobilePrimaryActionLabel()}hasMobilePrimaryAction(){return this.nonVRReachAssist.hasMobilePrimaryAction()}hasMobileSecondaryAction(){return this.nonVRInteraction.hasMobileSecondaryAction()}isMobileFocusActive(){return this.nonVRReachAssist.isActive()}beginMobilePrimaryAction(){this.nonVRReachAssist.beginMobileAction()}endMobilePrimaryAction(){this.nonVRReachAssist.endMobileAction()}toggleMobileSecondaryAction(){this.nonVRInteraction.toggleMobileSecondaryAction()}getMobileSecondaryActionLabel(){return this.nonVRInteraction.getMobileSecondaryActionLabel()}isKeyPressed(e){return this.keyboard.isKeyPressed(e)}isKeyDown(e){return this.keyboard.isKeyDown(e)}clearJustPressed(){this.keyboard.clearJustPressed()}getMovementVector(){const e={x:0,y:0};this.isKeyDown("w")&&(e.y-=1),this.isKeyDown("s")&&(e.y+=1),this.isKeyDown("a")&&(e.x-=1),this.isKeyDown("d")&&(e.x+=1);const t=Math.sqrt(e.x*e.x+e.y*e.y);t>1&&(e.x/=t,e.y/=t);const i=this.mobileJoystick.getMoveVector(),s={x:e.x+i.x+this.gamepad.move.x+this.xrInput.move.x,y:e.y+i.y+this.gamepad.move.y+this.xrInput.move.y},n=Math.sqrt(s.x*s.x+s.y*s.y);return n>1&&(s.x/=n,s.y/=n),s}getLookVector(){const e={x:0,y:0};e.x+=this.gamepad.look.x*ye.GAMEPAD_LOOK_SENSITIVITY,e.y+=this.gamepad.look.y*ye.GAMEPAD_LOOK_SENSITIVITY;const t=this.mobileJoystick.getLookVector();return e.x+=t.x*ye.MOBILE_LOOK_SENSITIVITY,e.y+=t.y*ye.MOBILE_LOOK_SENSITIVITY,e}_wasSnapTurnPressed=!1;previousHandStates={left:{isSqueezing:!1,isInteracting:!1},right:{isSqueezing:!1,isInteracting:!1}};gestureLatch={left:{pinch:!1,fist:!1},right:{pinch:!1,fist:!1}};update(e,t){this.gamepad.poll(e),this.xrInput.poll(t);const i=this.context.managers,s=i.render,n=i.tracking,o=!this.context.isMenuOpen&&(this.isKeyDown("secondary_action")||!!this.gamepad.buttons[0]);if(this.nonVRInteraction.update(o),s&&!s.isXRPresenting()&&n){n.setHandActive("left",this.isKeyDown("q")),n.setHandActive("right",this.isKeyDown("e"));const c=this.isKeyDown("q")||this.isKeyDown("e");this._wheelDelta!==0&&(n.adjustReach(this._wheelDelta),this._wheelDelta=0),this.nonVRReachAssist.update(e,c,this.isKeyDown("primary_action"),!!this.gamepad.buttons[6],!!this.gamepad.buttons[7])}const r=this.context.isMenuOpen,a=r?{x:0,y:0}:this.getMovementVector();w.emit(y.INTENT_MOVE,{direction:a});const h=r?{x:0,y:0}:this.getLookVector();(h.x!==0||h.y!==0)&&w.emit(y.INTENT_LOOK,{delta:h});const l=this.xrInput.turn;if(Math.abs(l)>.5){if(!this._wasSnapTurnPressed){const c=Math.sign(l);w.emit(y.INTENT_VR_SNAP_TURN,{angle:c*(-Math.PI/4)}),this._wasSnapTurnPressed=!0}}else this._wasSnapTurnPressed=!1;this._processInteractions()}_processInteractions(){const e=this.context.managers.render,t={left:{isSqueezing:!1,isInteracting:!1,triggerValue:0},right:{isSqueezing:!1,isInteracting:!1,triggerValue:0}};if(e&&e.isXRPresenting()){const i=e.getXRSession();if(i){const n=this.context.managers.tracking.getState();for(let o=0;o<i.inputSources.length;o++){const r=i.inputSources[o];if(r.handedness!=="left"&&r.handedness!=="right")continue;const a=n.hands[r.handedness],h=this._getInteractionState(r,a);t[r.handedness]=h}}}else{const s=this.context.managers.tracking.getState(),n=s.hands.left.active,o=s.hands.right.active,r=this.isKeyDown("q")||this.isKeyDown("e"),a=this.isKeyDown("primary_action")&&r,h=this.nonVRInteraction.isInteractionHeld();n&&(t.left.isSqueezing=a,t.left.isInteracting=h,t.left.triggerValue=h?1:0),(o||!n&&!o)&&(t.right.isSqueezing=a,t.right.isInteracting=h,t.right.triggerValue=h?1:0)}for(const i of["left","right"]){const s=t[i],n=this.previousHandStates[i];s.isSqueezing&&!n.isSqueezing?w.emit(y.INTENT_GRAB_START,{hand:i}):!s.isSqueezing&&n.isSqueezing&&w.emit(y.INTENT_GRAB_END,{hand:i}),s.isInteracting&&!n.isInteracting?w.emit(y.INTENT_INTERACT_START,{hand:i,value:s.triggerValue}):!s.isInteracting&&n.isInteracting&&w.emit(y.INTENT_INTERACT_END,{hand:i}),this.previousHandStates[i].isSqueezing=s.isSqueezing,this.previousHandStates[i].isInteracting=s.isInteracting}}_getInteractionState(e,t){if(e.hand&&t&&(e.handedness==="left"||e.handedness==="right")){const o=e.handedness,r=this.gestureLatch[o],a=ye.GESTURE,h=Rt.getPinchDistance(t),l=h!==null&&h<a.PINCH_ON_DISTANCE,c=h===null||h>a.PINCH_OFF_DISTANCE;r.pinch?c&&(r.pinch=!1):l&&(r.pinch=!0);const u=Rt.getFistCurlCount(t,a.FIST_CURL_THRESHOLD),p=u>=a.FIST_ON_CURL_COUNT,f=u<=a.FIST_OFF_CURL_COUNT;return r.fist?f&&(r.fist=!1):p&&(r.fist=!0),{isSqueezing:r.fist,isInteracting:r.pinch,triggerValue:r.pinch?1:0}}(e.handedness==="left"||e.handedness==="right")&&(this.gestureLatch[e.handedness].pinch=!1,this.gestureLatch[e.handedness].fist=!1);const i=e.gamepad?.buttons[0]?.value||0,s=i>.5;return{isSqueezing:(e.gamepad?.buttons[1]?.value||0)>.5,isInteracting:s,triggerValue:i}}}class hn{scene;random;hills=null;stars=null;floor=null;grid=null;gridUniforms=null;lights=null;sun=null;constructor(e,t){this.scene=e,this.random=t}applyConfig(e){if(!(!e||!this.scene)){if(e.skyColor){this.scene.background=new D(e.skyColor);const t=e.fogNear||10,i=e.fogFar||1e3;this.scene.fog?(this.scene.fog.color.set(e.skyColor),this.scene.fog.near=t,this.scene.fog.far=i):this.scene.fog=new ui(e.skyColor,t,i)}this.hills||this.createDistantHills(),this.stars||this.createStarfield(),this.floor||this.createFloor(),this.lights||this.setupLighting(),this.sun||this.createSynthwaveSun()}}update(e){this.gridUniforms&&(this.gridUniforms.uTime.value+=e),this.stars&&(this.stars.rotation.y+=e*.01,this.stars.rotation.x+=e*.005)}createDistantHills(){this.hills=new z;const e=36,t=400,i=new pi({color:1049888,emissive:3342438,shininess:10,flatShading:!0}),s=new J({color:12255487,transparent:!0,opacity:.5});for(let n=0;n<e;n++){const o=n/e*Math.PI*2,a=Math.cos(o)<-.5?.3:1,h=(40+this.random()*120)*a,l=50+this.random()*80,c=new rt(l,h,4),u=new R(c,i);u.position.set(Math.sin(o)*t,h/2-5,Math.cos(o)*t),u.rotation.y=this.random()*Math.PI;const p=new ne(c),f=new te(p,s);u.add(f),this.hills.add(u)}this.scene.add(this.hills)}createStarfield(){const t=new fe,i=new Float32Array(5e3*3),s=new Float32Array(5e3*3),n=800;for(let r=0;r<5e3;r++){const a=2*Math.PI*this.random(),h=Math.acos(2*this.random()-1);i[r*3]=n*Math.sin(h)*Math.cos(a),i[r*3+1]=n*Math.sin(h)*Math.sin(a),i[r*3+2]=n*Math.cos(h);const l=this.random();l>.8?(s[r*3]=1,s[r*3+1]=1,s[r*3+2]=1):l>.4?(s[r*3]=.4,s[r*3+1]=1,s[r*3+2]=1):(s[r*3]=1,s[r*3+1]=.4,s[r*3+2]=1)}t.setAttribute("position",new ie(i,3)),t.setAttribute("color",new ie(s,3));const o=new Kt({size:1.8,vertexColors:!0,transparent:!0,opacity:.6,sizeAttenuation:!0});this.stars=new ht(t,o),this.scene.add(this.stars)}createFloor(){const e=new be(1e3,1e3),t=new G({color:131589,metalness:.9,roughness:.45});this.floor=new R(e,t),this.floor.rotation.x=-Math.PI/2,this.floor.position.y=-.05,this.scene.add(this.floor),this.gridUniforms={uTime:{value:0},uColor:{value:new D(65535)},uGridScale:{value:50}};const i=new $e({uniforms:this.gridUniforms,transparent:!0,side:Se,vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec2 vUv;
                uniform float uTime;
                uniform vec3 uColor;
                uniform float uGridScale;

                void main() {
                    vec2 uv = vUv * uGridScale;
                    vec2 grid = abs(fract(uv - 0.5) - 0.5) / fwidth(uv);
                    float line = min(grid.x, grid.y);
                    float mask = 1.0 - min(line, 1.0);
                    
                    float dist = distance(vUv, vec2(0.5));
                    float fade = smoothstep(0.5, 0.0, dist);
                    float pulse = 0.8 + 0.2 * sin(uTime * 2.5);
                    
                    gl_FragColor = vec4(uColor * pulse, mask * fade * 0.7);
                }
            `});this.grid=new R(new be(1e3,1e3),i),this.grid.rotation.x=-Math.PI/2,this.grid.position.y=.01,this.scene.add(this.grid)}setupLighting(){this.lights=new z,this.lights.add(new fi(16711935,.5)),this.lights.add(new mi(65535,8388736,1));const e=new jt(16755336,1.2);e.position.set(0,60,-600),this.lights.add(e),this.scene.add(this.lights)}createSynthwaveSun(){const e=new Vt(120,64),t=new $e({uniforms:{topColor:{value:new D(16744448)},bottomColor:{value:new D(16711808)}},vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,fragmentShader:`
                varying vec2 vUv;
                uniform vec3 topColor;
                uniform vec3 bottomColor;
                void main() {
                    float y = vUv.y;
                    vec3 color = mix(bottomColor, topColor, y);
                    float period = 0.08;
                    float gapWidth = 0.04 * (1.0 - y); 
                    if (mod(y, period) < gapWidth) discard;
                    gl_FragColor = vec4(color, 1.0);
                }
            `,transparent:!0,side:Se});this.sun=new R(e,t),this.sun.position.set(0,60,-600),this.sun.lookAt(0,60,0),this.scene.add(this.sun)}clearProcedural(){const e=t=>{t&&(this.scene.remove(t),t.traverse(i=>{const s=i;s.geometry&&s.geometry.dispose(),s.material&&(Array.isArray(s.material)?s.material.forEach(n=>n.dispose()):s.material.dispose())}))};e(this.hills),e(this.stars),this.hills=null,this.stars=null}}class ln{constructor(e,t,i){this.context=i,this.scene=e,this.random=t,this.context.managers.replication.registerFeature(this),this.onPhysicsCollisionStartedHandler=s=>{const n=this.drumPadFreqByHandle.get(s.handleA),o=this.drumPadFreqByHandle.get(s.handleB);if(!n&&!o)return;const r=n||o,a=n?s.entityBId:s.entityAId;if(!a)return;const h=this.context.managers.entity.getEntity(a);if(!h||h.type!=="PHYSICS_PROP")return;const l=h.rigidBody.linvel(),c=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z),u=Math.max(.08,Math.min(1,c*.22)),p=this.drumPadById.get(r.padId);this.applyDrumHit({padId:r.padId,frequency:r.frequency,intensity:u,position:p?{x:p.position.x,y:p.position.y,z:p.position.z}:void 0},!0)},w.on(y.PHYSICS_COLLISION_STARTED,this.onPhysicsCollisionStartedHandler)}featureId="feature:drumPads";scene;random;table=null;hologram=null;duckModel=null;desiredHologramVisible=!0;podest=null;decorations=null;hasSpawnedGrabbables=!1;hasSpawnedDominoes=!1;drumPads=null;drumPadMeshes=[];drumPadPositions=[];drumPadFlash=[];drumPadFreqByHandle=new Map;drumPadById=new Map;handLastPos={left:null,right:null};lastHandPadHitAtMs=new Map;onPhysicsCollisionStartedHandler=null;applyConfig(e){if(e)try{this.table||this.createTable(),this.hologram||this.createHologram(),this.podest||this.createPodest(),this.decorations||this.createDecorations(),this.drumPads||this.createDrumPads(),this.hasSpawnedGrabbables||this.createGrabbables()}catch(t){console.error("[PropManager] applyConfig crashed:",t)}}update(e){this.hologram&&(this.hologram.rotation.y+=e*1.5,this.hologram.rotation.z+=e*.5,this.hologram.position.y=.5+Math.sin(Date.now()*.002)*.05);for(let t=0;t<this.drumPadMeshes.length;t++){const s=this.drumPadMeshes[t].material,n=this.drumPadFlash[t]||0,o=.18+n*1.3;s.emissiveIntensity+=(o-s.emissiveIntensity)*.25,this.drumPadFlash[t]=Math.max(0,n-e*2.2)}this.updateHandDrumHits(e)}createTable(){const e=new z,t=new oe(2,2,.1,6),i=new G({color:1710638,emissive:4403,metalness:.9,roughness:.4});this.table=new R(t,i),this.table.position.y=1,e.add(this.table);const s=new ne(t),n=new J({color:65535}),o=new te(s,n);this.table.add(o);const r=new oe(.5,.5,.15,6),a=new B({color:65535,transparent:!0,opacity:.5}),h=new R(r,a);h.position.y=.05,this.table.add(h);const l=new oe(.3,.8,1,6),c=new B({color:657946}),u=new R(l,c);u.position.y=.5,e.add(u),this.scene&&this.scene.add(e),this.context.managers.physics&&(this.context.managers.physics.createHexagon(2,.5,{x:0,y:.8,z:0},e,!0),this.context.managers.physics.createCuboid(.4,.45,.4,{x:0,y:.45,z:0},null,!0))}createHologram(){if(!this.table||!this.scene)return;const e=new gi(.35,1),t=new B({color:65535,wireframe:!0,transparent:!0,opacity:.5});this.hologram=new R(e,t),this.hologram.position.y=.5,this.table.add(this.hologram),this.context.managers.assets.getNormalizedModel("models/duck.glb",.25).then(i=>{this.hologram&&(this.duckModel=i,this.duckModel.visible=this.desiredHologramVisible,this.hologram.add(i),this.hologram.visible=this.desiredHologramVisible)})}createPodest(){this.podest=new z;const e=new G({color:657952,metalness:.8,roughness:.5,emissive:1296}),t=new J({color:65535,transparent:!0,opacity:.3}),i=new j(1,.2,1);for(let s=-4;s<4;s++)for(let n=-4;n<4;n++){const o=this.random()*.05;if(this.scene){const r=new R(i,e);r.position.set(s+.5,.1+o,n+.5);const a=new te(new ne(i),t);r.add(a),this.podest.add(r)}this.context.managers.physics&&this.context.managers.physics.createCuboid(.5,.1,.5,{x:s+.5,y:.1+o,z:n+.5},null,!0)}this.scene&&this.scene.add(this.podest)}createDecorations(){this.decorations=new z;const e=new G({color:328981,metalness:.9,roughness:.1,emissive:4386}),t=new J({color:65535,transparent:!0,opacity:.4});for(let i=0;i<12;i++){const s=i/12*Math.PI*2,n=.5+this.random()*2.5,o=.4+this.random()*.6,r=new j(o,n,o),a=Math.sin(s)*(6+this.random()*2),h=Math.cos(s)*(6+this.random()*2);if(this.scene){const l=new R(r,e);l.position.set(a,n/2,h),l.add(new te(new ne(r),t)),this.decorations.add(l)}this.context.managers.physics&&this.context.managers.physics.createCuboid(o/2,n/2,o/2,{x:a,y:n/2,z:h},null,!0)}this.scene&&this.scene.add(this.decorations)}createGrabbables(){console.log("[PropManager] createGrabbables running..."),this.hasSpawnedGrabbables=!0;const t=he.spawn(this.context,"PEN","pen-1",{position:{x:.5,y:1.15,z:.5}});t&&this.context.managers.entity.addEntity(t);const i=[16711765,65416,5570815,16746496,52479,16776960];for(let s=0;s<6;s++){const n=s/6*Math.PI*2,o={x:Math.sin(n),y:1.15,z:Math.cos(n)};let r;if(this.scene){const h=new j(.12,.12,.12),l=new G({color:i[s],emissive:i[s],emissiveIntensity:.3,metalness:.6,roughness:.3});r=new R(h,l),r.position.set(o.x,o.y,o.z),r.add(new te(new ne(h),new J({color:16777215,transparent:!0,opacity:.4})))}const a=`grabbable-${s}`;he.createGrabbable(this.context,a,.12,o,r)}}createDominoRun(){this.hasSpawnedDominoes=!0;const e=new x(-3.5,.35,-2.6),t=24,i=.28,s={x:.03,y:.13,z:.09};for(let n=0;n<t;n++){const o=Math.floor(n/8),r=o%2===0?1:-1,a=n%8,h=e.x+r*(a*i),l=e.z+o*.45,c=r>0?0:Math.PI,u=new j(s.x*2,s.y*2,s.z*2),p=n/t*.75,f=new D().setHSL(p,1,.56),g=new G({color:f,emissive:f.clone().multiplyScalar(.55),emissiveIntensity:.3,metalness:.35,roughness:.45}),m=new R(u,g);m.position.set(h,e.y,l),m.rotation.y=c,m.add(new te(new ne(u),new J({color:16777215,transparent:!0,opacity:.35})));const S=`domino-${n}`;he.createGrabbable(this.context,S,.12,{x:h,y:e.y,z:l},m,s)}}createDrumPads(){this.drumPads=new z,this.drumPads.position.set(0,0,0);const e=[220,247,277,294,330,370,415,440],t=e.length,i=1.85,s=new x(6.2,1.1,-1.8);for(let n=0;n<t;n++){const o=n/(t-1),r=qe.lerp(-.95,.95,o),a=s.x-Math.cos(r)*i,h=s.z+Math.sin(r)*i,l=s.y,c=new D().setHSL(.72-o*.6,1,.54),u=new j(.42,.08,.42),p=new G({color:c,emissive:c.clone().multiplyScalar(.8),emissiveIntensity:.18,metalness:.2,roughness:.38}),f=new R(u,p);f.position.set(a,l,h),f.add(new te(new ne(u),new J({color:65535,transparent:!0,opacity:.45}))),this.drumPads.add(f),this.drumPadMeshes.push(f),this.drumPadPositions.push(new x(a,l,h)),this.drumPadFlash.push(0),this.drumPadById.set(`pad-${n}`,{index:n,frequency:e[n],position:new x(a,l,h)});const g=this.context.managers.physics.createStaticCuboidCollider(.21,.04,.21,{x:a,y:l,z:h});g&&this.drumPadFreqByHandle.set(g.handle,{padId:`pad-${n}`,frequency:e[n]})}this.scene&&this.scene.add(this.drumPads)}updateHandDrumHits(e){const t=this.context.managers.tracking;if(!t||typeof t.getState!="function"){this.handLastPos.left=null,this.handLastPos.right=null;return}const i=t.getState(),s=Math.max(1e-4,e),n=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now(),o=.27,r=120;for(const a of["left","right"]){if(!i.hands[a].active||this.drumPadPositions.length===0){this.handLastPos[a]=null;continue}const l=this.getAvatarHandStrikePosition(a);if(!l){this.handLastPos[a]=null;continue}const c=new x(l.x,l.y,l.z),u=this.handLastPos[a];if(this.handLastPos[a]=c,!u)continue;const p=(c.x-u.x)/s,f=(c.y-u.y)/s,g=(c.z-u.z)/s,m=Math.hypot(p,f,g);if(!(f>-.08||m<.28))for(let S=0;S<this.drumPadPositions.length;S++){const E=this.drumPadPositions[S],b=c.x-E.x,v=c.z-E.z;if(Math.hypot(b,v)>o)continue;const _=u.y>E.y+.1&&c.y<=E.y+.12,L=Math.abs(c.y-E.y)<=.14;if(!_&&!L)continue;const K=`${a}:${S}`,U=this.lastHandPadHitAtMs.get(K)??0;if(n-U<r)continue;this.lastHandPadHitAtMs.set(K,n);const q=Math.max(0,-f)+m*.22,V=Math.min(1,Math.max(.12,q*.12)),Q=this.drumPadById.get(`pad-${S}`)?.frequency??220;this.applyDrumHit({padId:`pad-${S}`,frequency:Q,intensity:V,position:{x:E.x,y:E.y,z:E.z}},!0)}}}getAvatarHandStrikePosition(e){const t=this.context.managers.tracking;if(!t||typeof t.getState!="function")return null;const i=t.getState().hands[e],s=this.context.localPlayer?.humanoid?.joints;if(i.hasJoints){const a=i.joints[9]?.pose?.position;if(a&&(a.x!==0||a.y!==0||a.z!==0))return a}const o=s?.[e==="left"?"leftHand":"rightHand"]?.position;if(o&&(o.x!==0||o.y!==0||o.z!==0))return o;const r=i.pose.position;return r&&(r.x!==0||r.y!==0||r.z!==0)?r:null}onEvent(e,t){if(e!=="hit")return;const i=t;!i||typeof i.padId!="string"||typeof i.frequency!="number"||typeof i.intensity!="number"||this.applyDrumHit(i,!1)}applyDrumHit(e,t){const i=this.parsePadIndex(e.padId);i>=0&&i<this.drumPadFlash.length&&(this.drumPadFlash[i]=Math.max(this.drumPadFlash[i],Math.min(1,e.intensity*1.2))),this.context.managers.audio?.playDrumPadHit({frequency:e.frequency,intensity:e.intensity,position:e.position}),t&&this.context.managers.replication.emitFeatureEvent(this.featureId,"hit",e)}clearProcedural(){const e=t=>{!t||!this.scene||(this.scene.remove(t),t.traverse(i=>{const s=i;s.geometry&&s.geometry.dispose(),s.material&&(Array.isArray(s.material)?s.material.forEach(n=>n.dispose()):s.material.dispose())}))};e(this.podest),e(this.decorations),e(this.drumPads),this.podest=null,this.decorations=null,this.drumPads=null,this.drumPadMeshes=[],this.drumPadPositions=[],this.drumPadFlash=[],this.drumPadFreqByHandle.clear(),this.drumPadById.clear(),this.handLastPos.left=null,this.handLastPos.right=null,this.lastHandPadHitAtMs.clear()}parsePadIndex(e){if(!e.startsWith("pad-"))return-1;const t=Number.parseInt(e.slice(4),10);return Number.isFinite(t)?t:-1}spawnGrabbableCube(e){const t=[16711765,65416,5570815,16746496,52479,16776960],i=t[Math.floor(this.random()*t.length)],s=e||{x:(this.random()-.5)*2,y:1.5,z:(this.random()-.5)*2};let n;if(this.scene){const r=new j(.12,.12,.12),a=new G({color:i,emissive:i,emissiveIntensity:.3,metalness:.6,roughness:.3});n=new R(r,a),n.position.set(s.x,s.y,s.z)}const o=`admin-spawn-${Date.now()}`;he.createGrabbable(this.context,o,.12,s,n)}getDesktopLayout(e,t){return{position:[0,1.8+e*1.5,0],scale:[1.5,1.5,1.5],billboard:!0}}setHologramVisible(e){this.desiredHologramVisible=e,this.duckModel&&(this.duckModel.visible=e),this.hologram&&(this.hologram.visible=e)}}class cn{constructor(e){this.context=e}scene=null;_seed=0;environment=null;props=null;hasGroundPhysics=!1;assignedSpawnIndex;random(){this._seed|=0,this._seed=this._seed+1831565813|0;let e=Math.imul(this._seed^this._seed>>>15,1|this._seed);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}init(e){try{this.scene=e;const t=this.random.bind(this);this.environment=new hn(e,t),this.props=new ln(e,t,this.context),this.context.managers.physics&&(this.context.managers.physics.createGround(25),this.hasGroundPhysics=!0),this.applyConfig(this.context.roomConfig)}catch(t){console.error("[RoomManager] init crashed:",t)}}applyConfig(e){!e||!this.environment||!this.props||(console.log("[RoomManager] Coordinating Room Config:",e),e.seed!==void 0&&(this._seed=e.seed),this.environment.applyConfig(e),this.props.applyConfig(e))}update(e){this.environment&&this.environment.update(e),this.props&&this.props.update(e)}updateConfig(e){const t=this.context.roomConfig.seed;e.assignedSpawnIndex!==void 0&&(this.assignedSpawnIndex=e.assignedSpawnIndex,delete e.assignedSpawnIndex),this.context.roomConfig={...this.context.roomConfig,...e},e.seed!==void 0&&e.seed!==t&&this.clearProceduralElements(),this.applyConfig(this.context.roomConfig)}clearProceduralElements(){this.environment&&this.environment.clearProcedural(),this.props&&this.props.clearProcedural()}getSpawnPoint(e){const i=e*(Math.PI/4)+Math.PI,s=Math.sin(i)*2.5,n=Math.cos(i)*2.5,o=i;return{position:new x(s,.2,n),yaw:o}}getDesktopLayout(e,t){return this.props?this.props.getDesktopLayout(e,t):{position:[0,1.5+e*.1,-2.4],billboard:!0}}toggleHologram(e){this.props&&this.props.setHologramVisible(e)}}class Ae{static playArpeggio(e,t,i="square",s=.08){if(!e)return;const n=e.currentTime;t.forEach((o,r)=>{const a=e.createOscillator(),h=e.createGain();a.type=i,a.frequency.setValueAtTime(o,n+r*s),h.gain.setValueAtTime(0,n+r*s),h.gain.linearRampToValueAtTime(.1,n+r*s+.01),h.gain.exponentialRampToValueAtTime(1e-4,n+(r+1)*s),a.connect(h),h.connect(e.destination),a.start(n+r*s),a.stop(n+(r+1)*s)})}static playCollision(e,t){if(!e||t<.05)return;const i=e.currentTime,s=e.createOscillator(),n=e.createGain();s.type="triangle";const o=100+t*300;s.frequency.setValueAtTime(o,i),s.frequency.exponentialRampToValueAtTime(40,i+.15);const r=Math.min(t*.4,.6);n.gain.setValueAtTime(r,i),n.gain.exponentialRampToValueAtTime(1e-4,i+.2),s.connect(n),n.connect(e.destination),s.start(),s.stop(i+.2)}static playUI(e,t=880){if(!e)return;const i=e.currentTime,s=e.createOscillator(),n=e.createGain();s.type="square",s.frequency.setValueAtTime(t,i),n.gain.setValueAtTime(.05,i),n.gain.exponentialRampToValueAtTime(1e-4,i+.05),s.connect(n),n.connect(e.destination),s.start(),s.stop(i+.05)}static playPadTone(e,t,i=.5,s){if(!e)return;const n=e.currentTime,o=Math.max(0,s?.distance??0),r=Math.max(-1,Math.min(1,s?.pan??0)),a=Math.max(.26,1/(1+o*.14)),h=Math.min(1,Math.max(.12,i)),l=e.createGain();l.gain.setValueAtTime(a,n);const c=typeof e.createStereoPanner=="function"?e.createStereoPanner():null;c?(c.pan.setValueAtTime(r,n),l.connect(c),c.connect(e.destination)):l.connect(e.destination);const u=e.createBiquadFilter();u.type="lowpass",u.frequency.setValueAtTime(2600,n),u.frequency.exponentialRampToValueAtTime(650+h*350,n+.28),u.Q.setValueAtTime(.95,n),u.connect(l);const p=e.createGain();p.gain.setValueAtTime(1e-4,n),p.gain.linearRampToValueAtTime(.18*h,n+.003),p.gain.exponentialRampToValueAtTime(1e-4,n+.38),p.connect(u);const f=e.createOscillator();f.type="sawtooth",f.frequency.setValueAtTime(t*.92,n),f.frequency.exponentialRampToValueAtTime(Math.max(48,t*.48),n+.26),f.connect(p),f.start(n),f.stop(n+.36);const g=e.createOscillator();g.type="square",g.frequency.setValueAtTime(t*1.5,n),g.frequency.exponentialRampToValueAtTime(Math.max(70,t*1.08),n+.2);const m=e.createGain();m.gain.setValueAtTime(1e-4,n),m.gain.linearRampToValueAtTime(.045*h,n+.003),m.gain.exponentialRampToValueAtTime(1e-4,n+.16),g.connect(m),m.connect(u),g.start(n),g.stop(n+.2);const S=e.createOscillator();S.type="sine",S.frequency.setValueAtTime(t*.33,n),S.frequency.exponentialRampToValueAtTime(Math.max(30,t*.23),n+.32);const E=e.createGain();E.gain.setValueAtTime(1e-4,n),E.gain.linearRampToValueAtTime(.16*h,n+.005),E.gain.exponentialRampToValueAtTime(1e-4,n+.36),S.connect(E),E.connect(l),S.start(n),S.stop(n+.3);const b=e.createOscillator();b.type="triangle",b.frequency.setValueAtTime(Math.min(1600,t*4.5),n),b.frequency.exponentialRampToValueAtTime(Math.max(320,t),n+.03);const v=e.createGain();v.gain.setValueAtTime(.022*h,n),v.gain.exponentialRampToValueAtTime(1e-4,n+.04),b.connect(v),v.connect(l),b.start(n),b.stop(n+.05)}static playHighFive(e,t=.6,i){if(!e)return;const s=e.currentTime,n=Math.max(-1,Math.min(1,i?.pan??0)),o=Math.max(0,i?.distance??0),r=Math.max(.35,1/(1+o*.16)),a=Math.min(1,Math.max(.2,t)),h=e.createGain();h.gain.setValueAtTime(r,s);const l=typeof e.createStereoPanner=="function"?e.createStereoPanner():null;l?(l.pan.setValueAtTime(n,s),h.connect(l),l.connect(e.destination)):h.connect(e.destination);const c=Math.floor(e.sampleRate*.22),u=e.createBuffer(1,c,e.sampleRate),p=u.getChannelData(0);for(let _=0;_<c;_++)p[_]=(Math.random()*2-1)*(1-_/c*.35);const f=e.createBufferSource();f.buffer=u;const g=e.createBiquadFilter();g.type="bandpass",g.frequency.setValueAtTime(1700+a*900,s),g.Q.setValueAtTime(.7,s);const m=e.createBiquadFilter();m.type="highpass",m.frequency.setValueAtTime(420,s);const S=e.createGain();S.gain.setValueAtTime(1e-4,s),S.gain.linearRampToValueAtTime(.22*a,s+.004),S.gain.exponentialRampToValueAtTime(1e-4,s+.19),f.connect(g),g.connect(m),m.connect(S),S.connect(h),f.start(s),f.stop(s+.21);const E=e.createOscillator();E.type="sine",E.frequency.setValueAtTime(120+a*20,s),E.frequency.exponentialRampToValueAtTime(52,s+.11);const b=e.createGain();b.gain.setValueAtTime(1e-4,s),b.gain.linearRampToValueAtTime(.16*a,s+.006),b.gain.exponentialRampToValueAtTime(1e-4,s+.14),E.connect(b),b.connect(h),E.start(s),E.stop(s+.15);const v=e.createOscillator();v.type="triangle",v.frequency.setValueAtTime(2200,s),v.frequency.exponentialRampToValueAtTime(500,s+.02);const P=e.createGain();P.gain.setValueAtTime(.05*a,s),P.gain.exponentialRampToValueAtTime(1e-4,s+.024),v.connect(P),P.connect(h),v.start(s),v.stop(s+.03)}}class dn{constructor(e){this.context=e,this.setupListeners()}ctx=null;isInitialized=!1;JOIN_FREQS=[440,554.37,659.25,880];LEAVE_FREQS=[880,659.25,554.37,440];async resume(){const e=this.context.managers.render;e&&e.audioListener&&(this.ctx=e.audioListener.context),this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx.state==="suspended"&&await this.ctx.resume(),this.isInitialized||(console.log("[AudioManager] AudioContext resumed and ready."),this.isInitialized=!0,w.emit(y.AUDIO_READY))}setupListeners(){w.on(y.ENTITY_DISCOVERED,()=>{this.isInitialized&&this.ctx&&Ae.playArpeggio(this.ctx,this.JOIN_FREQS,"square")}),w.on(y.PEER_DISCONNECTED,()=>{this.isInitialized&&this.ctx&&Ae.playArpeggio(this.ctx,this.LEAVE_FREQS,"square")}),w.on(y.ENTITY_COLLIDED,e=>{this.isInitialized&&this.ctx&&Ae.playCollision(this.ctx,e.intensity)}),w.on(y.SOCIAL_HIGH_FIVE,e=>{if(this.isInitialized&&this.ctx){const t=this.context.managers.tracking.getState().head.pose.position,i=e.position;let s=0,n=0;if(i){const o=i.x-t.x,r=i.y-t.y,a=i.z-t.z;s=Math.hypot(o,r,a),n=Math.max(-1,Math.min(1,o/5))}Ae.playHighFive(this.ctx,e.intensity,{pan:n,distance:s})}})}update(e){}playDrumPadHit(e){if(!this.isInitialized||!this.ctx)return;const t=this.context.managers.tracking.getState().head.pose.position,i=e.position;let s=0,n=0;if(i){const o=i.x-t.x,r=i.y-t.y,a=i.z-t.z;s=Math.hypot(o,r,a),n=Math.max(-1,Math.min(1,o/6))}Ae.playPadTone(this.ctx,e.frequency,e.intensity,{pan:n,distance:s})}}class un{constructor(e){this.context=e}findInteractableHitUnderRay(e,t){if(!this.context.managers.render)return null;const i=this.context.managers.render.raycast(e.origin,e.direction,t);if(i.length===0)return null;const s=this.context.managers.entity;for(const n of i){let o=n.object;for(;o;){const r=o.userData.entityId;if(r){const a=s.getEntity(r);if(a&&it(a)&&ke(a)&&!a.heldBy)return{interactable:a,distance:n.distance,point:n.point.clone()};break}o=o.parent}}return null}findInteractableUnderRay(e,t){return this.findInteractableHitUnderRay(e,t)?.interactable||null}findNearestInteractable(e,t){let i=null,s=t;const n=this.context.managers.physics?.queryNearestPhysicsGrabbable({x:e.x,y:e.y,z:e.z},t);n&&ke(n.entity)&&(i=n.entity,s=n.distance);for(const o of this.context.managers.entity.entities.values())if(o.type!==F.PHYSICS_PROP&&it(o)&&ke(o)&&!o.heldBy){const r=this.getEntityGrabRadius(o),a=o.getGrabRoots&&typeof o.getGrabRoots=="function"?o.getGrabRoots():null;if(a&&a.length>0)for(const h of a){h.updateMatrixWorld(!0),h.getWorldPosition(this.tempVec);const l=Math.max(r,this.getObjectGrabRadius(h)),c=e.distanceTo(this.tempVec)-l;c<=t&&c<s&&(s=c,i=o)}else{let h=o.view?.mesh;if(!h&&o.mesh&&(h=o.mesh),!h)continue;h.updateMatrixWorld(!0),h.getWorldPosition(this.tempVec);const l=Math.max(r,this.getObjectGrabRadius(h)),c=e.distanceTo(this.tempVec)-l;c<=t&&c<s&&(s=c,i=o)}}return i?{interactable:i,distance:s}:null}tempVec=new x;tempScale=new x;tempBox=new lt;grabRadiusCache=new Map;getEntityGrabRadius(e){const t=e.getGrabRadius?.();return typeof t=="number"&&Number.isFinite(t)?Math.max(.01,t):.05}getObjectGrabRadius(e){const t=this.grabRadiusCache.get(e.uuid);if(t!==void 0)return t;let i=.05;const s=e;if(s.isMesh&&s.geometry){const n=s.geometry;if(n.boundingSphere||n.computeBoundingSphere(),n.boundingSphere){e.getWorldScale(this.tempScale);const o=Math.max(Math.abs(this.tempScale.x),Math.abs(this.tempScale.y),Math.abs(this.tempScale.z),1e-6);i=Math.max(.01,n.boundingSphere.radius*o)}}else{this.tempBox.setFromObject(e),this.tempBox.getSize(this.tempScale);const n=Math.max(this.tempScale.x,this.tempScale.y,this.tempScale.z);Number.isFinite(n)&&n>0&&(i=n*.5)}return this.grabRadiusCache.set(e.uuid,i),i}}function Pt(d,e){if(e===yi)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),d;if(e===Ze||e===Qt){let t=d.getIndex();if(t===null){const o=[],r=d.getAttribute("position");if(r!==void 0){for(let a=0;a<r.count;a++)o.push(a);d.setIndex(o),t=d.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),d}const i=t.count-2,s=[];if(e===Ze)for(let o=1;o<=i;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=d.clone();return n.setIndex(s),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),d}function pn(d){const e=new Map,t=new Map,i=d.clone();return ii(d,i,function(s,n){e.set(n,s),t.set(s,n)}),i.traverse(function(s){if(!s.isSkinnedMesh)return;const n=s,o=e.get(s),r=o.skeleton.bones;n.skeleton=o.skeleton.clone(),n.bindMatrix.copy(o.bindMatrix),n.skeleton.bones=r.map(function(a){return t.get(a)}),n.bind(n.skeleton,n.bindMatrix)}),i}function ii(d,e,t){t(d,e);for(let i=0;i<d.children.length;i++)ii(d.children[i],e.children[i],t)}class fn extends wi{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new xn(t)}),this.register(function(t){return new Sn(t)}),this.register(function(t){return new In(t)}),this.register(function(t){return new Cn(t)}),this.register(function(t){return new _n(t)}),this.register(function(t){return new bn(t)}),this.register(function(t){return new vn(t)}),this.register(function(t){return new En(t)}),this.register(function(t){return new Mn(t)}),this.register(function(t){return new wn(t)}),this.register(function(t){return new Rn(t)}),this.register(function(t){return new Tn(t)}),this.register(function(t){return new An(t)}),this.register(function(t){return new Pn(t)}),this.register(function(t){return new gn(t)}),this.register(function(t){return new At(t,I.EXT_MESHOPT_COMPRESSION)}),this.register(function(t){return new At(t,I.KHR_MESHOPT_COMPRESSION)}),this.register(function(t){return new Ln(t)})}load(e,t,i,s){const n=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const h=De.extractUrlBase(e);o=De.resolveURL(h,this.path)}else o=De.extractUrlBase(e);this.manager.itemStart(e);const r=function(h){s?s(h):console.error(h),n.manager.itemError(e),n.manager.itemEnd(e)},a=new Wt(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(h){try{n.parse(h,o,function(l){t(l),n.manager.itemEnd(e)},r)}catch(l){r(l)}},i,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let n;const o={},r={},a=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===si){try{o[I.KHR_BINARY_GLTF]=new Dn(e)}catch(c){s&&s(c);return}n=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else n=JSON.parse(a.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const h=new jn(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const c=this.pluginCallbacks[l](h);c.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[c.name]=c,o[c.name]=!0}if(n.extensionsUsed)for(let l=0;l<n.extensionsUsed.length;++l){const c=n.extensionsUsed[l],u=n.extensionsRequired||[];switch(c){case I.KHR_MATERIALS_UNLIT:o[c]=new yn;break;case I.KHR_DRACO_MESH_COMPRESSION:o[c]=new kn(n,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[c]=new Nn;break;case I.KHR_MESH_QUANTIZATION:o[c]=new On;break;default:u.indexOf(c)>=0&&r[c]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+c+'".')}}h.setExtensions(o),h.setPlugins(r),h.parse(i,s)}parseAsync(e,t){const i=this;return new Promise(function(s,n){i.parse(e,t,s,n)})}}function mn(){let d={};return{get:function(e){return d[e]},add:function(e,t){d[e]=t},remove:function(e){delete d[e]},removeAll:function(){d={}}}}function O(d,e,t){const i=d.json.materials[e];return i.extensions&&i.extensions[t]?i.extensions[t]:null}const I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",KHR_MESHOPT_COMPRESSION:"KHR_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class gn{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const n=t.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let h;const l=new D(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],re);const c=a.range!==void 0?a.range:0;switch(a.type){case"directional":h=new jt(l),h.target.position.set(0,0,-1),h.add(h.target);break;case"point":h=new Si(l),h.distance=c;break;case"spot":h=new xi(l),h.distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,h.angle=a.spot.outerConeAngle,h.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,h.target.position.set(0,0,-1),h.add(h.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return h.position.set(0,0,0),ee(h,a),a.intensity!==void 0&&(h.intensity=a.intensity),h.name=t.createUniqueName(a.name||"light_"+e),s=Promise.resolve(h),t.cache.add(i,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],r=(n.extensions&&n.extensions[this.name]||{}).light;return r===void 0?null:this._loadLight(r).then(function(a){return i._getNodeRef(t.cache,r,a)})}}class yn{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return B}extendParams(e,t,i){const s=[];e.color=new D(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const o=n.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],re),e.opacity=o[3]}n.baseColorTexture!==void 0&&s.push(i.assignTexture(e,"map",n.baseColorTexture,ge))}return Promise.all(s)}}class wn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);return i===null||i.emissiveStrength!==void 0&&(t.emissiveIntensity=i.emissiveStrength),Promise.resolve()}}class xn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];if(i.clearcoatFactor!==void 0&&(t.clearcoat=i.clearcoatFactor),i.clearcoatTexture!==void 0&&s.push(this.parser.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),i.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),i.clearcoatRoughnessTexture!==void 0&&s.push(this.parser.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),i.clearcoatNormalTexture!==void 0&&(s.push(this.parser.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),i.clearcoatNormalTexture.scale!==void 0)){const n=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Yt(n,n)}return Promise.all(s)}}class Sn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);return i===null||(t.dispersion=i.dispersion!==void 0?i.dispersion:0),Promise.resolve()}}class Tn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];return i.iridescenceFactor!==void 0&&(t.iridescence=i.iridescenceFactor),i.iridescenceTexture!==void 0&&s.push(this.parser.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),i.iridescenceIor!==void 0&&(t.iridescenceIOR=i.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),i.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),i.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),i.iridescenceThicknessTexture!==void 0&&s.push(this.parser.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(s)}}class bn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];if(t.sheenColor=new D(0,0,0),t.sheenRoughness=0,t.sheen=1,i.sheenColorFactor!==void 0){const n=i.sheenColorFactor;t.sheenColor.setRGB(n[0],n[1],n[2],re)}return i.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=i.sheenRoughnessFactor),i.sheenColorTexture!==void 0&&s.push(this.parser.assignTexture(t,"sheenColorMap",i.sheenColorTexture,ge)),i.sheenRoughnessTexture!==void 0&&s.push(this.parser.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(s)}}class vn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];return i.transmissionFactor!==void 0&&(t.transmission=i.transmissionFactor),i.transmissionTexture!==void 0&&s.push(this.parser.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(s)}}class En{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];t.thickness=i.thicknessFactor!==void 0?i.thicknessFactor:0,i.thicknessTexture!==void 0&&s.push(this.parser.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;const n=i.attenuationColor||[1,1,1];return t.attenuationColor=new D().setRGB(n[0],n[1],n[2],re),Promise.all(s)}}class Mn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);return i===null||(t.ior=i.ior!==void 0?i.ior:1.5),Promise.resolve()}}class Rn{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];t.specularIntensity=i.specularFactor!==void 0?i.specularFactor:1,i.specularTexture!==void 0&&s.push(this.parser.assignTexture(t,"specularIntensityMap",i.specularTexture));const n=i.specularColorFactor||[1,1,1];return t.specularColor=new D().setRGB(n[0],n[1],n[2],re),i.specularColorTexture!==void 0&&s.push(this.parser.assignTexture(t,"specularColorMap",i.specularColorTexture,ge)),Promise.all(s)}}class Pn{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];return t.bumpScale=i.bumpFactor!==void 0?i.bumpFactor:1,i.bumpTexture!==void 0&&s.push(this.parser.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(s)}}class An{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){return O(this.parser,e,this.name)!==null?se:null}extendMaterialParams(e,t){const i=O(this.parser,e,this.name);if(i===null)return Promise.resolve();const s=[];return i.anisotropyStrength!==void 0&&(t.anisotropy=i.anisotropyStrength),i.anisotropyRotation!==void 0&&(t.anisotropyRotation=i.anisotropyRotation),i.anisotropyTexture!==void 0&&s.push(this.parser.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(s)}}class In{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const n=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,o)}}class Cn{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],r=s.images[o.source];let a=i.textureLoader;if(r.uri){const h=i.options.manager.getHandler(r.uri);h!==null&&(a=h)}return i.loadTextureImage(e,o.source,a)}}class _n{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],r=s.images[o.source];let a=i.textureLoader;if(r.uri){const h=i.options.manager.getHandler(r.uri);h!==null&&(a=h)}return i.loadTextureImage(e,o.source,a)}}class At{constructor(e,t){this.name=t,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const s=i.extensions[this.name],n=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(r){const a=s.byteOffset||0,h=s.byteLength||0,l=s.count,c=s.byteStride,u=new Uint8Array(r,a,h);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,c,u,s.mode,s.filter).then(function(p){return p.buffer}):o.ready.then(function(){const p=new ArrayBuffer(l*c);return o.decodeGltfBuffer(new Uint8Array(p),l,c,u,s.mode,s.filter),p})})}else return null}}class Ln{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const s=t.meshes[i.mesh];for(const h of s.primitives)if(h.mode!==X.TRIANGLES&&h.mode!==X.TRIANGLE_STRIP&&h.mode!==X.TRIANGLE_FAN&&h.mode!==void 0)return null;const o=i.extensions[this.name].attributes,r=[],a={};for(const h in o)r.push(this.parser.getDependency("accessor",o[h]).then(l=>(a[h]=l,a[h])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(h=>{const l=h.pop(),c=l.isGroup?l.children:[l],u=h[0].count,p=[];for(const f of c){const g=new me,m=new x,S=new C,E=new x(1,1,1),b=new Ti(f.geometry,f.material,u);for(let v=0;v<u;v++)a.TRANSLATION&&m.fromBufferAttribute(a.TRANSLATION,v),a.ROTATION&&S.fromBufferAttribute(a.ROTATION,v),a.SCALE&&E.fromBufferAttribute(a.SCALE,v),b.setMatrixAt(v,g.compose(m,S,E));for(const v in a)if(v==="_COLOR_0"){const P=a[v];b.instanceColor=new bi(P.array,P.itemSize,P.normalized)}else v!=="TRANSLATION"&&v!=="ROTATION"&&v!=="SCALE"&&f.geometry.setAttribute(v,a[v]);at.prototype.copy.call(b,f),this.parser.assignFinalMaterial(b),p.push(b)}return l.isGroup?(l.clear(),l.add(...p),l):p[0]}))}}const si="glTF",Ie=12,It={JSON:1313821514,BIN:5130562};class Dn{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Ie),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==si)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-Ie,n=new DataView(e,Ie);let o=0;for(;o<s;){const r=n.getUint32(o,!0);o+=4;const a=n.getUint32(o,!0);if(o+=4,a===It.JSON){const h=new Uint8Array(e,Ie+o,r);this.content=i.decode(h)}else if(a===It.BIN){const h=Ie+o;this.body=e.slice(h,h+r)}o+=r}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class kn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,n=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},h={};for(const l in o){const c=st[l]||l.toLowerCase();r[c]=o[l]}for(const l in e.attributes){const c=st[l]||l.toLowerCase();if(o[l]!==void 0){const u=i.accessors[e.attributes[l]],p=xe[u.componentType];h[c]=p.name,a[c]=u.normalized===!0}}return t.getDependency("bufferView",n).then(function(l){return new Promise(function(c,u){s.decodeDracoFile(l,function(p){for(const f in p.attributes){const g=p.attributes[f],m=a[f];m!==void 0&&(g.normalized=m)}c(p)},r,h,re,u)})})}}class Nn{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class On{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class ni extends zi{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s*3+s;for(let o=0;o!==s;o++)t[o]=i[n+o];return t}interpolate_(e,t,i,s){const n=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=r*2,h=r*3,l=s-t,c=(i-t)/l,u=c*c,p=u*c,f=e*h,g=f-h,m=-2*p+3*u,S=p-u,E=1-m,b=S-u+c;for(let v=0;v!==r;v++){const P=o[g+v+r],_=o[g+v+a]*l,L=o[f+v+r],K=o[f+v]*l;n[v]=E*P+b*_+m*L+S*K}return n}}const Hn=new C;class Bn extends ni{interpolate_(e,t,i,s){const n=super.interpolate_(e,t,i,s);return Hn.fromArray(n).normalize().toArray(n),n}}const X={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},xe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ct={9728:Jt,9729:Z,9984:Ai,9985:Pi,9986:Ri,9987:Xt},_t={33071:Ci,33648:Ii,10497:et},Qe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},st={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ae={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},zn={CUBICSPLINE:void 0,LINEAR:$t,STEP:Oi},We={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function qn(d){return d.DefaultMaterial===void 0&&(d.DefaultMaterial=new G({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Bi})),d.DefaultMaterial}function pe(d,e,t){for(const i in t.extensions)d[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function ee(d,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(d.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Fn(d,e,t){let i=!1,s=!1,n=!1;for(let h=0,l=e.length;h<l;h++){const c=e[h];if(c.POSITION!==void 0&&(i=!0),c.NORMAL!==void 0&&(s=!0),c.COLOR_0!==void 0&&(n=!0),i&&s&&n)break}if(!i&&!s&&!n)return Promise.resolve(d);const o=[],r=[],a=[];for(let h=0,l=e.length;h<l;h++){const c=e[h];if(i){const u=c.POSITION!==void 0?t.getDependency("accessor",c.POSITION):d.attributes.position;o.push(u)}if(s){const u=c.NORMAL!==void 0?t.getDependency("accessor",c.NORMAL):d.attributes.normal;r.push(u)}if(n){const u=c.COLOR_0!==void 0?t.getDependency("accessor",c.COLOR_0):d.attributes.color;a.push(u)}}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a)]).then(function(h){const l=h[0],c=h[1],u=h[2];return i&&(d.morphAttributes.position=l),s&&(d.morphAttributes.normal=c),n&&(d.morphAttributes.color=u),d.morphTargetsRelative=!0,d})}function Un(d,e){if(d.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)d.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(d.morphTargetInfluences.length===t.length){d.morphTargetDictionary={};for(let i=0,s=t.length;i<s;i++)d.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Vn(d){let e;const t=d.extensions&&d.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Ye(t.attributes):e=d.indices+":"+Ye(d.attributes)+":"+d.mode,d.targets!==void 0)for(let i=0,s=d.targets.length;i<s;i++)e+=":"+Ye(d.targets[i]);return e}function Ye(d){let e="";const t=Object.keys(d).sort();for(let i=0,s=t.length;i<s;i++)e+=t[i]+":"+d[t[i]]+";";return e}function nt(d){switch(d){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Gn(d){return d.search(/\.jpe?g($|\?)/i)>0||d.search(/^data\:image\/jpeg/)===0?"image/jpeg":d.search(/\.webp($|\?)/i)>0||d.search(/^data\:image\/webp/)===0?"image/webp":d.search(/\.ktx2($|\?)/i)>0||d.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Kn=new me;class jn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new mn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=-1,n=!1,o=-1;if(typeof navigator<"u"&&typeof navigator.userAgent<"u"){const r=navigator.userAgent;i=/^((?!chrome|android).)*safari/i.test(r)===!0;const a=r.match(/Version\/(\d+)/);s=i&&a?parseInt(a[1],10):-1,n=r.indexOf("Firefox")>-1,o=n?r.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||i&&s<17||n&&o<98?this.textureLoader=new vi(this.options.manager):this.textureLoader=new Ei(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Wt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const r={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:i,userData:{}};return pe(n,r,s),ee(r,s),Promise.all(i._invokeAll(function(a){return a.afterRoot&&a.afterRoot(r)})).then(function(){for(const a of r.scenes)a.updateMatrixWorld();e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let s=0,n=t.length;s<n;s++){const o=t[s].joints;for(let r=0,a=o.length;r<a;r++)e[o[r]].isBone=!0}for(let s=0,n=e.length;s<n;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),n=(o,r)=>{const a=this.associations.get(o);a!=null&&this.associations.set(r,a);for(const[h,l]of o.children.entries())n(l,r.children[h])};return n(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const n=e(t[s]);n&&i.push(n)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":s=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(n,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(n,o){i.load(De.resolveURL(t.uri,s.path),n,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const s=t.byteLength||0,n=t.byteOffset||0;return i.slice(n,n+s)})}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=Qe[s.type],r=xe[s.componentType],a=s.normalized===!0,h=new r(s.count*o);return Promise.resolve(new ie(h,o,a))}const n=[];return s.bufferView!==void 0?n.push(this.getDependency("bufferView",s.bufferView)):n.push(null),s.sparse!==void 0&&(n.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(n).then(function(o){const r=o[0],a=Qe[s.type],h=xe[s.componentType],l=h.BYTES_PER_ELEMENT,c=l*a,u=s.byteOffset||0,p=s.bufferView!==void 0?i.bufferViews[s.bufferView].byteStride:void 0,f=s.normalized===!0;let g,m;if(p&&p!==c){const S=Math.floor(u/p),E="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+S+":"+s.count;let b=t.cache.get(E);b||(g=new h(r,S*p,s.count*p/l),b=new Mi(g,p/l),t.cache.add(E,b)),m=new Hi(b,a,u%p/l,f)}else r===null?g=new h(s.count*a):g=new h(r,u,s.count*a),m=new ie(g,a,f);if(s.sparse!==void 0){const S=Qe.SCALAR,E=xe[s.sparse.indices.componentType],b=s.sparse.indices.byteOffset||0,v=s.sparse.values.byteOffset||0,P=new E(o[1],b,s.sparse.count*S),_=new h(o[2],v,s.sparse.count*a);r!==null&&(m=new ie(m.array.slice(),m.itemSize,m.normalized)),m.normalized=!1;for(let L=0,K=P.length;L<K;L++){const U=P[L];if(m.setX(U,_[L*a]),a>=2&&m.setY(U,_[L*a+1]),a>=3&&m.setZ(U,_[L*a+2]),a>=4&&m.setW(U,_[L*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}m.normalized=f}return m})}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e].source,o=t.images[n];let r=this.textureLoader;if(o.uri){const a=i.manager.getHandler(o.uri);a!==null&&(r=a)}return this.loadTextureImage(e,n,r)}loadTextureImage(e,t,i){const s=this,n=this.json,o=n.textures[e],r=n.images[t],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const h=this.loadImageSource(t,i).then(function(l){l.flipY=!1,l.name=o.name||r.name||"",l.name===""&&typeof r.uri=="string"&&r.uri.startsWith("data:image/")===!1&&(l.name=r.uri);const u=(n.samplers||{})[o.sampler]||{};return l.magFilter=Ct[u.magFilter]||Z,l.minFilter=Ct[u.minFilter]||Xt,l.wrapS=_t[u.wrapS]||et,l.wrapT=_t[u.wrapT]||et,l.generateMipmaps=!l.isCompressedTexture&&l.minFilter!==Jt&&l.minFilter!==Z,s.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[a]=h,h}loadImageSource(e,t){const i=this,s=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(c=>c.clone());const o=s.images[e],r=self.URL||self.webkitURL;let a=o.uri||"",h=!1;if(o.bufferView!==void 0)a=i.getDependency("bufferView",o.bufferView).then(function(c){h=!0;const u=new Blob([c],{type:o.mimeType});return a=r.createObjectURL(u),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(c){return new Promise(function(u,p){let f=u;t.isImageBitmapLoader===!0&&(f=function(g){const m=new wt(g);m.needsUpdate=!0,u(m)}),t.load(De.resolveURL(c,n.path),f,void 0,p)})}).then(function(c){return h===!0&&r.revokeObjectURL(a),ee(c,o),c.userData.mimeType=o.mimeType||Gn(o.uri),c}).catch(function(c){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),c});return this.sourceCache[e]=l,l}assignTexture(e,t,i,s){const n=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),n.extensions[I.KHR_TEXTURE_TRANSFORM]){const r=i.extensions!==void 0?i.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const a=n.associations.get(o);o=n.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,r),n.associations.set(o,a)}}return s!==void 0&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const r="PointsMaterial:"+i.uuid;let a=this.cache.get(r);a||(a=new Kt,Ke.prototype.copy.call(a,i),a.color.copy(i.color),a.map=i.map,a.sizeAttenuation=!1,this.cache.add(r,a)),i=a}else if(e.isLine){const r="LineBasicMaterial:"+i.uuid;let a=this.cache.get(r);a||(a=new J,Ke.prototype.copy.call(a,i),a.color.copy(i.color),a.map=i.map,this.cache.add(r,a)),i=a}if(s||n||o){let r="ClonedMaterial:"+i.uuid+":";s&&(r+="derivative-tangents:"),n&&(r+="vertex-colors:"),o&&(r+="flat-shading:");let a=this.cache.get(r);a||(a=i.clone(),n&&(a.vertexColors=!0),o&&(a.flatShading=!0),s&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(r,a),this.associations.set(a,this.associations.get(i))),i=a}e.material=i}getMaterialType(){return G}loadMaterial(e){const t=this,i=this.json,s=this.extensions,n=i.materials[e];let o;const r={},a=n.extensions||{},h=[];if(a[I.KHR_MATERIALS_UNLIT]){const c=s[I.KHR_MATERIALS_UNLIT];o=c.getMaterialType(),h.push(c.extendParams(r,n,t))}else{const c=n.pbrMetallicRoughness||{};if(r.color=new D(1,1,1),r.opacity=1,Array.isArray(c.baseColorFactor)){const u=c.baseColorFactor;r.color.setRGB(u[0],u[1],u[2],re),r.opacity=u[3]}c.baseColorTexture!==void 0&&h.push(t.assignTexture(r,"map",c.baseColorTexture,ge)),r.metalness=c.metallicFactor!==void 0?c.metallicFactor:1,r.roughness=c.roughnessFactor!==void 0?c.roughnessFactor:1,c.metallicRoughnessTexture!==void 0&&(h.push(t.assignTexture(r,"metalnessMap",c.metallicRoughnessTexture)),h.push(t.assignTexture(r,"roughnessMap",c.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),h.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,r)})))}n.doubleSided===!0&&(r.side=Se);const l=n.alphaMode||We.OPAQUE;if(l===We.BLEND?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===We.MASK&&(r.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&o!==B&&(h.push(t.assignTexture(r,"normalMap",n.normalTexture)),r.normalScale=new Yt(1,1),n.normalTexture.scale!==void 0)){const c=n.normalTexture.scale;r.normalScale.set(c,c)}if(n.occlusionTexture!==void 0&&o!==B&&(h.push(t.assignTexture(r,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(r.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&o!==B){const c=n.emissiveFactor;r.emissive=new D().setRGB(c[0],c[1],c[2],re)}return n.emissiveTexture!==void 0&&o!==B&&h.push(t.assignTexture(r,"emissiveMap",n.emissiveTexture,ge)),Promise.all(h).then(function(){const c=new o(r);return n.name&&(c.name=n.name),ee(c,n),t.associations.set(c,{materials:e}),n.extensions&&pe(s,c,n),c})}createUniqueName(e){const t=_i.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function n(r){return i[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,t).then(function(a){return Lt(a,r,t)})}const o=[];for(let r=0,a=e.length;r<a;r++){const h=e[r],l=Vn(h),c=s[l];if(c)o.push(c.promise);else{let u;h.extensions&&h.extensions[I.KHR_DRACO_MESH_COMPRESSION]?u=n(h):u=Lt(new fe,h,t),s[l]={primitive:h,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,s=this.extensions,n=i.meshes[e],o=n.primitives,r=[];for(let a=0,h=o.length;a<h;a++){const l=o[a].material===void 0?qn(this.cache):this.getDependency("material",o[a].material);r.push(l)}return r.push(t.loadGeometries(o)),Promise.all(r).then(function(a){const h=a.slice(0,a.length-1),l=a[a.length-1],c=[];for(let p=0,f=l.length;p<f;p++){const g=l[p],m=o[p];let S;const E=h[p];if(m.mode===X.TRIANGLES||m.mode===X.TRIANGLE_STRIP||m.mode===X.TRIANGLE_FAN||m.mode===void 0)S=n.isSkinnedMesh===!0?new Li(g,E):new R(g,E),S.isSkinnedMesh===!0&&S.normalizeSkinWeights(),m.mode===X.TRIANGLE_STRIP?S.geometry=Pt(S.geometry,Qt):m.mode===X.TRIANGLE_FAN&&(S.geometry=Pt(S.geometry,Ze));else if(m.mode===X.LINES)S=new te(g,E);else if(m.mode===X.LINE_STRIP)S=new Le(g,E);else if(m.mode===X.LINE_LOOP)S=new Di(g,E);else if(m.mode===X.POINTS)S=new ht(g,E);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(S.geometry.morphAttributes).length>0&&Un(S,n),S.name=t.createUniqueName(n.name||"mesh_"+e),ee(S,n),m.extensions&&pe(s,S,m),t.assignFinalMaterial(S),c.push(S)}for(let p=0,f=c.length;p<f;p++)t.associations.set(c[p],{meshes:e,primitives:p});if(c.length===1)return n.extensions&&pe(s,c[0],n),c[0];const u=new z;n.extensions&&pe(s,u,n),t.associations.set(u,{meshes:e});for(let p=0,f=c.length;p<f;p++)u.add(c[p]);return u})}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new Ft(qe.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):i.type==="orthographic"&&(t=new ki(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),ee(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let s=0,n=t.joints.length;s<n;s++)i.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(s){const n=s.pop(),o=s,r=[],a=[];for(let h=0,l=o.length;h<l;h++){const c=o[h];if(c){r.push(c);const u=new me;n!==null&&u.fromArray(n.array,h*16),a.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[h])}return new Gt(r,a)})}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],n=s.name?s.name:"animation_"+e,o=[],r=[],a=[],h=[],l=[];for(let c=0,u=s.channels.length;c<u;c++){const p=s.channels[c],f=s.samplers[p.sampler],g=p.target,m=g.node,S=s.parameters!==void 0?s.parameters[f.input]:f.input,E=s.parameters!==void 0?s.parameters[f.output]:f.output;g.node!==void 0&&(o.push(this.getDependency("node",m)),r.push(this.getDependency("accessor",S)),a.push(this.getDependency("accessor",E)),h.push(f),l.push(g))}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a),Promise.all(h),Promise.all(l)]).then(function(c){const u=c[0],p=c[1],f=c[2],g=c[3],m=c[4],S=[];for(let b=0,v=u.length;b<v;b++){const P=u[b],_=p[b],L=f[b],K=g[b],U=m[b];if(P===void 0)continue;P.updateMatrix&&P.updateMatrix();const q=i._createAnimationTracks(P,_,L,K,U);if(q)for(let V=0;V<q.length;V++)S.push(q[V])}const E=new Ni(n,void 0,S);return ee(E,s),E})}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return s.mesh===void 0?null:i.getDependency("mesh",s.mesh).then(function(n){const o=i._getNodeRef(i.meshCache,s.mesh,n);return s.weights!==void 0&&o.traverse(function(r){if(r.isMesh)for(let a=0,h=s.weights.length;a<h;a++)r.morphTargetInfluences[a]=s.weights[a]}),o})}loadNode(e){const t=this.json,i=this,s=t.nodes[e],n=i._loadNodeShallow(e),o=[],r=s.children||[];for(let h=0,l=r.length;h<l;h++)o.push(i.getDependency("node",r[h]));const a=s.skin===void 0?Promise.resolve(null):i.getDependency("skin",s.skin);return Promise.all([n,Promise.all(o),a]).then(function(h){const l=h[0],c=h[1],u=h[2];u!==null&&l.traverse(function(p){p.isSkinnedMesh&&p.bind(u,Kn)});for(let p=0,f=c.length;p<f;p++)l.add(c[p]);if(l.userData.pivot!==void 0&&c.length>0){const p=l.userData.pivot,f=c[0];l.pivot=new x().fromArray(p),l.position.x-=p[0],l.position.y-=p[1],l.position.z-=p[2],f.position.set(0,0,0),delete l.userData.pivot}return l})}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],o=n.name?s.createUniqueName(n.name):"",r=[],a=s._invokeOne(function(h){return h.createNodeMesh&&h.createNodeMesh(e)});return a&&r.push(a),n.camera!==void 0&&r.push(s.getDependency("camera",n.camera).then(function(h){return s._getNodeRef(s.cameraCache,n.camera,h)})),s._invokeAll(function(h){return h.createNodeAttachment&&h.createNodeAttachment(e)}).forEach(function(h){r.push(h)}),this.nodeCache[e]=Promise.all(r).then(function(h){let l;if(n.isBone===!0?l=new H:h.length>1?l=new z:h.length===1?l=h[0]:l=new at,l!==h[0])for(let c=0,u=h.length;c<u;c++)l.add(h[c]);if(n.name&&(l.userData.name=n.name,l.name=o),ee(l,n),n.extensions&&pe(i,l,n),n.matrix!==void 0){const c=new me;c.fromArray(n.matrix),l.applyMatrix4(c)}else n.translation!==void 0&&l.position.fromArray(n.translation),n.rotation!==void 0&&l.quaternion.fromArray(n.rotation),n.scale!==void 0&&l.scale.fromArray(n.scale);if(!s.associations.has(l))s.associations.set(l,{});else if(n.mesh!==void 0&&s.meshCache.refs[n.mesh]>1){const c=s.associations.get(l);s.associations.set(l,{...c})}return s.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,n=new z;i.name&&(n.name=s.createUniqueName(i.name)),ee(n,i),i.extensions&&pe(t,n,i);const o=i.nodes||[],r=[];for(let a=0,h=o.length;a<h;a++)r.push(s.getDependency("node",o[a]));return Promise.all(r).then(function(a){for(let l=0,c=a.length;l<c;l++){const u=a[l];u.parent!==null?n.add(pn(u)):n.add(u)}const h=l=>{const c=new Map;for(const[u,p]of s.associations)(u instanceof Ke||u instanceof wt)&&c.set(u,p);return l.traverse(u=>{const p=s.associations.get(u);p!=null&&c.set(u,p)}),c};return s.associations=h(n),n})}_createAnimationTracks(e,t,i,s,n){const o=[],r=e.name?e.name:e.uuid,a=[];ae[n.path]===ae.weights?e.traverse(function(u){u.morphTargetInfluences&&a.push(u.name?u.name:u.uuid)}):a.push(r);let h;switch(ae[n.path]){case ae.weights:h=St;break;case ae.rotation:h=Tt;break;case ae.translation:case ae.scale:h=xt;break;default:i.itemSize===1?h=St:h=xt;break}const l=s.interpolation!==void 0?zn[s.interpolation]:$t,c=this._getArrayFromAccessor(i);for(let u=0,p=a.length;u<p;u++){const f=new h(a[u]+"."+ae[n.path],t.array,c,l);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),o.push(f)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=nt(t.constructor),s=new Float32Array(t.length);for(let n=0,o=t.length;n<o;n++)s[n]=t[n]*i;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const s=this instanceof Tt?Bn:ni;return new s(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Qn(d,e,t){const i=e.attributes,s=new lt;if(i.POSITION!==void 0){const r=t.json.accessors[i.POSITION],a=r.min,h=r.max;if(a!==void 0&&h!==void 0){if(s.set(new x(a[0],a[1],a[2]),new x(h[0],h[1],h[2])),r.normalized){const l=nt(xe[r.componentType]);s.min.multiplyScalar(l),s.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const r=new x,a=new x;for(let h=0,l=n.length;h<l;h++){const c=n[h];if(c.POSITION!==void 0){const u=t.json.accessors[c.POSITION],p=u.min,f=u.max;if(p!==void 0&&f!==void 0){if(a.setX(Math.max(Math.abs(p[0]),Math.abs(f[0]))),a.setY(Math.max(Math.abs(p[1]),Math.abs(f[1]))),a.setZ(Math.max(Math.abs(p[2]),Math.abs(f[2]))),u.normalized){const g=nt(xe[u.componentType]);a.multiplyScalar(g)}r.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(r)}d.boundingBox=s;const o=new qi;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,d.boundingSphere=o}function Lt(d,e,t){const i=e.attributes,s=[];function n(o,r){return t.getDependency("accessor",o).then(function(a){d.setAttribute(r,a)})}for(const o in i){const r=st[o]||o.toLowerCase();r in d.attributes||s.push(n(i[o],r))}if(e.indices!==void 0&&!d.index){const o=t.getDependency("accessor",e.indices).then(function(r){d.setIndex(r)});s.push(o)}return bt.workingColorSpace!==re&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${bt.workingColorSpace}" not supported.`),ee(d,e),Qn(d,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Fn(d,e.targets,t):d})}class Wn{constructor(e){this.context=e}loader=new fn;cache=new Map;loadingPromises=new Map;async loadGLTF(e){if(this.cache.has(e))return this.cache.get(e).clone();if(this.loadingPromises.has(e))return(await this.loadingPromises.get(e)).clone();const t=new Promise((s,n)=>{this.loader.load(e,o=>{this.cache.set(e,o.scene),s(o.scene)},void 0,o=>n(o))});this.loadingPromises.set(e,t);const i=await t;return this.loadingPromises.delete(e),i.clone()}async getNormalizedModel(e,t=1){const i=await this.loadGLTF(e),s=new lt().setFromObject(i),n=s.getSize(new x),o=Math.max(n.x,n.y,n.z),r=t/o;i.scale.setScalar(r);const a=s.getCenter(new x).multiplyScalar(-r);return i.position.copy(a),i}}class Yn{constructor(e,t){this.context=t,this.scene=e,this.lineMaterial=new J({vertexColors:!0}),this.scene&&(this.lineGroup=new z,this.scene.add(this.lineGroup)),this.context.managers.replication.registerFeature(this)}featureId="feature:drawing";scene;lineMaterial;lineGroup=null;segments=[];maxSegments=1e4;addSegment(e,t=!0){if(this.isValidSegment(e)){if(t){this.context.managers.replication.emitFeatureEvent(this.featureId,"segment",e);return}this.drawLine(e)}}drawLine(e){if(this.segments.push(e),this.segments.length>this.maxSegments&&this.segments.splice(0,this.segments.length-this.maxSegments),!this.scene)return;const t=[];t.push(new x(...e.startPos)),t.push(new x(...e.endPos));const i=new fe().setFromPoints(t),s=new D(e.color),n=new Float32Array([s.r,s.g,s.b,s.r,s.g,s.b]);i.setAttribute("color",new ie(n,3));const o=new Le(i,this.lineMaterial);this.lineGroup?.add(o)}onEvent(e,t){if(e!=="segment")return;const i=t;this.isValidSegment(i)&&this.addSegment(i,!1)}captureSnapshot(){return{segments:this.segments.slice()}}applySnapshot(e){if(!e||typeof e!="object")return;const t=e;if(Array.isArray(t.segments)){this.segments=[],this.clearRenderedLines();for(const i of t.segments)this.isValidSegment(i)&&this.drawLine(i)}}isValidSegment(e){return!e||!Array.isArray(e.startPos)||e.startPos.length<3||!Array.isArray(e.endPos)||e.endPos.length<3?!1:typeof e.color=="string"||typeof e.color=="number"}clearRenderedLines(){if(this.lineGroup)for(;this.lineGroup.children.length>0;){const e=this.lineGroup.children.pop();if(!e)break;const t=e;t.geometry&&t.geometry.dispose()}}}class Me{active;hasJoints;pose;pointerPose;joints;constructor(e=0,t=!1){this.active=t,this.hasJoints=!1,this.pose={position:{x:e,y:.8,z:0},quaternion:{x:0,y:0,z:0,w:1}},this.pointerPose={position:{x:e,y:.8,z:0},quaternion:{x:0,y:0,z:0,w:1}},this.joints=[];for(let i=0;i<25;i++)this.joints.push({pose:{position:{x:0,y:0,z:0},quaternion:{x:0,y:0,z:0,w:1}}})}copyFrom(e){this.active=e.active,this.hasJoints=e.hasJoints,this.pose.position.x=e.pose.position.x,this.pose.position.y=e.pose.position.y,this.pose.position.z=e.pose.position.z,this.pose.quaternion.x=e.pose.quaternion.x,this.pose.quaternion.y=e.pose.quaternion.y,this.pose.quaternion.z=e.pose.quaternion.z,this.pose.quaternion.w=e.pose.quaternion.w,this.pointerPose.position.x=e.pointerPose.position.x,this.pointerPose.position.y=e.pointerPose.position.y,this.pointerPose.position.z=e.pointerPose.position.z,this.pointerPose.quaternion.x=e.pointerPose.quaternion.x,this.pointerPose.quaternion.y=e.pointerPose.quaternion.y,this.pointerPose.quaternion.z=e.pointerPose.quaternion.z,this.pointerPose.quaternion.w=e.pointerPose.quaternion.w;for(let t=0;t<25;t++){const i=e.joints[t],s=this.joints[t];!i||!s||(s.pose.position.x=i.pose.position.x,s.pose.position.y=i.pose.position.y,s.pose.position.z=i.pose.position.z,s.pose.quaternion.x=i.pose.quaternion.x,s.pose.quaternion.y=i.pose.quaternion.y,s.pose.quaternion.z=i.pose.quaternion.z,s.pose.quaternion.w=i.pose.quaternion.w)}}applyData(e){if(e&&(e.active!==void 0&&(this.active=!!e.active),e.hasJoints!==void 0&&(this.hasJoints=!!e.hasJoints),e.pose&&(e.pose.position&&(this.pose.position.x=e.pose.position.x,this.pose.position.y=e.pose.position.y,this.pose.position.z=e.pose.position.z),e.pose.quaternion&&(this.pose.quaternion.x=e.pose.quaternion.x,this.pose.quaternion.y=e.pose.quaternion.y,this.pose.quaternion.z=e.pose.quaternion.z,this.pose.quaternion.w=e.pose.quaternion.w)),e.pointerPose&&(e.pointerPose.position&&(this.pointerPose.position.x=e.pointerPose.position.x,this.pointerPose.position.y=e.pointerPose.position.y,this.pointerPose.position.z=e.pointerPose.position.z),e.pointerPose.quaternion&&(this.pointerPose.quaternion.x=e.pointerPose.quaternion.x,this.pointerPose.quaternion.y=e.pointerPose.quaternion.y,this.pointerPose.quaternion.z=e.pointerPose.quaternion.z,this.pointerPose.quaternion.w=e.pointerPose.quaternion.w)),e.joints&&Array.isArray(e.joints)))for(let t=0;t<25;t++){const i=e.joints[t];!i||!this.joints[t]||(i.pose?.position?(this.joints[t].pose.position.x=i.pose.position.x,this.joints[t].pose.position.y=i.pose.position.y,this.joints[t].pose.position.z=i.pose.position.z):i.p&&(this.joints[t].pose.position.x=i.p.x,this.joints[t].pose.position.y=i.p.y,this.joints[t].pose.position.z=i.p.z),i.pose?.quaternion?(this.joints[t].pose.quaternion.x=i.pose.quaternion.x,this.joints[t].pose.quaternion.y=i.pose.quaternion.y,this.joints[t].pose.quaternion.z=i.pose.quaternion.z,this.joints[t].pose.quaternion.w=i.pose.quaternion.w):i.q&&(this.joints[t].pose.quaternion.x=i.q.x,this.joints[t].pose.quaternion.y=i.q.y,this.joints[t].pose.quaternion.z=i.q.z,this.joints[t].pose.quaternion.w=i.q.w))}}}class Xn{constructor(e){this.context=e}activeProvider=null;providers=new Map;registerProvider(e){this.providers.set(e.id,e),e.init()}getActiveProviderId(){return this.activeProvider?this.activeProvider.id:null}setProvider(e){const t=this.providers.get(e);t&&(this.activeProvider&&this.activeProvider!==t&&this.activeProvider.deactivate(),this.activeProvider=t,this.activeProvider.activate(),console.log(`[TrackingManager] Switched to provider: ${e}`))}update(e,t){this.activeProvider&&this.activeProvider.update(e,t)}getState(){return this.activeProvider?this.activeProvider.getState():{head:{pose:{position:{x:0,y:1.7,z:0},quaternion:{x:0,y:0,z:0,w:1}},yaw:0},hands:{left:new Me(-.4),right:new Me(.4)}}}setHandActive(e,t){this.activeProvider&&this.activeProvider.setHandActive&&this.activeProvider.setHandActive(e,t)}adjustReach(e){this.activeProvider&&this.activeProvider.adjustReach&&this.activeProvider.adjustReach(e)}setAssistedReach(e,t){this.activeProvider&&this.activeProvider.setAssistedReach&&this.activeProvider.setAssistedReach(e,t)}}const Dt=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],ze={left:{wrist:"leftHand","thumb-metacarpal":"leftThumbMetacarpal","thumb-phalanx-proximal":"leftThumbProximal","thumb-phalanx-distal":"leftThumbDistal","thumb-tip":"leftThumbTip","index-finger-metacarpal":"leftIndexMetacarpal","index-finger-phalanx-proximal":"leftIndexProximal","index-finger-phalanx-intermediate":"leftIndexIntermediate","index-finger-phalanx-distal":"leftIndexDistal","index-finger-tip":"leftIndexTip","middle-finger-metacarpal":"leftMiddleMetacarpal","middle-finger-phalanx-proximal":"leftMiddleProximal","middle-finger-phalanx-intermediate":"leftMiddleIntermediate","middle-finger-phalanx-distal":"leftMiddleDistal","middle-finger-tip":"leftMiddleTip","ring-finger-metacarpal":"leftRingMetacarpal","ring-finger-phalanx-proximal":"leftRingProximal","ring-finger-phalanx-intermediate":"leftRingIntermediate","ring-finger-phalanx-distal":"leftRingDistal","ring-finger-tip":"leftRingTip","pinky-finger-metacarpal":"leftLittleMetacarpal","pinky-finger-phalanx-proximal":"leftLittleProximal","pinky-finger-phalanx-intermediate":"leftLittleIntermediate","pinky-finger-phalanx-distal":"leftLittleDistal","pinky-finger-tip":"leftLittleTip"},right:{wrist:"rightHand","thumb-metacarpal":"rightThumbMetacarpal","thumb-phalanx-proximal":"rightThumbProximal","thumb-phalanx-distal":"rightThumbDistal","thumb-tip":"rightThumbTip","index-finger-metacarpal":"rightIndexMetacarpal","index-finger-phalanx-proximal":"rightIndexProximal","index-finger-phalanx-intermediate":"rightIndexIntermediate","index-finger-phalanx-distal":"rightIndexDistal","index-finger-tip":"rightIndexTip","middle-finger-metacarpal":"rightMiddleMetacarpal","middle-finger-phalanx-proximal":"rightMiddleProximal","middle-finger-phalanx-intermediate":"rightMiddleIntermediate","middle-finger-phalanx-distal":"rightMiddleDistal","middle-finger-tip":"rightMiddleTip","ring-finger-metacarpal":"rightRingMetacarpal","ring-finger-phalanx-proximal":"rightRingProximal","ring-finger-phalanx-intermediate":"rightRingIntermediate","ring-finger-phalanx-distal":"rightRingDistal","ring-finger-tip":"rightRingTip","pinky-finger-metacarpal":"rightLittleMetacarpal","pinky-finger-phalanx-proximal":"rightLittleProximal","pinky-finger-phalanx-intermediate":"rightLittleIntermediate","pinky-finger-phalanx-distal":"rightLittleDistal","pinky-finger-tip":"rightLittleTip"}};class Jn{constructor(e){this.context=e,this.humanoid=new Ue,this.state=this.createInitialState()}id="xr";state;humanoid;tempVec=new x;tempQuat=new C;init(){}activate(){console.log("[XRTrackingProvider] Activated")}deactivate(){console.log("[XRTrackingProvider] Deactivated"),this.state.hands.left.active=!1,this.state.hands.right.active=!1,this.state.humanoidDelta=this.humanoid.consumeNetworkDelta()||void 0}clearHand(e){const t=ze[e];for(const i in t)this.humanoid.clearJoint(t[i])}clearFingers(e){const t=ze[e];for(let i=1;i<25;i++)this.humanoid.clearJoint(t[Dt[i]])}createInitialState(){return{head:{pose:{position:{x:0,y:1.7,z:0},quaternion:{x:0,y:0,z:0,w:1}},yaw:0},hands:{left:new Me(-.4),right:new Me(.4)}}}update(e,t){const s=this.context.managers.render;if(!s.isXRPresenting())return;const n=s.getXRSession(),o=t||s.getXRFrame(),r=s.getXRReferenceSpace();if(!n||!o||!r)return;const a=this.getViewerWorldPose(s,o,r);this.state.head={pose:{position:a.position,quaternion:a.quaternion},yaw:a.yaw},this.state.hands.left.active=!1,this.state.hands.right.active=!1,this.state.humanoidDelta=void 0;const h={};for(let c=0;c<n.inputSources.length;c++){const u=n.inputSources[c],p=u.handedness;if(p!=="left"&&p!=="right")continue;const f=h[p];if(!f){h[p]=u;continue}f.hand&&!u.hand&&(h[p]=u)}const l=new Set;for(const c of["left","right"]){const u=h[c];if(!u){this.clearHand(c);continue}l.add(c);const p=this.state.hands[c];if(p.hasJoints=!!u.hand,u.hand){let f=null,g=0;for(let m=0;m<25;m++){const S=Dt[m],E=ze[c][S],b=u.hand.get(S),v=b?o.getJointPose(b,r):null;if(v){const P=this.rawPoseToWorldPose(v,s.cameraGroup);this.humanoid.setJointPose(E,P.position,P.quaternion),p.joints[m].pose.position=P.position,p.joints[m].pose.quaternion=P.quaternion,m===0&&(f=P),g++}else this.humanoid.clearJoint(E),p.joints[m].pose.position={x:0,y:0,z:0},p.joints[m].pose.quaternion={x:0,y:0,z:0,w:1}}if(f&&g>0){p.active=!0,p.pose.position=f.position,p.pose.quaternion=f.quaternion;const m=u.targetRaySpace?o.getPose(u.targetRaySpace,r):null;if(m){const S=this.rawPoseToWorldPose(m,s.cameraGroup);p.pointerPose.position=S.position,p.pointerPose.quaternion=S.quaternion}}else p.active=!1,this.clearHand(c)}else{const f=u.gripSpace||u.targetRaySpace,g=f?o.getPose(f,r):null;if(g){const m=this.rawPoseToWorldPose(g,s.cameraGroup);p.active=!0,p.pose.position=m.position,p.pose.quaternion=m.quaternion;const S=ze[c].wrist;if(this.humanoid.setJointPose(S,m.position,m.quaternion),this.clearFingers(c),u.targetRaySpace){const E=o.getPose(u.targetRaySpace,r);if(E){const b=this.rawPoseToWorldPose(E,s.cameraGroup);p.pointerPose.position=b.position,p.pointerPose.quaternion=b.quaternion}}else p.pointerPose.position=p.pose.position,p.pointerPose.quaternion=p.pose.quaternion}else p.active=!1,this.clearHand(c);for(let m=0;m<25;m++)p.joints[m].pose.position={x:0,y:0,z:0},p.joints[m].pose.quaternion={x:0,y:0,z:0,w:1}}}l.has("left")||this.clearHand("left"),l.has("right")||this.clearHand("right"),this.state.humanoidDelta=this.humanoid.consumeNetworkDelta()||void 0}getState(){return this.state}getViewerWorldPose(e,t,i){e.camera.getWorldPosition(this.tempVec),e.camera.getWorldQuaternion(this.tempQuat);const s=new le().setFromQuaternion(this.tempQuat,"YXZ");return{position:{x:this.tempVec.x,y:this.tempVec.y,z:this.tempVec.z},quaternion:{x:this.tempQuat.x,y:this.tempQuat.y,z:this.tempQuat.z,w:this.tempQuat.w},yaw:s.y}}rawPoseToWorldPose(e,t){const i=e.transform.orientation,s=e.transform.position;this.tempVec.set(s.x,s.y,s.z),this.tempQuat.set(i.x,i.y,i.z,i.w),this.tempVec.applyMatrix4(t.matrixWorld);const n=new C;return t.getWorldQuaternion(n),this.tempQuat.premultiply(n),{position:{x:this.tempVec.x,y:this.tempVec.y,z:this.tempVec.z},quaternion:{x:this.tempQuat.x,y:this.tempQuat.y,z:this.tempQuat.z,w:this.tempQuat.w}}}destroy(){}}const kt=15,$n=15,Nt=.2,Xe=4,Ot=.5,Ht=-.2,Bt=.2;class Zn{constructor(e){this.context=e,this.humanoid=new Ue,this.state=this.createInitialState()}id="desktop";state;humanoid;leftStretch=new x(0,0,0);rightStretch=new x(0,0,0);targetLeftStretch=new x(0,0,0);targetRightStretch=new x(0,0,0);leftReach=1;rightReach=1;assistedReach={left:null,right:null};prioritizedHand=null;pitch=0;turnSpeed=.002;headHeight=Ee.DEFAULT_HEAD_HEIGHT;assistedForwardBase=.22;assistedCameraPos=new x;assistedCameraQuat=new C;_lookHandler=e=>{this.context.managers.render.isXRPresenting()||(this.pitch-=e.delta.y*this.turnSpeed*$n,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)))};init(){}activate(){w.on(y.INTENT_LOOK,this._lookHandler)}deactivate(){w.off(y.INTENT_LOOK,this._lookHandler),this.prioritizedHand=null,this.targetLeftStretch.set(0,0,0),this.targetRightStretch.set(0,0,0),this.leftStretch.set(0,0,0),this.rightStretch.set(0,0,0),this.assistedReach.left=null,this.assistedReach.right=null}manualStatus={left:!1,right:!1};setHandActive(e,t){const i=this.state.hands[e];if(this.manualStatus[e]=t,t)this.prioritizedHand=e,this.updateHandTarget(e);else if(this.updateHandTarget(e),this.prioritizedHand===e){const s=e==="left"?"right":"left";this.prioritizedHand=this.manualStatus[s]?s:null}i.active=!0}updateHandTarget(e){const i=this.manualStatus[e]?e==="left"?this.leftReach:this.rightReach:this.assistedReach[e];e==="left"?i!==null?this.targetLeftStretch.set(0,0,-i):this.targetLeftStretch.set(0,0,0):i!==null?this.targetRightStretch.set(0,0,-i):this.targetRightStretch.set(0,0,0)}adjustReach(e){const t=this.prioritizedHand;t&&(t==="left"?(this.leftReach=Math.max(Nt,Math.min(Xe,this.leftReach+e)),this.updateHandTarget("left")):(this.rightReach=Math.max(Nt,Math.min(Xe,this.rightReach+e)),this.updateHandTarget("right")))}setAssistedReach(e,t){const i=t===null?null:Math.max(0,Math.min(Xe,t));this.assistedReach[e]=i,this.manualStatus[e]||this.updateHandTarget(e)}createInitialState(){return{head:{pose:{position:{x:0,y:this.headHeight,z:0},quaternion:{x:0,y:0,z:0,w:1}},yaw:0},hands:{left:new Me(-.4,!0),right:new Me(.4,!0)}}}update(e){const i=this.context.managers.render;if(i.isXRPresenting())return;const s=this.context.localPlayer;if(!s||s.type!=="LOCAL_PLAYER")return;const n=new x(s.xrOrigin.position.x,s.xrOrigin.position.y,s.xrOrigin.position.z),o=new C(s.xrOrigin.quaternion.x,s.xrOrigin.quaternion.y,s.xrOrigin.quaternion.z,s.xrOrigin.quaternion.w),r=new x(0,this.headHeight,0),a=new C().setFromEuler(new le(this.pitch,0,0,"YXZ")),h=r.clone().applyQuaternion(o).add(n),l=o.clone().multiply(a);this.state.head={pose:{position:{x:h.x,y:h.y,z:h.z},quaternion:{x:l.x,y:l.y,z:l.z,w:l.w}},yaw:new le().setFromQuaternion(l,"YXZ").y},this.leftStretch.lerp(this.targetLeftStretch,e*kt),this.rightStretch.lerp(this.targetRightStretch,e*kt);const c=new x(-Bt,this.headHeight-Ot,Ht),u=new x(Bt,this.headHeight-Ot,Ht),p=c.clone().applyQuaternion(o).add(n),f=u.clone().applyQuaternion(o).add(n);let g=p.clone().add(this.leftStretch.clone().applyQuaternion(l)),m=f.clone().add(this.rightStretch.clone().applyQuaternion(l));if((!this.manualStatus.left&&this.assistedReach.left!==null||!this.manualStatus.right&&this.assistedReach.right!==null)&&(i.camera.getWorldPosition(this.assistedCameraPos),i.camera.getWorldQuaternion(this.assistedCameraQuat)),!this.manualStatus.left&&this.assistedReach.left!==null){const S=new x(0,0,-(this.assistedForwardBase+this.assistedReach.left));g=this.assistedCameraPos.clone().add(S.applyQuaternion(this.assistedCameraQuat))}if(!this.manualStatus.right&&this.assistedReach.right!==null){const S=new x(0,0,-(this.assistedForwardBase+this.assistedReach.right));m=this.assistedCameraPos.clone().add(S.applyQuaternion(this.assistedCameraQuat))}this.state.hands.left.pose.position={x:g.x,y:g.y,z:g.z},this.state.hands.left.pose.quaternion={x:l.x,y:l.y,z:l.z,w:l.w},this.state.hands.left.pointerPose.position={...this.state.hands.left.pose.position},this.state.hands.left.pointerPose.quaternion={...this.state.hands.left.pose.quaternion},this.state.hands.left.joints.forEach(S=>{S.pose.position={...this.state.hands.left.pose.position},S.pose.quaternion={...this.state.hands.left.pose.quaternion}}),this.state.hands.right.pose.position={x:m.x,y:m.y,z:m.z},this.state.hands.right.pose.quaternion={x:l.x,y:l.y,z:l.z,w:l.w},this.state.hands.right.pointerPose.position={...this.state.hands.right.pose.position},this.state.hands.right.pointerPose.quaternion={...this.state.hands.right.pose.quaternion},this.state.hands.right.joints.forEach(S=>{S.pose.position={...this.state.hands.right.pose.position},S.pose.quaternion={...this.state.hands.right.pose.quaternion}}),this.humanoid.setJointPose("leftHand",g,l),this.humanoid.setJointPose("rightHand",m,l),this.state.humanoidDelta=this.humanoid.consumeNetworkDelta()||void 0}getState(){return this.state}destroy(){this.deactivate()}}class eo{localPlayer=null;managers=null;_isMoving=!1;_bobTime=0;constructor(){w.on(y.INTENT_MOVE,this._onMove.bind(this))}setLocalPlayer(e,t){this.localPlayer=e,this.managers=t}_onMove(e){this._isMoving=e.direction.x!==0||e.direction.y!==0}update(e){if(!this.localPlayer||!this.managers||this.managers.render.isXRPresenting())return;this._bobTime+=this._isMoving?e*15:0;const i=new x(this.localPlayer.xrOrigin.position.x,this.localPlayer.xrOrigin.position.y,this.localPlayer.xrOrigin.position.z),s=new C(this.localPlayer.xrOrigin.quaternion.x,this.localPlayer.xrOrigin.quaternion.y,this.localPlayer.xrOrigin.quaternion.z,this.localPlayer.xrOrigin.quaternion.w),n=this._isMoving?Math.sin(this._bobTime)*.05:0,r=new x(0,this.localPlayer.headHeight+n,0).clone().applyQuaternion(s).add(i);this.localPlayer.headState.position={x:r.x,y:r.y,z:r.z}}}class to{constructor(e){this.context=e}update(e,t){const i=this.context.managers.entity;if(i)for(const s of i.entities.values())s.type===F.PHYSICS_PROP&&s.present(e)}}const io="modulepreload",so=function(d,e){return new URL(d,e).href},zt={},Ce=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let h=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const o=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),a=r?.nonce||r?.getAttribute("nonce");s=h(t.map(l=>{if(l=so(l,i),l in zt)return;zt[l]=!0;const c=l.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(i)for(let f=o.length-1;f>=0;f--){const g=o[f];if(g.href===l&&(!c||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${l}"]${u}`))return;const p=document.createElement("link");if(p.rel=c?"stylesheet":io,c||(p.as="script"),p.crossOrigin="",p.href=l,a&&p.setAttribute("nonce",a),document.head.appendChild(p),c)return new Promise((f,g)=>{p.addEventListener("load",f),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};class W{x=0;y=0;width=100;height=50;isVisible=!0;isHovered=!1;children=[];parent=null;backgroundColor=T.colors.panelBg;hoverColor;borderColor=T.colors.primary;borderWidth=T.styling.borderWidth;cornerRadius=T.styling.cornerRadius;layoutConfig={};constructor(e=0,t=0,i=100,s=50){this.x=e,this.y=t,this.width=i,this.height=s}addChild(e){e.parent=this,this.children.push(e)}removeChild(e){const t=this.children.indexOf(e);t!==-1&&(this.children.splice(t,1),e.parent=null)}clearChildren(){this.children.forEach(e=>e.parent=null),this.children=[]}containsPoint(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}onPointerMove(e,t){if(!this.isVisible)return!1;let i=!1;const s=this.containsPoint(e,t);if(s!==this.isHovered&&(this.isHovered=s,i=!0),s){const n=e-this.x,o=t-this.y;for(let r=this.children.length-1;r>=0;r--)this.children[r].onPointerMove(n,o)&&(i=!0)}else this.clearHoverState()&&(i=!0);return i}clearHoverState(){let e=!1;this.isHovered&&(this.isHovered=!1,e=!0);for(const t of this.children)t.clearHoverState()&&(e=!0);return e}onPointerClick(e,t){if(!this.isVisible)return!1;if(this.containsPoint(e,t)){let i=!1;const s=e-this.x,n=t-this.y;for(let o=this.children.length-1;o>=0;o--){const r=this.children[o];if(r.containsPoint(s,n)&&r.onPointerClick(s,n)){i=!0;break}}return i||this.handleClick()}return!1}handleClick(){return!1}render(e){if(this.isVisible){e.save(),e.translate(this.x,this.y),this.drawSelf(e);for(const t of this.children)t.render(e);e.restore()}}drawSelf(e){e.fillStyle=this.isHovered&&this.hoverColor?this.hoverColor:this.backgroundColor,this.cornerRadius>0?(e.beginPath(),e.roundRect(0,0,this.width,this.height,this.cornerRadius),e.fill(),this.borderWidth>0&&this.borderColor&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor,e.stroke())):(e.fillRect(0,0,this.width,this.height),this.borderWidth>0&&this.borderColor&&(e.lineWidth=this.borderWidth,e.strokeStyle=this.borderColor,e.strokeRect(0,0,this.width,this.height)))}}class ot extends W{text="";font=k(T.typography.sizes.body);textColor=T.colors.text;textAlign="left";textBaseline="middle";constructor(e,t=0,i=0,s=100,n=50){super(t,i,s,n),this.text=e,this.backgroundColor="transparent",this.hoverColor="transparent",this.borderWidth=0}drawSelf(e){this.backgroundColor!=="transparent"&&super.drawSelf(e),e.fillStyle=this.textColor,e.font=this.font,e.textAlign=this.textAlign,e.textBaseline=this.textBaseline;let t=0,i=this.height/2;this.textAlign==="center"?t=this.width/2:this.textAlign==="right"?t=this.width:t=5,e.fillText(this.text,t,i,this.width-10)}}class no extends W{text="";font=k(T.typography.sizes.body,"bold");textColor=T.colors.text;onClickCallback=null;constructor(e,t=0,i=0,s=150,n=50,o){super(t,i,s,n),this.text=e,this.onClickCallback=o||null,this.backgroundColor=T.colors.panelBg,this.hoverColor=T.colors.panelBgHover,this.borderColor=T.colors.primary,this.borderWidth=T.styling.borderWidth,this.cornerRadius=T.styling.cornerRadius}onClick(e){this.onClickCallback=e}handleClick(){return this.onClickCallback?(this.onClickCallback(),!0):!1}drawSelf(e){super.drawSelf(e),e.fillStyle=this.textColor,e.font=this.font,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,this.width/2,this.height/2,this.width-10)}}class oo extends W{tabs=[];activeTabIndex=0;tabBarHeight=80;tabBar;contentArea;constructor(e=0,t=0,i=500,s=400){super(e,t,i,s),this.backgroundColor=T.colors.background,this.borderWidth=0,this.borderColor="transparent",this.tabBar=new W(0,0,i,this.tabBarHeight),this.tabBar.backgroundColor=T.colors.panelBg,this.tabBar.borderWidth=0,this.tabBar.cornerRadius=0,super.addChild(this.tabBar),this.contentArea=new W(0,this.tabBarHeight,i,s-this.tabBarHeight),this.contentArea.backgroundColor="transparent",this.contentArea.borderWidth=0,super.addChild(this.contentArea)}addTab(e){const t=new W(0,0,this.width,this.height-this.tabBarHeight);t.backgroundColor="transparent",t.borderWidth=0,t.isVisible=this.tabs.length===0;const i=new W(0,0,100,this.tabBarHeight);i.cornerRadius=0;const s=new ot(e,0,0,100,this.tabBarHeight);s.textAlign="center",s.textBaseline="middle",i.addChild(s);const n={name:e,container:t,button:i,label:s};this.tabs.push(n),this.contentArea.addChild(t),this.tabBar.addChild(i);const o=this.tabs.length-1;return i.handleClick=()=>(this.setActiveTab(o),!0),this.updateLayout(),n}updateTabName(e,t){if(e>=0&&e<this.tabs.length){const i=this.tabs[e];i.name=t,i.label.text=t}}setActiveTab(e){e>=0&&e<this.tabs.length&&(this.activeTabIndex=e,this.updateLayout())}updateLayout(){if(this.tabs.length===0)return;const e=this.width/this.tabs.length;for(let t=0;t<this.tabs.length;t++){const i=this.tabs[t],s=t===this.activeTabIndex;i.button.x=t*e,i.button.width=e,i.button.backgroundColor=s?T.colors.panelBgHover:"transparent",i.button.hoverColor=s?T.colors.panelBgHover:"rgba(255,255,255,0.05)",i.button.borderWidth=s?T.styling.borderWidth:0,i.button.borderColor=s?T.colors.primary:"transparent",i.label.width=e,i.label.textColor=s?T.colors.text:T.colors.textMuted,i.label.font=k(T.typography.sizes.body,s?"bold":"normal"),i.container.isVisible=s}}addChild(e){console.warn("UITabPanel: Use addTab() instead of adding directly.")}}class ro{constructor(e,t){this.width=e,this.height=t,this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.context=this.canvas.getContext("2d"),this.texture=new Te(this.canvas),this.texture.minFilter=Z,this.texture.magFilter=Z,this.texture.generateMipmaps=!1,this.texture.colorSpace=ge,this.root=new W(0,0,e,t),this.root.backgroundColor="transparent",this.root.borderWidth=0}canvas;context;texture;root;isDirty=!0;needsTextureUpdate=!0;markDirty(){this.isDirty=!0}update(){this.isDirty&&(this.render(),this.isDirty=!1,this.needsTextureUpdate=!0),this.needsTextureUpdate&&(this.texture.needsUpdate=!0,this.needsTextureUpdate=!1)}render(){this.context.clearRect(0,0,this.width,this.height),this.root.render(this.context)}onPointerMove(e){const t=e.x*this.width,i=(1-e.y)*this.height;this.root.onPointerMove(t,i)&&this.markDirty()}onPointerOut(){this.root.clearHoverState()&&this.markDirty()}onPointerClick(e){const t=e.x*this.width,i=(1-e.y)*this.height,s=this.root.onPointerClick(t,i);return s&&this.markDirty(),s}onMouseMove(e,t){this.root.onPointerMove(e,t)&&this.markDirty()}onMouseClick(e,t){const i=this.root.onPointerClick(e,t);return i&&this.markDirty(),i}}class ao{id;type="TABLET";isAuthority=!0;isDestroyed=!1;ownerId=null;isGrabbable=!0;heldBy=null;mesh;ui;isRelative=!0;relativePosition=new x(0,-.3,-.5);relativeQuaternion=new C().setFromEuler(new le(-Math.PI*.1,0,0));context;position;quaternion;leftHandle;rightHandle;isRecentering=!1;hasSpawned=!1;constructor(e,t){this.context=e,this.id=t,this.position=new x,this.quaternion=new C,this.ui=new ro(1280,800),this.ui.root.backgroundColor="rgba(15, 15, 20, 0.95)",this.ui.root.cornerRadius=30,this.ui.root.borderWidth=5,this.ui.root.borderColor="#333";const i=new be(.384,.24),s=new B({map:this.ui.texture,transparent:!0,side:Se,fog:!1});this.mesh=new R(i,s),this.mesh.userData={entityId:this.id};const n=.02,o=.28,r=.02,a=new j(n,o,r),h=new G({color:65535,roughness:.2,metalness:.8});this.leftHandle=new R(a,h),this.leftHandle.position.set(-.384/2-n/2,0,0),this.leftHandle.userData={entityId:this.id},this.mesh.add(this.leftHandle),this.rightHandle=new R(a,h),this.rightHandle.position.set(.384/2+n/2,0,0),this.rightHandle.userData={entityId:this.id},this.mesh.add(this.rightHandle),this.mesh.position.copy(this.position),this.mesh.quaternion.copy(this.quaternion),this.ui.markDirty(),this.ui.update()}update(e){const t=this.context.localPlayer;if(this.isRelative&&t&&t.headState){const i=t.headState,s=this.context.managers.tracking.getState(),n=new C().setFromAxisAngle(new x(0,1,0),s.head.yaw),o=new x().copy(this.relativePosition).applyQuaternion(n).add({x:i.position.x,y:i.position.y,z:i.position.z}),r=new C().copy(n).multiply(this.relativeQuaternion);if(!this.hasSpawned){this.position.copy(o),this.quaternion.copy(r),this.mesh.position.copy(this.position),this.mesh.quaternion.copy(this.quaternion),this.mesh.updateMatrixWorld(!0),this.hasSpawned=!0,console.log("[TabletEntity] Deterministic Spawn:"),console.log(` - Head: [${i.position.x.toFixed(2)}, ${i.position.y.toFixed(2)}, ${i.position.z.toFixed(2)}]`),console.log(` - Tablet: [${this.position.x.toFixed(2)}, ${this.position.y.toFixed(2)}, ${this.position.z.toFixed(2)}]`);return}if(!this.isRecentering){const a=this.position.distanceTo(o),h=this.quaternion.angleTo(r),l=.5,c=Math.PI/4;(a>l||h>c)&&(this.isRecentering=!0,console.log("[TabletEntity] Moving to follow player..."))}if(this.isRecentering){const a=1-Math.exp(-e*6);this.position.lerp(o,a),this.quaternion.slerp(r,a),this.position.distanceTo(o)<.02&&this.quaternion.angleTo(r)<.05&&(this.isRecentering=!1)}this.mesh.position.copy(this.position),this.mesh.quaternion.copy(this.quaternion)}this.ui.update()}onHoverEnter(e){}onHoverExit(e){}onInteraction(e){}onGrab(e,t){this.heldBy=e,this.isRelative=!1}onRelease(e){if(this.heldBy=null,this.isRelative=!0,this.context.localPlayer&&"headState"in this.context.localPlayer){const t=this.context.localPlayer.headState,i=this.context.managers.tracking.getState(),n=new C().setFromAxisAngle(new x(0,1,0),i.head.yaw).clone().invert();this.relativePosition.copy(this.position).sub({x:t.position.x,y:t.position.y,z:t.position.z}).applyQuaternion(n),this.relativeQuaternion.copy(n).multiply(this.quaternion),this.isRecentering=!1}}getGrabRoots(){return[this.leftHandle,this.rightHandle]}updateGrabbedPose(e){this.position.set(e.position.x,e.position.y,e.position.z),this.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w),this.mesh.position.copy(this.position),this.mesh.quaternion.copy(this.quaternion)}setVisible(e){this.mesh.visible=e,this.isGrabbable=e,this.leftHandle.visible=e,this.rightHandle.visible=e}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.leftHandle.geometry.dispose(),this.leftHandle.material.dispose(),this.rightHandle.geometry.dispose(),this.rightHandle.material.dispose(),this.ui)}}class ho{constructor(e){this.context=e}tablet=null;tabPanel=null;overlayContainer=null;peersTab=null;roomTab=null;systemTab=null;refreshPeersList=null;peersTalkingInterval=null;onPeerUpdateHandler=null;onVoiceStateHandler=null;scheduleRenderHandler=null;onDesktopUpdateHandler=null;onDesktopResubscribeHandler=null;keyboardHandler=null;debugStatsInterval=null;init(){this.tablet=new ao(this.context,"local-tablet"),this.context.managers.render&&this.context.managers.render.scene.add(this.tablet.mesh),this.context.managers.entity&&this.context.managers.entity.addEntity(this.tablet),this.tabPanel=new oo(0,0,1280,800),this.tablet.ui.root.addChild(this.tabPanel),this.addPeersTab(),this.context.isLocalServer&&this.addRoomTab(),this.addSystemTab(),this.addDebugTab(),this.addHelpTab(),this.setupKeyboardListeners()}setupKeyboardListeners(){this.keyboardHandler&&window.removeEventListener("keydown",this.keyboardHandler),this.keyboardHandler=e=>{if(e.key.toLowerCase()==="m"){const t=this.context.managers.render;t&&!t.isXRPresenting()&&this.toggle2DMenu()}},window.addEventListener("keydown",this.keyboardHandler)}teardownPeersTabSubscriptions(){this.peersTalkingInterval&&(clearInterval(this.peersTalkingInterval),this.peersTalkingInterval=null),this.onPeerUpdateHandler&&(w.off(y.VOICE_STATE_UPDATED,this.onPeerUpdateHandler),w.off(y.PEER_STATE_UPDATED,this.onPeerUpdateHandler),w.off(y.PEER_JOINED_ROOM,this.onPeerUpdateHandler),w.off(y.PEER_DISCONNECTED,this.onPeerUpdateHandler),this.onPeerUpdateHandler=null),this.onVoiceStateHandler&&(w.off(y.VOICE_STATE_UPDATED,this.onVoiceStateHandler),this.onVoiceStateHandler=null),this.scheduleRenderHandler&&(w.off(y.ENTITY_DISCOVERED,this.scheduleRenderHandler),w.off(y.PEER_DISCONNECTED,this.scheduleRenderHandler),w.off(y.REMOTE_NAME_UPDATED,this.scheduleRenderHandler),this.scheduleRenderHandler=null),this.onDesktopUpdateHandler&&(w.off(y.DESKTOP_SCREENS_UPDATED,this.onDesktopUpdateHandler),this.onDesktopUpdateHandler=null),this.onDesktopResubscribeHandler&&(w.off(y.SESSION_CONNECTED,this.onDesktopResubscribeHandler),w.off(y.PEER_JOINED_ROOM,this.onDesktopResubscribeHandler),this.onDesktopResubscribeHandler=null)}toggle2DMenu(){this.context.isMenuOpen=!this.context.isMenuOpen,this.context.isMenuOpen?this.show2DMenu():this.hide2DMenu()}show2DMenu(){if(!this.tablet)return;if(!this.overlayContainer){this.overlayContainer=document.createElement("div"),this.overlayContainer.id="menu-2d-overlay";const t=this.tablet.ui.canvas;this.overlayContainer.appendChild(t),t.addEventListener("mousemove",i=>{const s=t.getBoundingClientRect(),n=(i.clientX-s.left)*(this.tablet.ui.width/s.width),o=(i.clientY-s.top)*(this.tablet.ui.height/s.height);this.tablet.ui.onMouseMove(n,o)}),t.addEventListener("click",i=>{const s=t.getBoundingClientRect(),n=(i.clientX-s.left)*(this.tablet.ui.width/s.width),o=(i.clientY-s.top)*(this.tablet.ui.height/s.height);this.tablet.ui.onMouseClick(n,o)})}this.tablet&&!this.overlayContainer.contains(this.tablet.ui.canvas)&&this.overlayContainer.appendChild(this.tablet.ui.canvas),document.body.appendChild(this.overlayContainer),this.tablet?.ui.markDirty(),this.tablet?.ui.update(),document.exitPointerLock?.(),this.tablet.setVisible(!1);const e=document.getElementById("desktop-controls");e&&(e.style.display="none")}hide2DMenu(){if(this.overlayContainer&&this.overlayContainer.parentElement&&this.overlayContainer.parentElement.removeChild(this.overlayContainer),this.tablet){const t=this.context.managers.render?.isXRPresenting();this.tablet.setVisible(!!t)}const e=document.getElementById("desktop-controls");e&&!this.context.managers.render?.isXRPresenting()&&(e.style.display="block")}addPeersTab(){if(!this.tabPanel)return;this.teardownPeersTabSubscriptions(),this.peersTab=this.tabPanel.addTab("Peers");const e=this.peersTab.container;let t=0;const i=4;Ce(async()=>{const{UIButton:s,UILabel:n}=await import("./index-le3Kxczb.js");return{UIButton:s,UILabel:n}},__vite__mapDeps([0,1,2,3]),import.meta.url).then(({UIButton:s,UILabel:n})=>{const o=new W(0,20,1280,80);e.addChild(o);const r=new W(0,110,1280,500);e.addChild(r);const a=new n("Page 1/1",540,640,200,60);a.font=k(T.typography.sizes.small),a.textColor=T.colors.textMuted,a.textAlign="center";const h=()=>{if(this.peersTab&&!this.peersTab.container.children.includes(r))return;r.children=[];const g=[];g.push({id:this.context.localPlayer?.id||"local",name:(this.context.playerName||"You")+" (You)",avatarColor:this.context.avatarConfig.color,isLocal:!0,audioLevel:this.context.managers.media?this.context.managers.media.getLocalVolume():0,micEnabled:this.context.voiceEnabled});for(const b of this.context.managers.entity.entities.values())if(b.type==="REMOTE_PLAYER"){const v=b;if(g.find(P=>P.id===v.id))continue;g.push({id:v.id,name:v.name||"Unknown",avatarColor:v.avatarColor,isLocal:!1,audioLevel:v.audioLevel,isMuted:v.isMuted,micEnabled:v.micEnabled,player:v,targetPos:v.targetPosition?new x(v.targetPosition.x,v.targetPosition.y,v.targetPosition.z):void 0,targetYaw:v.targetYaw})}this.peersTab&&(this.peersTab.label.text=`Peers (${g.length})`);const m=Math.max(1,Math.ceil(g.length/i));t>=m&&(t=m-1),t<0&&(t=0),a.text=`Page ${t+1}/${m}`;const S=t*i;g.slice(S,S+i).forEach((b,v)=>{const P=v*125,_=new W(50,P+20,60,60),L=b.avatarColor;_.backgroundColor=typeof L=="string"?L:"#"+L.toString(16).padStart(6,"0"),_.cornerRadius=8,r.addChild(_);const K=b.id===this.context.roomId||b.isLocal&&this.context.isHost,U=ti({name:b.name,isHost:K,micEnabled:b.micEnabled,isMuted:b.isMuted,audioLevel:b.audioLevel}),q=new n(U,140,P+20,550,60);if(q.font=k(T.typography.sizes.body,b.isLocal?"bold":"normal"),q.textColor=b.isLocal?T.colors.primary:T.colors.text,q.textAlign="left",r.addChild(q),!b.isLocal&&b.player){const V=b.player,Q=new s(b.isMuted?"Unmute":"Mute",720,P+15,200,70,()=>{V.isMuted=!V.isMuted,V.view&&V.view.setMuted&&V.view.setMuted(V.isMuted),h()});Q.backgroundColor=b.isMuted?T.colors.panelBgHover:T.colors.panelBg,Q.borderColor=b.isMuted?T.colors.secondary:T.colors.primary,Q.textColor=b.isMuted?T.colors.secondary:T.colors.text,Q.cornerRadius=8,r.addChild(Q);const Y=new s("Go To",950,P+15,200,70,()=>{const ce=this.context.localPlayer;if(ce&&ce.teleportTo&&b.targetPos&&b.targetYaw!==void 0){const Ve=new x(b.targetPos.x,b.targetPos.y,b.targetPos.z),Re=b.targetYaw,Ne=new x(0,0,1.2).applyAxisAngle(new x(0,1,0),Re),Oe=Ve.clone().add(Ne),He=Re;ce.teleportTo(Oe,He,{targetSpace:"player"}),Y.backgroundColor=T.colors.primary,setTimeout(()=>{Y.backgroundColor=T.colors.panelBgHover,this.tablet?.ui.markDirty()},200)}});Y.borderColor=T.colors.accent,Y.cornerRadius=8,r.addChild(Y)}}),this.tablet?.ui.markDirty()};this.refreshPeersList=h,this.onPeerUpdateHandler=()=>{const g=this.context.managers.render?.isXRPresenting();(this.context.isMenuOpen||g)&&h()},w.on(y.VOICE_STATE_UPDATED,this.onPeerUpdateHandler),w.on(y.PEER_STATE_UPDATED,this.onPeerUpdateHandler),w.on(y.PEER_JOINED_ROOM,this.onPeerUpdateHandler),w.on(y.PEER_DISCONNECTED,this.onPeerUpdateHandler),this.peersTalkingInterval=setInterval(()=>{const g=this.context.managers.render?.isXRPresenting();(this.context.isMenuOpen||g)&&h()},500);const l=new s("Mic: ON",240,10,380,60,()=>{const g=!this.context.voiceAutoEnable;this.context.voiceAutoEnable=g,localStorage.setItem("hangout_voiceEnabled",String(g)),this.context.managers.media.setMicrophoneEnabled(g).then(m=>{this.context.voiceEnabled=m})});l.font=k(T.typography.sizes.small,"bold"),l.cornerRadius=10,o.addChild(l);const c=()=>{l.text=this.context.voiceEnabled?"Mic: ON":"Mic: OFF",l.backgroundColor=this.context.voiceEnabled?T.colors.panelBgHover:T.colors.panelBg,l.borderColor=this.context.voiceEnabled?T.colors.primary:T.colors.textMuted,this.tablet?.ui.markDirty()};this.onVoiceStateHandler=c,w.on(y.VOICE_STATE_UPDATED,this.onVoiceStateHandler),c();const u=new s("Copy Invite Link",660,10,380,60,()=>{const g=window.location.origin+window.location.pathname+"?room="+this.context.roomId;navigator.clipboard.writeText(g).then(()=>{u.text="Copied!",this.tablet?.ui.markDirty(),setTimeout(()=>{u.text="Copy Invite Link",this.tablet?.ui.markDirty()},2e3)})});u.font=k(T.typography.sizes.small,"bold"),u.borderColor=T.colors.secondary,u.cornerRadius=10,o.addChild(u);const p=new s("< Prev",200,630,200,80,()=>{t>0&&(t--,h())}),f=new s("Next >",880,630,200,80,()=>{let g=1;for(const S of this.context.managers.entity.entities.values())S.type==="REMOTE_PLAYER"&&g++;const m=Math.max(1,Math.ceil(g/i));t<m-1&&(t++,h())});e.addChild(p),e.addChild(a),e.addChild(f),this.scheduleRenderHandler=()=>{setTimeout(h,100)},w.on(y.ENTITY_DISCOVERED,this.scheduleRenderHandler),w.on(y.PEER_DISCONNECTED,this.scheduleRenderHandler),w.on(y.REMOTE_NAME_UPDATED,this.scheduleRenderHandler),h()})}addSystemTab(){if(!this.tabPanel)return;this.systemTab=this.tabPanel.addTab("System");const e=this.systemTab.container;Ce(async()=>{const{UIButton:t,UILabel:i}=await import("./index-le3Kxczb.js");return{UIButton:t,UILabel:i}},__vite__mapDeps([0,1,2,3]),import.meta.url).then(({UIButton:t,UILabel:i})=>{const s=new i("System",50,50,1180,80);s.font=k(T.typography.sizes.title,"bold"),s.textColor=T.colors.primary,s.textAlign="center",e.addChild(s);const n=new t("Leave Room",440,630,400,80,()=>{const o=this.context.managers.render;o&&o.isXRPresenting()?o.getXRSession()?.end().then(()=>{location.reload()}).catch(()=>{location.reload()}):location.reload()});n.backgroundColor=T.colors.danger,n.borderColor=T.colors.secondary,n.textColor=T.colors.text,n.hoverColor=T.colors.dangerHover,n.cornerRadius=10,e.addChild(n)})}addRoomTab(){if(!this.tabPanel)return;this.roomTab=this.tabPanel.addTab("Room");const e=this.roomTab.container;Ce(async()=>{const{UIButton:t,UILabel:i}=await import("./index-le3Kxczb.js");return{UIButton:t,UILabel:i}},__vite__mapDeps([0,1,2,3]),import.meta.url).then(({UIButton:t,UILabel:i})=>{const s=this.context.managers.remoteDesktop,n=new i("Remote Screens",50,30,1180,70);n.font=k(T.typography.sizes.title,"bold"),n.textColor=T.colors.primary,n.textAlign="center",e.addChild(n);const o=new i("Manage your pre-configured global desktop sources",70,90,1140,40);o.font=k(T.typography.sizes.small),o.textColor=T.colors.textMuted,o.textAlign="center",e.addChild(o);const r=new t("Refresh Status",420,140,440,70,()=>{s.requestSourceStatus()});r.cornerRadius=10,e.addChild(r);const a=new W(40,240,1200,500);e.addChild(a);const h=()=>{a.children=[];const l=s.getConfigs();if(l.length===0){const c=new i("No screens configured. Add entries in the main menu profile screen.",40,20,1120,50);c.font=k(T.typography.sizes.body),c.textColor=T.colors.textMuted,c.textAlign="center",a.addChild(c),this.tablet?.ui.markDirty();return}l.slice(0,5).forEach((c,u)=>{const p=u*95,f=c.key.trim().length>0,g=s.isOnline(c.key),m=s.isActive(c.key),S=f?m?"Active":g?"Online":"Offline":"Missing Key",E=m?T.colors.accent:f?g?T.colors.primary:T.colors.textMuted:T.colors.secondary,b=new i(c.name,20,p+8,360,40);b.font=k(T.typography.sizes.body,"bold"),b.textColor=T.colors.text,b.textAlign="left",a.addChild(b);const v=new i(c.key,20,p+44,500,34);v.font=k(T.typography.sizes.small),v.textColor=T.colors.textMuted,v.textAlign="left",a.addChild(v);const P=new i(S,560,p+26,180,40);P.font=k(T.typography.sizes.small,"bold"),P.textColor=E,P.textAlign="center",a.addChild(P);const _=new t("Start",770,p+12,170,60,()=>{!f||m||s.summonStream(c.key,c.name)});_.cornerRadius=8,_.backgroundColor=f&&g&&!m?T.colors.panelBgHover:T.colors.panelBg,_.borderColor=f&&g&&!m?T.colors.primary:T.colors.textMuted,_.textColor=f&&g&&!m?T.colors.text:T.colors.textMuted,a.addChild(_);const L=new t("Stop",965,p+12,170,60,()=>{m&&s.stopStream(c.key)});L.cornerRadius=8,L.backgroundColor=m?T.colors.panelBgHover:T.colors.panelBg,L.borderColor=m?T.colors.secondary:T.colors.textMuted,L.textColor=m?T.colors.text:T.colors.textMuted,a.addChild(L)}),this.tablet?.ui.markDirty()};this.onDesktopUpdateHandler=()=>{h()},this.onDesktopResubscribeHandler=()=>{s.requestSourceStatus(),h()},w.on(y.DESKTOP_SCREENS_UPDATED,this.onDesktopUpdateHandler),w.on(y.SESSION_CONNECTED,this.onDesktopResubscribeHandler),w.on(y.PEER_JOINED_ROOM,this.onDesktopResubscribeHandler),s.requestSourceStatus(),h()})}addDebugTab(){if(!this.tabPanel)return;const t=this.tabPanel.addTab("Debug").container;Ce(async()=>{const{UIButton:i,UILabel:s,UIToggle:n}=await import("./index-le3Kxczb.js");return{UIButton:i,UILabel:s,UIToggle:n}},__vite__mapDeps([0,1,2,3]),import.meta.url).then(({UIButton:i,UILabel:s,UIToggle:n})=>{this.debugStatsInterval&&(clearInterval(this.debugStatsInterval),this.debugStatsInterval=null);const o=new s("Debug",50,30,1180,70);o.font=k(T.typography.sizes.title,"bold"),o.textColor=T.colors.primary,o.textAlign="center",t.addChild(o);const r=this.context.managers.debugRender,a=r?.getSettings(),h=new n("Enable Debug Overlay",a?.enabled??!1,90,120,620,52,g=>{r?.setEnabled(g),this.tablet?.ui.markDirty()});t.addChild(h);const l=this.context.managers.physics,c=(g,m,S,E,b)=>{const v=new s(g,90,m,540,54);v.font=k(T.typography.sizes.body,"bold"),v.textAlign="left",v.textColor=T.colors.text,t.addChild(v);const P=new s(S(),660,m,220,54);P.font=k(T.typography.sizes.body,"bold"),P.textAlign="center",P.textColor=T.colors.accent,t.addChild(P);const _=new i("-",900,m-6,120,64,()=>{E(),P.text=S(),this.tablet?.ui.markDirty()});_.cornerRadius=10,t.addChild(_);const L=new i("+",1040,m-6,120,64,()=>{b(),P.text=S(),this.tablet?.ui.markDirty()});L.cornerRadius=10,t.addChild(L)};c("Touch Lease Claim Interval",220,()=>`${l.getTouchLeaseClaimIntervalMs()} ms`,()=>l.setTouchLeaseClaimIntervalMs(l.getTouchLeaseClaimIntervalMs()-25),()=>l.setTouchLeaseClaimIntervalMs(l.getTouchLeaseClaimIntervalMs()+25)),c("Touch Lease Proximity",300,()=>`${l.getTouchLeaseProximityDistance().toFixed(2)} m`,()=>l.setTouchLeaseProximityDistance(l.getTouchLeaseProximityDistance()-.05),()=>l.setTouchLeaseProximityDistance(l.getTouchLeaseProximityDistance()+.05)),c("Release Hold Min",380,()=>`${l.getPendingReleaseMinHoldMs()} ms`,()=>l.setPendingReleaseHoldWindow(l.getPendingReleaseMinHoldMs()-20,l.getPendingReleaseMaxHoldMs()),()=>l.setPendingReleaseHoldWindow(l.getPendingReleaseMinHoldMs()+20,l.getPendingReleaseMaxHoldMs())),c("Release Hold Max",460,()=>`${l.getPendingReleaseMaxHoldMs()} ms`,()=>l.setPendingReleaseHoldWindow(l.getPendingReleaseMinHoldMs(),l.getPendingReleaseMaxHoldMs()-40),()=>l.setPendingReleaseHoldWindow(l.getPendingReleaseMinHoldMs(),l.getPendingReleaseMaxHoldMs()+40));const u=new s("Tip: Keep Min below Max for snappy throws without freeze.",90,560,1080,52);u.font=k(T.typography.sizes.small),u.textColor=T.colors.textMuted,u.textAlign="left",t.addChild(u);const p=new s("",90,620,1080,52);p.font=k(T.typography.sizes.small,"bold"),p.textColor=T.colors.accent,p.textAlign="left",t.addChild(p);const f=()=>{const g=l.getTouchQueryAverageHitsPerFrame();p.text=`Touch Query Hits/frame (avg 1s): ${g.toFixed(2)}`,this.tablet?.ui.markDirty()};f(),this.debugStatsInterval=setInterval(f,500)})}addHelpTab(){if(!this.tabPanel)return;const t=this.tabPanel.addTab("Help").container;let i="VR";Ce(()=>import("./index-le3Kxczb.js"),__vite__mapDeps([0,1,2,3]),import.meta.url).then(()=>{const s=new W(50,150,1180,600);t.addChild(s);const n=[],o=()=>{s.children=[];const a=new ot(`${i} CONTROLS`,0,0,1180,80);a.font=k(T.typography.sizes.title,"bold"),a.textColor=T.colors.primary,a.textAlign="center",s.addChild(a),this.getControlsForMode(i).forEach((l,c)=>{const u=!l.startsWith("â€¢")&&l.trim()!=="",p=new ot(l,50,100+c*45,1080,40);p.font=k(u?T.typography.sizes.body:T.typography.sizes.small,u?"bold":"normal"),p.textColor=u?T.colors.accent:T.colors.text,s.addChild(p)}),n.forEach(l=>{const c=l.text===i;l.backgroundColor=c?T.colors.panelBgHover:T.colors.panelBg,l.borderColor=c?T.colors.primary:T.colors.textMuted}),this.tablet?.ui.markDirty()};["VR","Desktop","Touch"].forEach((a,h)=>{const l=new no(a,50+h*390,40,360,80,()=>{i=a,o()});l.cornerRadius=10,l.font=k(T.typography.sizes.body,"bold"),t.addChild(l),n.push(l)}),o()})}getControlsForMode(e){switch(e){case"VR":return["â€¢ Move: Left Thumbstick","â€¢ Turn: Right Thumbstick (Snap)","â€¢ Grab/Hold: Left or Right Grip","â€¢ Use/Select: Left or Right Trigger","â€¢ Menu: Menu Button (Left Hand)","","Hand Tracking Gestures:","â€¢ Select/Click: Pinch index and thumb","â€¢ Grab/Hold: Close fist (Grasp)","â€¢ Menu: Look at left palm then flip up"];case"Desktop":return["â€¢ Move: W, A, S, D keys","â€¢ Look: Move Mouse","â€¢ Menu: M key","â€¢ Grab: Left Click","â€¢ Interact: Right Click","â€¢ Hand Active: Q (Left), E (Right)","â€¢ Reach Distance: Mouse Wheel"];case"Touch":return["â€¢ Move: Left virtual joystick","â€¢ Look: Right virtual joystick","â€¢ Menu: HUD Toggle button","â€¢ Interaction: Tap on objects","â€¢ Multi-Touch: Supports dual joystick control"]}}addTab(e,t){if(!this.tabPanel)return;const i=this.tabPanel.addTab(e);t(i.container),this.tablet?.ui.markDirty()}update(e){this.tablet&&(this.context.managers.render?.isXRPresenting()?this.tablet.setVisible(!0):this.context.isMenuOpen||this.tablet.setVisible(!1),this.tablet.update(e))}destroy(){this.teardownPeersTabSubscriptions(),this.debugStatsInterval&&(clearInterval(this.debugStatsInterval),this.debugStatsInterval=null),this.keyboardHandler&&(window.removeEventListener("keydown",this.keyboardHandler),this.keyboardHandler=null)}}const _e={fixed:new D(16723349),dynamic:new D(3800852),kinematic:new D(16738816),sleepingTint:new D(7041664)};class lo{constructor(e){this.context=e,this.root.name="DebugRenderLayer"}root=new z;visuals=new Map;syncTimer=0;syncInterval=.5;settings={enabled:!1,showColliders:!0,showAxes:!0,showAuthorityLabels:!0};init(){const e=this.context.managers.render?.scene;e&&(e.add(this.root),this.root.visible=!1)}getSettings(){return{...this.settings}}setEnabled(e){this.settings.enabled=e,this.root.visible=e}setShowColliders(e){this.settings.showColliders=e}setShowAxes(e){this.settings.showAxes=e}setShowAuthorityLabels(e){this.settings.showAuthorityLabels=e}update(e){if(!this.settings.enabled)return;this.syncTimer+=e,this.syncTimer>=this.syncInterval&&(this.syncTimer=0,this.syncVisuals());const t=this.context.managers.physics?.getDebugBodies()||[];for(const i of t){const s=this.visuals.get(i.id);s&&this.updateVisual(i,s)}}destroy(){for(const e of this.visuals.values())this.disposeVisual(e);this.visuals.clear(),this.root.parent?.remove(this.root)}syncVisuals(){const e=this.context.managers.physics?.getDebugBodies()||[],t=new Set(e.map(i=>i.id));for(const i of e)this.visuals.has(i.id)||this.visuals.set(i.id,this.createVisual(i));for(const[i,s]of this.visuals.entries())t.has(i)||(this.disposeVisual(s),this.visuals.delete(i))}createVisual(e){const t=new z;t.name=`DebugBody:${e.id}`,this.root.add(t);const i=[];for(let n=0;n<e.colliders.length;n++){const o=new J({color:_e.fixed,transparent:!0,opacity:1}),r=e.colliders[n],a=new te(this.createColliderEdges(r),o);a.name=`ColliderBounds:${n}`,t.add(a),i.push(a)}const s={root:t,colliderLines:i};if(!this.isFixed(e.rigidBody)){const n=new Fi(.2);n.name="BodyAxes",t.add(n),s.axes=n}if(e.hasNetworkState){const n=this.createLabelSprite("");n.name="AuthorityLabel",t.add(n),s.label=n,s.labelText=""}return s}updateVisual(e,t){const i=e.rigidBody.isSleeping(),s=this.getBodyColor(e.rigidBody.bodyType(),i);for(let n=0;n<t.colliderLines.length;n++){const o=t.colliderLines[n];o.visible=this.settings.showColliders;const r=o.material;r.color.copy(s),r.opacity=i?.35:1;const a=e.colliders[n];if(!a)continue;const h=a.translation(),l=a.rotation();o.position.set(h.x,h.y,h.z),o.quaternion.set(l.x,l.y,l.z,l.w),o.scale.set(1,1,1)}if(t.axes){const n=e.rigidBody.translation(),o=e.rigidBody.rotation();t.axes.visible=this.settings.showAxes,t.axes.position.set(n.x,n.y,n.z),t.axes.quaternion.set(o.x,o.y,o.z,o.w)}if(t.label){const n=e.ownerId||"host",o=e.isAuthority?"local":"remote",r=this.compactSimMode(e.simMode,e.isAuthority),a=this.compactId(e.id,14),h=this.compactId(n,12),c=`${a}
own:${h}  a:${o}
sim:${r}  ${i?"sleep":"awake"}
sb:${e.snapshotBufferSize}  seq:${e.lastTransferSeq}  qh:${e.touchQueryHits}`;t.label.visible=this.settings.showAuthorityLabels,c!==t.labelText&&(this.updateLabelSprite(t.label,c),t.labelText=c);const u=e.rigidBody.translation();t.label.position.set(u.x,u.y+.35,u.z);const p=this.context.managers.render?.camera;p&&t.label.quaternion.copy(p.quaternion)}}createLabelSprite(e){const t=new Te(this.buildLabelCanvas(e));t.minFilter=Z,t.magFilter=Z;const i=new Ui({map:t,transparent:!0,depthTest:!1,depthWrite:!1}),s=new Vi(i);return s.scale.set(.5,.24,1),s}updateLabelSprite(e,t){const i=e.material;i.map&&i.map.dispose(),i.map=new Te(this.buildLabelCanvas(t)),i.map.minFilter=Z,i.map.magFilter=Z,i.needsUpdate=!0}buildLabelCanvas(e){const t=document.createElement("canvas");t.width=384,t.height=190;const i=t.getContext("2d");return i&&(i.clearRect(0,0,t.width,t.height),i.fillStyle="rgba(4, 8, 20, 0.75)",i.fillRect(0,0,t.width,t.height),i.strokeStyle="rgba(0, 255, 255, 0.8)",i.lineWidth=3,i.strokeRect(1.5,1.5,t.width-3,t.height-3),i.fillStyle="#e5f8ff",i.font="bold 28px Inter, sans-serif",e.split(`
`).forEach((n,o)=>{i.fillText(n,14,38+o*44)})),t}getBodyColor(e,t){let i=_e.dynamic;return e===A.RigidBodyType.Fixed?i=_e.fixed:(e===A.RigidBodyType.KinematicPositionBased||e===A.RigidBodyType.KinematicVelocityBased)&&(i=_e.kinematic),t?i.clone().lerp(_e.sleepingTint,.65):i}createColliderEdges(e){const t=e.shape,i=t.type;let s;if(i===A.ShapeType.Cuboid||i===A.ShapeType.RoundCuboid){const o=t.halfExtents,r=o?.x??.05,a=o?.y??.05,h=o?.z??.05;s=new j(r*2,a*2,h*2)}else if(i===A.ShapeType.Ball){const o=t.radius??.05;s=new Je(o,10,8)}else if(i===A.ShapeType.Cylinder||i===A.ShapeType.RoundCylinder){const o=t.radius??.05,r=t.halfHeight??.05;s=new oe(o,o,r*2,12,1)}else if(i===A.ShapeType.Cone||i===A.ShapeType.RoundCone){const o=t.radius??.05,r=t.halfHeight??.05;s=new rt(o,r*2,12,1)}else if(i===A.ShapeType.Capsule){const o=t.radius??.05,r=t.halfHeight??.05;s=new Gi(o,r*2,4,8)}else s=new j(.1,.1,.1);const n=new ne(s);return s.dispose(),n}isFixed(e){return e.bodyType()===A.RigidBodyType.Fixed}compactId(e,t){if(e.length<=t)return e;const i=Math.max(3,Math.floor((t-1)/2));return`${e.slice(0,i)}~${e.slice(-i)}`}compactSimMode(e,t){return e?e==="AuthoritativeDynamic"?"auth-dyn":e==="HeldKinematic"?"held-kin":e==="PendingReleaseDynamic"?"pend-dyn":e==="ProxyKinematic"?"proxy-kin":e.toLowerCase():t?"auth":"proxy"}disposeVisual(e){for(const t of e.colliderLines)t.geometry.dispose(),t.material.dispose(),t.removeFromParent();if(e.label){const t=e.label.material;t.map?.dispose(),t.dispose(),e.label.removeFromParent()}e.axes?.removeFromParent(),e.root.removeFromParent()}}class co{constructor(e){this.context=e}features=new Map;eventSeq=0;seenEventIds=new Set;seenEventQueue=[];maxSeenEventIds=4096;registerFeature(e){this.features.set(e.featureId,e)}emitFeatureEvent(e,t,i){const s={featureId:e,eventType:t,eventId:this.nextEventId(),originPeerId:this.getLocalPeerId(),sentAt:this.nowMs(),data:i};this.applyEvent(s,null,!0);const n=this.context.managers.network;if(!n)return;if(this.context.isHost){n.broadcast(M.FEATURE_EVENT,s);return}const o=this.context.roomId;o&&n.sendData(o,M.FEATURE_EVENT,s)}handleIncomingFeatureEvent(e,t){this.context.isHost&&this.context.managers.network?.relayToOthers?.(e,M.FEATURE_EVENT,t),this.applyEvent(t,e,!1)}createSnapshotPayload(){const e=[];for(const t of this.features.values())t.captureSnapshot&&e.push({featureId:t.featureId,snapshot:t.captureSnapshot()});return{features:e}}applySnapshotPayload(e){if(!(!e||!Array.isArray(e.features)))for(const t of e.features){const i=this.features.get(t.featureId);i?.applySnapshot&&i.applySnapshot(t.snapshot)}}sendSnapshotToPeer(e){const t=this.context.managers.network;t&&t.sendData(e,M.FEATURE_SNAPSHOT,this.createSnapshotPayload())}requestSnapshotFromHost(){if(this.context.isHost)return;const e=this.context.roomId;if(!e)return;const t=this.context.managers.network;t&&t.sendData(e,M.FEATURE_SNAPSHOT_REQUEST,{})}applyEvent(e,t,i){if(!e||!e.eventId||this.hasSeen(e.eventId))return;this.markSeen(e.eventId);const s=this.features.get(e.featureId);s&&s.onEvent(e.eventType,e.data,{eventId:e.eventId,originPeerId:e.originPeerId,senderId:t,local:i,sentAt:e.sentAt})}nextEventId(){const e=this.getLocalPeerId(),t=++this.eventSeq;return`${e}:${t}:${Math.floor(this.nowMs())}`}hasSeen(e){return this.seenEventIds.has(e)}markSeen(e){for(this.seenEventIds.add(e),this.seenEventQueue.push(e);this.seenEventQueue.length>this.maxSeenEventIds;){const t=this.seenEventQueue.shift();t&&this.seenEventIds.delete(t)}}getLocalPeerId(){return this.context.localPlayer?.id||this.context.roomId||"local"}nowMs(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}}class uo{constructor(e){this.scene=e,this.positions=new Float32Array(this.capacity*3),this.colors=new Float32Array(this.capacity*3),this.sizes=new Float32Array(this.capacity),this.alphas=new Float32Array(this.capacity),this.velocities=new Float32Array(this.capacity*3),this.life=new Float32Array(this.capacity),this.maxLife=new Float32Array(this.capacity),this.active=new Uint8Array(this.capacity),this.geometry=new fe,this.geometry.setAttribute("position",new ie(this.positions,3)),this.geometry.setAttribute("color",new ie(this.colors,3)),this.geometry.setAttribute("aSize",new ie(this.sizes,1)),this.geometry.setAttribute("aAlpha",new ie(this.alphas,1)),this.geometry.setDrawRange(0,this.capacity),this.material=new $e({transparent:!0,depthWrite:!1,blending:Ki,vertexColors:!0,uniforms:{uScale:{value:310}},vertexShader:`
                attribute float aSize;
                attribute float aAlpha;
                varying vec3 vColor;
                varying float vAlpha;
                uniform float uScale;
                void main() {
                    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                    gl_Position = projectionMatrix * mvPosition;
                    gl_PointSize = max(1.0, aSize * (uScale / max(0.0001, -mvPosition.z)));
                    vColor = color;
                    vAlpha = aAlpha;
                }
            `,fragmentShader:`
                varying vec3 vColor;
                varying float vAlpha;
                void main() {
                    vec2 uv = gl_PointCoord * 2.0 - 1.0;
                    float r2 = dot(uv, uv);
                    if (r2 > 1.0) discard;
                    float falloff = exp(-2.2 * r2);
                    gl_FragColor = vec4(vColor, vAlpha * falloff);
                }
            `}),this.root=new ht(this.geometry,this.material),this.root.name="ParticlePoints",this.root.frustumCulled=!1,this.scene.add(this.root)}capacity=1200;gravity=2.3;drag=.985;defaultColor=new D(65535);root;geometry;material;positions;colors;sizes;alphas;velocities;life;maxLife;active;cursor=0;update(e){if(e<=0)return;let t=!1;for(let i=0;i<this.capacity;i++){if(this.active[i]===0)continue;if(this.life[i]-=e,this.life[i]<=0){this.active[i]=0,this.alphas[i]=0,this.sizes[i]=0,t=!0;continue}const s=i*3;this.velocities[s+1]-=this.gravity*e,this.velocities[s]*=this.drag,this.velocities[s+1]*=this.drag,this.velocities[s+2]*=this.drag,this.positions[s]+=this.velocities[s]*e,this.positions[s+1]+=this.velocities[s+1]*e,this.positions[s+2]+=this.velocities[s+2]*e;const n=this.life[i]/Math.max(1e-4,this.maxLife[i]);this.alphas[i]=Math.max(0,n),this.sizes[i]*=.91+n*.09,t=!0}t&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.aAlpha.needsUpdate=!0,this.geometry.attributes.aSize.needsUpdate=!0)}spawnBurst(e){const t=Math.max(4,Math.min(72,Math.floor(e.count??22))),i=Math.max(.12,e.speed??.8),s=Math.max(.06,e.lifetime??.2),n=Math.max(.004,e.size??.013),o=new D(e.color??this.defaultColor);let r=!1;for(let a=0;a<t;a++){const h=this.alloc();if(h<0)break;const l=h*3;this.active[h]=1,this.positions[l]=e.position.x+(Math.random()-.5)*.008,this.positions[l+1]=e.position.y+(Math.random()-.5)*.008,this.positions[l+2]=e.position.z+(Math.random()-.5)*.008;let c=Math.random()*2-1,u=Math.random()*2-1,p=Math.random()*2-1;const f=Math.hypot(c,u,p)||1;c/=f,u/=f,p/=f;const g=i*(.75+Math.random()*.55);this.velocities[l]=c*g,this.velocities[l+1]=u*g,this.velocities[l+2]=p*g,this.colors[l]=o.r,this.colors[l+1]=o.g,this.colors[l+2]=o.b;const m=s*(.75+Math.random()*.5);this.life[h]=m,this.maxLife[h]=m,this.alphas[h]=1,this.sizes[h]=n*(.75+Math.random()*.5),r=!0}r&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.attributes.aAlpha.needsUpdate=!0,this.geometry.attributes.aSize.needsUpdate=!0)}alloc(){for(let e=0;e<this.capacity;e++){const t=this.cursor;if(this.cursor=(this.cursor+1)%this.capacity,this.active[t]===0)return t}return-1}}class po{constructor(e,t){this.context=e,this.particles=t,this.context.managers.replication.registerFeature(this)}featureId="feature:social";hitDistance=.13;rearmDistance=.24;cooldownMs=650;minClosingSpeed=.18;tmpMid=new x;lastLocalHandPos={left:null,right:null};localHandSpeed={left:0,right:0};pairLastDistance=new Map;pairArmed=new Map;pairLastTriggerAt=new Map;update(e){const t=this.context.localPlayer?.id;if(!t||e<=0)return;const i=this.getLocalHandPosition("left"),s=this.getLocalHandPosition("right");if(this.updateLocalHandVelocity("left",i,e),this.updateLocalHandVelocity("right",s,e),!i&&!s)return;const n=this.context.managers.entity.entities;for(const o of n.values()){if(o.type!==F.REMOTE_PLAYER)continue;const r=o,a=r.id;if(!a||t>=a)continue;const h=this.getRemoteHandPosition(r,"left"),l=this.getRemoteHandPosition(r,"right");this.tryPair(t,a,"left","left",i,h,e),this.tryPair(t,a,"left","right",i,l,e),this.tryPair(t,a,"right","left",s,h,e),this.tryPair(t,a,"right","right",s,l,e)}}onEvent(e,t){if(e!=="highfive")return;const i=t;!i||!i.p||i.p.length<3||this.playHighFive(i)}tryPair(e,t,i,s,n,o,r){if(!n||!o)return;const a=`${t}:${i}:${s}`,h=n.distanceTo(o),l=this.pairLastDistance.get(a)??h;this.pairLastDistance.set(a,h);const c=Math.max(0,(l-h)/Math.max(1e-4,r));if(h>this.rearmDistance){this.pairArmed.set(a,!0);return}if(!(this.pairArmed.get(a)??!0)||h>this.hitDistance||c<this.minClosingSpeed)return;const p=this.nowMs(),f=this.pairLastTriggerAt.get(a)??0;if(p-f<this.cooldownMs)return;this.pairLastTriggerAt.set(a,p),this.pairArmed.set(a,!1);const g=this.localHandSpeed[i],m=Math.min(1,Math.max(.25,g*.35+c*.45));this.tmpMid.copy(n).add(o).multiplyScalar(.5);const S={a:e,b:t,ah:i,bh:s,p:[this.tmpMid.x,this.tmpMid.y,this.tmpMid.z],i:m};this.context.managers.replication.emitFeatureEvent(this.featureId,"highfive",S)}playHighFive(e){const t={x:e.p[0],y:e.p[1],z:e.p[2]};w.emit(y.SOCIAL_HIGH_FIVE,{position:t,intensity:e.i,playerA:e.a,playerB:e.b}),this.particles.spawnBurst({position:t,color:65535,count:22+Math.floor(e.i*16),speed:.24+e.i*.34,lifetime:.12+e.i*.12,size:.01+e.i*.007}),this.particles.spawnBurst({position:t,color:16723622,count:12+Math.floor(e.i*10),speed:.2+e.i*.28,lifetime:.1+e.i*.1,size:.008+e.i*.006}),this.particles.spawnBurst({position:t,color:16777215,count:6+Math.floor(e.i*5),speed:.1+e.i*.18,lifetime:.055+e.i*.045,size:.022+e.i*.014})}getLocalHandPosition(e){const t=this.context.managers.tracking.getState().hands[e];if(!t.active)return null;if(t.hasJoints){const o=t.joints[9]?.pose.position;if(o&&(o.x!==0||o.y!==0||o.z!==0))return new x(o.x,o.y,o.z)}const i=e==="left"?"leftHand":"rightHand",s=this.context.localPlayer?.humanoid.joints[i]?.position;if(s&&(s.x!==0||s.y!==0||s.z!==0))return new x(s.x,s.y,s.z);const n=t.pose.position;return n&&(n.x!==0||n.y!==0||n.z!==0)?new x(n.x,n.y,n.z):null}getRemoteHandPosition(e,t){const i=t==="left"?"leftIndexTip":"rightIndexTip",s=t==="left"?"leftHand":"rightHand",n=e.humanoid.joints[i]?.position;if(n&&(n.x!==0||n.y!==0||n.z!==0))return new x(n.x,n.y,n.z);const o=e.humanoid.joints[s]?.position;return o&&(o.x!==0||o.y!==0||o.z!==0)?new x(o.x,o.y,o.z):null}updateLocalHandVelocity(e,t,i){const s=this.lastLocalHandPos[e];if(!t){this.lastLocalHandPos[e]=null,this.localHandSpeed[e]=0;return}if(!s||i<=0){this.lastLocalHandPos[e]=t,this.localHandSpeed[e]=0;return}this.localHandSpeed[e]=t.distanceTo(s)/i,this.lastLocalHandPos[e]=t}nowMs(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}}const qt="hangout_myScreens";class fo{constructor(e){this.context=e,this.loadConfigsFromStorage()}configs=[];onlineByKey=new Map;capturingByKey=new Map;activeByKey=new Set;surfacesByKey=new Map;update(e){const t=this.context.managers.render;if(!t||!t.camera)return;const i=new x;t.camera.getWorldPosition(i);for(const s of this.surfacesByKey.values())this.activeByKey.has(s.key)&&s.isBillboard&&s.group.lookAt(i.x,s.group.position.y,i.z)}loadConfigsFromStorage(){try{const e=localStorage.getItem(qt);if(!e){this.configs=[];return}const t=JSON.parse(e);if(!Array.isArray(t)){this.configs=[];return}this.configs=t.filter(i=>!!i&&typeof i=="object").map(i=>({name:String(i.name||"").trim(),key:String(i.key||"").trim()})).filter(i=>i.name.length>0&&i.key.length>0)}catch{this.configs=[]}}getConfigs(){return[...this.configs]}setConfigs(e,t=!1){const i=e.map(s=>({name:s.name,key:s.key}));this.configs=i,localStorage.setItem(qt,JSON.stringify(i)),t||w.emit(y.DESKTOP_SCREENS_UPDATED)}requestSourceStatus(){if(!this.context.roomId)return;const e=this.configs.map(t=>t.key).filter(t=>t.length>0);this.context.managers.network.sendData(this.context.roomId,M.DESKTOP_SOURCES_STATUS_REQUEST,{keys:e})}summonStream(e,t){if(!this.context.roomId)return;if(!this.isOnline(e)){w.emit(y.SYSTEM_NOTIFICATION,`Screen key "${e}" is offline.`);return}if(this.isActive(e)){w.emit(y.SYSTEM_NOTIFICATION,`Screen "${t||e}" is already active in-room.`);return}const i={key:e,name:t,summonerName:this.context.playerName},s=this.context.localPlayer;if(s?.headState){const n=s.headState;i.anchor=[n.position.x,n.position.y,n.position.z],i.quaternion=[n.quaternion.x,n.quaternion.y,n.quaternion.z,n.quaternion.w]}this.context.managers.network.sendData(this.context.roomId,M.DESKTOP_STREAM_SUMMON,i)}stopStream(e){this.context.roomId&&this.context.managers.network.sendData(this.context.roomId,M.DESKTOP_STREAM_STOP,{key:e})}isOnline(e){return this.onlineByKey.get(e)===!0}isCapturing(e){return this.capturingByKey.get(e)===!0}isActive(e){return this.activeByKey.has(e)}handleSourcesStatus(e){const t=e.statuses||{};this.onlineByKey.clear();for(const[i,s]of Object.entries(t))this.onlineByKey.set(i,!!s);this.capturingByKey.clear();for(const i of e.capturingKeys||[])this.capturingByKey.set(i,!0);this.activeByKey.clear();for(const i of e.activeKeys||[]){this.activeByKey.add(i);const s=e.activeNames&&e.activeNames[i]||i,n=e.activeSummonerNames&&e.activeSummonerNames[i]||"Someone",o=this.ensureSurface(i,s);o.sharerName=n}for(const[i,s]of this.surfacesByKey.entries())this.activeByKey.has(i)?this.isCapturing(i)||this.drawStandby(s):this.removeSurface(i);this.refreshActiveLayouts(),w.emit(y.DESKTOP_SCREENS_UPDATED)}handleStreamSummoned(e){this.activeByKey.add(e.key);const t=this.ensureSurface(e.key,e.name||e.key);t.sharerName=e.summonedByName||"Someone",w.emit(y.DESKTOP_SCREENS_UPDATED),this.refreshActiveLayouts()}handleStreamStopped(e){this.activeByKey.delete(e.key),this.removeSurface(e.key),w.emit(y.DESKTOP_SCREENS_UPDATED),this.refreshActiveLayouts()}handleStreamOffline(e){this.activeByKey.delete(e.key),this.onlineByKey.set(e.key,!1),this.removeSurface(e.key),w.emit(y.DESKTOP_SCREENS_UPDATED),this.refreshActiveLayouts()}handleStreamFrame(e){const t=this.ensureSurface(e.key,e.name||e.key);this.capturingByKey.set(e.key,!0),this.activeByKey.add(e.key);const i=e.ts||Date.now();i<t.lastFrameTs||(t.lastFrameTs=i,e.dataUrl&&(t.decodeImage.onload=()=>{this.isCapturing(e.key)&&i>=t.lastFrameTs&&(t.ctx.drawImage(t.decodeImage,0,0,t.canvas.width,t.canvas.height),t.texture.needsUpdate=!0)},t.decodeImage.src=e.dataUrl))}handleBinaryFrame(e){const t=new DataView(e),i=t.getUint8(1),s=new TextDecoder().decode(new Uint8Array(e,2,i)),n=Number(t.getBigUint64(2+i)),o=new Uint8Array(e,2+i+8),r=this.surfacesByKey.get(s);if(!r)return;this.capturingByKey.set(s,!0),this.activeByKey.add(s);const a=new Blob([o]);createImageBitmap(a).then(h=>{if(this.isCapturing(s)&&n>=r.lastFrameTs){if(r.lastFrameTs=n,r.canvas.width!==h.width||r.canvas.height!==h.height){r.canvas.width=h.width,r.canvas.height=h.height,r.ctx=r.canvas.getContext("2d"),r.texture.dispose();const c=.9*(h.width/h.height)/1.6;r.screenMesh.scale.set(c,1,1),r.frameMesh.scale.set(c,1,1)}r.ctx.drawImage(h,0,0),this.drawIdentityOverlay(r),r.texture.needsUpdate=!0}h.close()}).catch(h=>{console.error("[RemoteDesktopManager] Async decode failed:",h)})}ensureSurface(e,t){const i=this.surfacesByKey.get(e);if(i)return i;const s=document.createElement("canvas");s.width=1280,s.height=720;const n=s.getContext("2d");if(!n)throw new Error("Canvas 2D context unavailable for remote desktop surface");const o=new Te(s);o.colorSpace=ge,o.needsUpdate=!0;const r=new Image;r.decoding="async";const a=new R(new be(1.6,.9),new B({map:o,side:Se})),h=new R(new j(1.66,.96,.03),new G({color:1118481,metalness:.2,roughness:.85}));h.position.set(0,0,-.02);const l=new z;l.name=`remote-desktop:${e}`,l.add(h),l.add(a),l.position.set(0,1.5,-2.4),this.context.managers.render.scene.add(l);const c={key:e,name:t,sharerName:"Someone",canvas:s,ctx:n,texture:o,decodeImage:r,lastFrameTs:0,isBillboard:!1,group:l,screenMesh:a,frameMesh:h};return this.drawStandby(c),this.surfacesByKey.set(e,c),this.refreshActiveLayouts(),c}refreshActiveLayouts(){const e=Array.from(this.activeByKey).sort(),t=e.length;this.context.managers.room.toggleHologram(t===0),e.forEach((i,s)=>{const n=this.surfacesByKey.get(i);if(!n)return;const o=this.context.managers.room.getDesktopLayout(s,t);n.group.position.set(o.position[0],o.position[1],o.position[2]),o.rotation&&n.group.quaternion.set(o.rotation[0],o.rotation[1],o.rotation[2],o.rotation[3]),o.scale&&n.group.scale.set(o.scale[0],o.scale[1],o.scale[2]),n.isBillboard=!!o.billboard})}drawStandby(e){const{ctx:t,canvas:i,texture:s,name:n}=e;e.lastFrameTs=Date.now(),e.decodeImage.onload=null;const o=t.createLinearGradient(0,0,0,i.height);o.addColorStop(0,"#0a0d14"),o.addColorStop(1,"#1a1f2c"),t.fillStyle=o,t.fillRect(0,0,i.width,i.height),t.strokeStyle="rgba(0, 255, 255, 0.05)",t.lineWidth=1;for(let r=0;r<i.width;r+=40)t.beginPath(),t.moveTo(r,0),t.lineTo(r,i.height),t.stroke();for(let r=0;r<i.height;r+=40)t.beginPath(),t.moveTo(0,r),t.lineTo(i.width,r),t.stroke();t.fillStyle="#00ffff",t.shadowColor="#00ffff",t.shadowBlur=15,t.textAlign="center",t.textBaseline="middle",t.font="bold 48px Outfit, sans-serif",t.fillText(n.toUpperCase(),i.width/2,i.height/2-40),t.shadowBlur=0,t.font="300 24px Outfit, sans-serif",t.fillStyle="rgba(0, 255, 255, 0.5)",t.fillText("WAITING FOR BROADCAST",i.width/2,i.height/2+30),this.drawIdentityOverlay(e),s.needsUpdate=!0}drawIdentityOverlay(e){const{ctx:t,canvas:i,sharerName:s}=e;t.save();const n=16,o=18;t.font=`bold ${o}px Outfit, sans-serif`;const r=`SHARER: ${s.toUpperCase()}`,h=t.measureText(r).width+n*2,l=o+n,c=40,u=i.height-40-l;t.fillStyle="rgba(0, 0, 0, 0.6)",t.roundRect?(t.beginPath(),t.roundRect(c,u,h,l,8),t.fill()):t.fillRect(c,u,h,l),t.fillStyle="#00ffff",t.textAlign="left",t.textBaseline="middle",t.fillText(r,c+n,u+l/2),t.restore()}removeSurface(e){const t=this.surfacesByKey.get(e);t&&(this.context.managers.render.scene.remove(t.group),t.group.traverse(i=>{const s=i;!s.geometry||!s.material||(s.geometry.dispose(),Array.isArray(s.material)?s.material.forEach(n=>n.dispose()):s.material.dispose())}),t.texture.dispose(),this.surfacesByKey.delete(e))}}class mo{engine;context;constructor(){this.context=new ji,this.engine=new Qi(this.context)}async bootstrap(){console.log("[App] Bootstrapping...");try{await this.detectServerInfo(),this.initializeManagers(),this.setupGlobalEventListeners(),await this.context.managers.physics.init(),await this.initSystems(),await this.engine.initialize(),this.engine.start(),console.log("[App] Bootstrap complete. Scene ready."),w.emit(y.SCENE_READY)}catch(e){throw console.error("[App] Fatal error during bootstrap:",e),e}}async detectServerInfo(){try{const e=await fetch("/api/server-info");e.ok&&(await e.json()).local&&(this.context.isLocalServer=!0,console.log("[App] Local server detected â€” using local PeerJS signaling."))}catch{}}initializeManagers(){this.context.setManager("entity",new Js(this.context)),this.context.setManager("replication",new co(this.context)),this.context.setManager("remoteDesktop",new fo(this.context)),this.context.setManager("ui",new Xi(this.context)),this.context.setManager("network",new Ss(this.context)),this.context.setManager("media",new $s(this.context)),this.context.setManager("render",new Us(this.context)),this.context.setManager("physics",new Fs(this.context)),this.context.setManager("player",new Xs(this.context)),this.context.setManager("input",new an(this.context)),this.context.setManager("hud",new Zs(this.context)),this.context.setManager("room",new cn(this.context)),this.context.setManager("audio",new dn(this.context)),this.context.setManager("assets",new Wn(this.context)),this.context.setManager("drawing",new Yn(this.context.managers.render.scene,this.context)),this.context.setManager("animation",new eo),this.context.setManager("interaction",new un(this.context)),this.context.setManager("vrUi",new ho(this.context)),this.context.setManager("debugRender",new lo(this.context)),this.context.setManager("particles",new uo(this.context.managers.render.scene)),this.context.setManager("social",new po(this.context,this.context.managers.particles));const e=new Xn(this.context);e.registerProvider(new Jn(this.context)),e.registerProvider(new Zn(this.context)),e.setProvider("desktop"),this.context.setManager("tracking",e)}setupGlobalEventListeners(){const e=this.context.managers,t=()=>{e.audio.resume(),window.removeEventListener("pointerdown",t),window.removeEventListener("keydown",t)};window.addEventListener("pointerdown",t),window.addEventListener("keydown",t),w.on(y.XR_SESSION_STARTED,()=>{e.tracking.setProvider("xr")}),w.on(y.XR_SESSION_ENDED,()=>{e.tracking.setProvider("desktop")}),e.render&&e.hud&&e.render.camera.add(e.hud.group),w.on(y.HOST_READY,i=>this.initPlayerOnce(i)),w.on(y.SESSION_CONNECTED,i=>{!this.context.isHost&&i&&this.initPlayerOnce(i)})}async initSystems(){const e=this.context.managers;e.render&&e.room&&e.room.init(e.render.scene),e.vrUi&&e.vrUi.init(),e.debugRender&&e.debugRender.init(),e.network&&this.engine.addSystem(e.network),e.input&&this.engine.addSystem(e.input),e.entity&&this.engine.addSystem(e.entity),e.physics&&this.engine.addSystem({update:t=>e.physics.step(t)}),this.engine.addSystem(new to(this.context)),e.room&&this.engine.addSystem(e.room),e.social&&this.engine.addSystem(e.social),e.particles&&this.engine.addSystem(e.particles),e.remoteDesktop&&this.engine.addSystem(e.remoteDesktop),e.ui&&this.engine.addSystem(e.ui),e.hud&&this.engine.addSystem(e.hud),e.vrUi&&this.engine.addSystem(e.vrUi),e.debugRender&&this.engine.addSystem(e.debugRender),e.render&&this.engine.addSystem({update:t=>{e.render.update(t,this.context.localPlayer),e.render.render()}}),e.input&&this.engine.onEndFrame(()=>e.input.clearJustPressed())}playerInitialized=!1;initPlayerOnce(e){if(this.playerInitialized||!e)return;this.playerInitialized=!0;const t=this.context.managers;t.render.switchToPlayerView(),t.player.init(e)}}const go=new mo;go.bootstrap().catch(d=>{console.error("Failed to start application:",d)});export{ro as C,W as U,T as a,ot as b,no as c,oo as d,k as g};
